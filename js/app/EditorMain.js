define(function(require,exports,module){var __filename=module.uri||"",__dirname=__filename.substring(0,__filename.lastIndexOf("/")+1),CommandParser,EditorMain,History,Memory,Mode,Modes,SetIntervalMixin,TimeLine,helpDescription,hyper,jsDump,_AdjustableColumns,_CommandLine,_FillHeight,_MessageDisplay,_OutputDisplay,_SourceEditor,_div,_input,_ref,__slice=[].slice,__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};_ref=hyper=require("hyper"),_div=_ref._div,_input=_ref._input,jsDump=require("vendor/jsDump"),_AdjustableColumns=require("./AdjustableColumns"),SetIntervalMixin=require("./SetIntervalMixin"),_SourceEditor=require("./SourceEditor"),_CommandLine=require("./CommandLine"),_FillHeight=require("./FillHeight"),_MessageDisplay=require("./MessageDisplay"),_OutputDisplay=require("./OutputDisplay"),TimeLine=require("./UniqueTimeLine"),CommandParser=require("./CommandParser"),Modes=require("./Modes"),History=require("./History"),Memory=require(window.requireNode&&window.GolemOpenFilePath?"./FileSystemMemory":"./Memory"),Mode=require("compilers/teascript/mode").Mode,helpDescription='Issue commands by typing "< " or ":"\nfollowed by space separated commands:\n\nerase / e      - Clear all results\nerase &lt;not...> - Don\'t clear results containing givens\ndump / d       - Dump generated javascript\nrun / r        - Run just the source code\ncopy / c       - Select last output (right-click to copy)\ntoggle / t     - Toggle autocompilation\nlink / l       - Create a link with current source code\nmode &lt;name>    - Switch to a different compiler\nmodes / m      - Show all available modes\ncanvas &lt;w> &lt;h> - Create a canvas given width and height\nsave &lt;name>    - Save current code locally under name\nload &lt;name>    - Load code from local storage under name\ndelete &lt;name>  - Remove code from local storage\nbrowse / b     - Show content of local storage\nhelp / h       - Show this help\n\nName with arbitrary characters (spaces) must be closed by \\\nsave Long file name.txt\\',module.exports=hyper(EditorMain=function(){function EditorMain(){}return EditorMain.prototype.getInitialState=function(){var e,t;return this.memory=new Memory,this.logId=0,this.focus={sourceEditor:"sourceEditor",commandLine:"commandLine",output:"output"},this.saved=!1,e=new Mode(!1,this),this.registerMode(e),this.fileName=this.memory.getLastOpenFileName(),{mode:e,module:this.loadSource(this.fileName),focused:this.focus.sourceEditor,timeline:new TimeLine,logs:[],message:{},sourceUpdateId:0,sourceEditorHeight:300,autosaveDelay:6e3,commands:(t=[]).concat.apply(t,[require("./commands/builtin/Help"),require("./commands/builtin/Output"),require("./commands/builtin/Runtime"),require("./commands/builtin/Files"),require("./commands/builtin/Modes"),require("./commands/builtin/Download"),require("./commands/builtin/Demos"),require("./commands/builtin/Intro")])}},EditorMain.prototype.mixins=[SetIntervalMixin],EditorMain.prototype.registerMode=function(e){var t;return t=e.prepareWorker(),t.on("ok",function(t){return function(n){var r,i,o,a;return a=n.data,i=a.result,o=a.source,console.log("source worker finished ok"),e.editor.getValue()===o?(i.errors?(console.log(i.errors),r=i.errors[0],t.handleSourceFailed(r.message||r)):t.handleSourceCompiled(i),e.updateAst(i.ast,i.errors||[])):void 0}}(this)),t.on("error",function(t){return function(n){var r,i,o,a;return a=n.data,o=a.text,i=a.source,r=a.inDependency,console.log("error in source worker",o),r||e.editor.getValue()===i?(t.handleSourceFailed(o),e.removeErrorMarkers()):void 0}}(this)),t.on("request",function(e){return function(n){var r,i;return i=n.data.moduleName,console.log("source worker requesting",i),r=e.memory.loadSource(i),r?t.call("compileModule",[r.value,i]):e.handleSourceFailed("Could not find module "+i)}}(this))},EditorMain.prototype.save=function(e){var t;return e&&(this.saved=!1),t=e||this.state.module.moduleName,this.saved?void 0:(this.saved=!0,this.memory.saveSource(t,this.refs.sourceEditor.serializedModule()),this.setState({module:this.loadSource(t)}))},EditorMain.prototype.load=function(e,t){var n;return e!==this.state.module.name&&this.save(),n=this.loadSource(e,t),n&&(this.memory.setLastOpenFileName(e),this.setState({module:n})),!!n},EditorMain.prototype.loadSource=function(e,t){var n;return n=this.memory.loadSource(e),!t||n?(n||(n={value:""}),n.moduleName=e,n):void 0},EditorMain.prototype.empty=function(){return this.state.mode.setContent("")},EditorMain.prototype.displayMessage=function(e,t){return this.setState({message:{type:e,value:t}})},EditorMain.prototype._hideMessage=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],t=this.state.message.type,__indexOf.call(e,t)>=0?this.setState({message:{}}):void 0},EditorMain.prototype.commandCompleter=function(){return this._commandCompleter||(this._commandCompleter={getCompletions:function(e){return function(t,n,r,i,o){var a,s,u,l,c;return l=CommandParser(t.getValue().slice(1)),u=l[0],a=l[1],s=null!=(c=e.commandNamed(u))?c.autocomplete:void 0,s?s(a,e.state,e,o):o(null,[])}}(this)})},EditorMain.prototype.handleSourceCompiled=function(e){var t;return t=e.js,this._hideMessage("compiler","runtime"),this.setState({compiledJs:t,sourceUpdateId:this.state.sourceUpdateId+1})},EditorMain.prototype.handleSourceFailed=function(e){return this.displayMessage("compiler","Compiler: "+e)},EditorMain.prototype.handleSourceChange=function(){return this.saved=!1},EditorMain.prototype.execute=function(code){var error,_base;try{return"function"==typeof(_base=this.state.compiler).preExecute&&_base.preExecute(this.memory),eval(code)}catch(_error){return error=_error,this.displayMessage("runtime","Runtime: "+error),error}},EditorMain.prototype._executeCommand=function(e,t){return e.execute(t,this.state,this)},EditorMain.prototype._bindCommands=function(){var e,t,n,r,i,o,a,s,u;for(t={},s=this.state.commands,r=0,o=s.length;o>r;r++)for(e=s[r],u=e.symbols,i=0,a=u.length;a>i;i++)n=u[i],t[n]=e;return this.setState({commandMap:t})},EditorMain.prototype.executeCommand=function(){var e,t,n;return n=arguments[0],e=2<=arguments.length?__slice.call(arguments,1):[],t=this.commandNamed(n),t?this._executeCommand(t,e):this.displayMessage("command","Command Line: "+n+" is not a command")},EditorMain.prototype.commandNamed=function(e){return this.state.commandMap[e]},EditorMain.prototype.handleCommandExecution=function(e,t,n,r){var i,o,a;return this._hideMessage("command","runtime"),"command"===r?(a=CommandParser(n),o=a[0],i=a[1],this.executeCommand.apply(this,[o].concat(__slice.call(i)))):this.log({source:e,moduleName:t,ast:n.ast,compiled:n.js})},EditorMain.prototype.handleCommandCompiled=function(){return this._hideMessage("command","runtime")},EditorMain.prototype.handleCommandFailed=function(e){return this.displayMessage("command","Command Line: "+e)},EditorMain.prototype.handleRemoveAll=function(){return this.executeCommand("erase")},EditorMain.prototype.handleFocus=function(e){return function(t){return function(n){return t.setState({focused:e,focusedOutputIndex:n})}}(this)},EditorMain.prototype.componentWillMount=function(){return window.addEventListener("unload",function(e){return function(){return e.save()}}(this)),this.setInterval(this.save,this.state.autosaveDelay),this._bindCommands()},EditorMain.prototype.componentDidMount=function(){return this.state.timeline.size()<10&&this._executeCommand(this.state.commandMap.help),this._executeCommand(this.state.commandMap["load-demos"]),window.log=this.logResult},EditorMain.prototype.logResult=function(e){return this.log(e)},EditorMain.prototype.log=function(e){return this.setState({logs:[["log"+this.logId++,e]].concat(this.state.logs)})},EditorMain.prototype.handleOutputDelete=function(e){return 1===this.state.logs.length&&this.handleFocus(this.focus.commandLine)(),this.setState({logs:this.state.logs.filter(function(t){var n;return n=t[0],n!==e})})},EditorMain.prototype.handleExpressionCommand=function(e,t){return this.state.mode.editor.execCommand(e,{targetEditor:t})},EditorMain.prototype.handleColumnsResize=function(){return this.refs.sourceEditor.forceResize()},EditorMain.prototype.handleHeightResize=function(e){return this.setState({sourceEditorHeight:e})},EditorMain.prototype.render=function(){var e,t,n;return n=Math.floor(window.innerWidth),e=20,t=(n-e)/2,_AdjustableColumns({leftColumnWidth:t,dividerWidth:e,onResize:this.handleColumnsResize},_FillHeight({onResize:this.handleHeightResize},_CommandLine({ref:"commandLine",worker:this.state.mode.worker,completers:[this.state.mode.completer,this.commandCompleter()],moduleName:this.state.module.moduleName,onCommandExecution:this.handleCommandExecution,onCommandCompiled:this.handleCommandCompiled,onCommandFailed:this.handleCommandFailed,onLeave:this.handleFocus(this.focus.sourceEditor),onFocus:this.handleFocus(this.focus.commandLine),onFocusOutput:this.handleFocus(this.focus.output),onRemoveAll:this.handleRemoveAll,focus:this.state.focused===this.focus.commandLine,timeline:this.state.timeline,memory:this.memory,updatedSource:this.state.sourceUpdateId}),_MessageDisplay({ref:"message",message:this.state.message}),_SourceEditor({ref:"sourceEditor",mode:this.state.mode,module:this.state.module,onChange:this.handleSourceChange,onLeave:this.handleFocus(this.focus.commandLine),onFocus:this.handleFocus(this.focus.sourceEditor),focus:this.state.focused===this.focus.sourceEditor,height:this.state.sourceEditorHeight})),"",_OutputDisplay({logs:this.state.logs,updatedSource:this.state.sourceUpdateId,worker:this.state.mode.worker,completers:[this.state.mode.completer],onCommand:this.handleExpressionCommand,focus:this.state.focused===this.focus.output,focusedOutputIndex:this.state.focusedOutputIndex,onDelete:this.handleOutputDelete,onFocusOutput:this.handleFocus(this.focus.output),onRemoveFocus:this.handleFocus(null)}))},EditorMain}()),hyper.render(document.getElementById("editor"),module.exports())});