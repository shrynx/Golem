define(function(require,exports,module){var e,t,n,r,i,o,a=module.uri||"",s=(a.substring(0,a.lastIndexOf("/")+1),{}.hasOwnProperty),u=function(e,t){function n(){this.constructor=e}for(var r in t)s.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};i=require("ace/ace"),o=require("ace/lib/oop"),n=require("ace/lib/event_emitter").EventEmitter,r=require("compilers/teascript/mode").Mode,e=require("./AdaptingWorkerClient"),module.exports=t=function(t){function r(e,t){var i;this.id=e,r.__super__.constructor.call(this,!0),this.completers=t,this.commandMode=!1,i=this.$tokenizer,this.$tokenizer={getLineTokens:function(e){return function(t,n,r,o){return":"!==t[0]?(e.commandMode&&e.enableSuper(),i.getLineTokens(t,n,r,o)):(":"!==t||e.commandMode||e.disableSuper(),{tokens:[{value:t,type:"text"}]})}}(this)},o.implement(this.$tokenizer,n)}return u(r,t),r.prototype.disableSuper=function(){return this.editor.moveCursorToPosition({row:0,column:1}),this.editor.commands.removeCommands(this.commands),this.commandMode=!0},r.prototype.enableSuper=function(){return this.addCommands(),this.commandMode=!1},r.prototype.resetEditing=function(){return this.commandMode?(this.editor.setValue(""),this.enableSuper()):void 0},r.prototype.createWorker=function(){},r.prototype.registerWithWorker=function(t){return this.worker=new e(t,this.id),this.worker.attachToDocument(this.editor.session.getDocument()),this.worker},r.prototype.updateWorker=function(e){return this.worker.$sendDeltaQueue(),this.worker.call("setValue",[this.editor.session.getDocument().getValue()]),this.worker.call("onUpdate",[e])},r.prototype.addCommands=function(){return r.__super__.addCommands.apply(this,arguments),this.editor.commands.addCommands({insertstring:{multiSelectAction:"forEach",scrollIntoView:"cursor",autocomplete:!0,exec:function(e){return function(t,n){return e.isInCommandMode()||e.isEmpty()&&":"===n?(e.editor.insert(n),!0):e.insertStringForward(n)}}(this)},"initial space inserts colon":{bindKey:{win:"Space",mac:"Space"},exec:function(e){return function(){return e.isEmpty()?e.editor.commands.exec("insertstring",e.editor,":"):e.editor.commands.exec("add new sibling expression",e.editor)}}(this)}})},r.prototype.doAutocomplete=function(e){if(!this.isInCommandMode()){if(this.isEmpty())return;return r.__super__.doAutocomplete.apply(this,arguments)}return(null!=e?e.command.autocomplete:void 0)&&" "===this.getValue().slice(-1)&&!this.isAutocompleting()?this.openAutocomplete():void 0},r.prototype.handleEnter=function(){return this.isAutocompleting()?this.editor.completer.insertMatch():void 0},r.prototype.isInCommandMode=function(){return":"===this.getValue()[0]},r.prototype.isEmpty=function(){return""===this.getValue()},r.prototype.getValue=function(){return this.editor.getValue()},r}(r)});