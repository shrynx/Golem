define(function(require,exports,module){var e,t,r,n,o,i,s=module.uri||"",a=(s.substring(0,s.lastIndexOf("/")+1),{}.hasOwnProperty),d=function(e,t){function r(){this.constructor=e}for(var n in t)a.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};o=require("ace/ace"),i=require("ace/lib/oop"),r=require("ace/lib/event_emitter").EventEmitter,n=require("compilers/teascript/mode").Mode,e=require("./AdaptingWorkerClient"),module.exports=t=function(t){function n(e,t){var o;this.id=e,n.__super__.constructor.call(this,!0),this.completers=t,this.commandMode=!1,o=this.$tokenizer,this.$tokenizer={getLineTokens:function(e){return function(t,r,n,i){return":"!==t[0]?(e.commandMode&&e.enableSuper(),o.getLineTokens(t,r,n,i)):(":"!==t||e.commandMode||e.disableSuper(),{tokens:[{value:t,type:"text"}]})}}(this)},i.implement(this.$tokenizer,r)}return d(n,t),n.prototype.disableSuper=function(){return this.editor.moveCursorToPosition({row:0,column:1}),this.editor.commands.removeCommands(this.commands),this.commandMode=!0},n.prototype.enableSuper=function(){return this.addCommands(),this.commandMode=!1},n.prototype.resetEditing=function(){return this.commandMode?(this.editor.setValue(""),this.enableSuper()):void 0},n.prototype.createWorker=function(){},n.prototype.registerWithWorker=function(t){return this.worker=new e(t,this.id),this.worker.attachToDocument(this.editor.session.getDocument()),this.worker},n.prototype.updateWorker=function(e){return this.worker.$sendDeltaQueue(),this.worker.call("setValue",[this.editor.session.getDocument().getValue()]),this.worker.call("onUpdate",[e])},n.prototype.addCommands=function(){return n.__super__.addCommands.apply(this,arguments),this.editor.commands.addCommands({insertstring:{multiSelectAction:"forEach",scrollIntoView:"cursor",autocomplete:!0,exec:function(e){return function(t,r){return e.isInCommandMode()||e.isEmpty()&&":"===r?(e.editor.insert(r),!0):e.insertStringForward(r)}}(this)},"initial space inserts colon":{bindKey:{win:"Space",mac:"Space"},exec:function(e){return function(){return e.isEmpty()?e.editor.commands.exec("insertstring",e.editor,":"):e.editor.commands.exec("add new sibling expression",e.editor)}}(this)}})},n.prototype.doAutocomplete=function(e){if(!this.isInCommandMode()){if(this.isEmpty())return;return n.__super__.doAutocomplete.apply(this,arguments)}return(null!=e?e.command.autocomplete:void 0)&&" "===this.getValue().slice(-1)&&!this.isAutocompleting()?this.openAutocomplete():void 0},n.prototype.handleEnter=function(){return this.isAutocompleting()?this.editor.completer.insertMatch():void 0},n.prototype.isInCommandMode=function(){return":"===this.getValue()[0]},n.prototype.isEmpty=function(){return""===this.getValue()},n.prototype.getValue=function(){return this.editor.getValue()},n}(n)});