define(function(require,exports,module){var e,t,n,r,i,o,s,a,l,c,u,h=module.uri||"",d=(h.substring(0,h.lastIndexOf("/")+1),function(e,t){return function(){return e.apply(t,arguments)}}),p={}.hasOwnProperty,f=function(e,t){function n(){this.constructor=e}for(var r in t)p.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};n=require("ace/worker/mirror").Mirror,c=window.require("ace/lib/oop"),e=require("ace/lib/event_emitter").EventEmitter,s=require("./compiler"),window.addEventListener=function(){},exports.Worker=function(e){function t(e){this.compile=d(this.compile,this),t.__super__.constructor.call(this,e),this.setTimeout(20),this.compiler=s}return f(t,e),t.prototype.setModuleName=function(e){this.moduleName=e},t.prototype.compileModule=function(e,t){return this._compile(e,t,!1)},t.prototype.onUpdate=function(){return this.compile()},t.prototype.compile=function(){var e;return e=this.doc.getValue(),this._compile(e,this.moduleName,!0)},t.prototype._compile=function(e,t,n){var r,i,a;console.log("worker: compiling "+t+", current: "+n);try{return a=o(s.compileTopLevel,e,t),a.request?(i=this.sender.on("ok",function(r){return function(o){return o.moduleName===a.request?(r.sender.off("ok",i),r._compile(e,t,n)):void 0}}(this)),this.sender.emit("request",{moduleName:a.request})):(this.sender.emit("ok",{result:a,source:e}),this.sender._emit("ok",{moduleName:t}))}catch(l){return r=l,console.log(r.stack),this.sender.emit("error",{text:r.message,type:"error",source:e,inDependency:!n})}},t.prototype.matchingDefinitions=function(e,t){var n;return n=s.findMatchingDefinitions(this.moduleName,e),this.sender.callback(n,t)},t.prototype.availableTypes=function(e,t){var n;return n=s.findAvailableTypes(this.moduleName,e),this.sender.callback(n,t)},t.prototype.docsFor=function(e,t){var n;return n=s.findDocsFor(this.moduleName,e),this.sender.callback(n,t)},t.prototype.expand=function(e,t){var n;return n=s.expand(this.moduleName,e),this.sender.callback(n,t)},t.prototype.compileBuild=function(e,t){var n;return n=s.compileModule(e),this.sender.callback(n,t)},t}(n),a=function(e){var t,n,r;return r=void 0,t=!0,n=function(e,n){return function(){return t=!0,e?void 0:n()}},function(i,o){var s;return null==o&&(o=!1),null!=r&&clearTimeout(r),s=t||o,s&&i(),r=setTimeout(n(s,i),e),t=!1}},t=function(e){function t(e){t.__super__.constructor.call(this,e)}return f(t,e),t.prototype.onUpdate=function(e){var t,n;if(n=this.doc.getValue(),":"===n[0]){if(e)return this.sender.emit("ok",{result:n.slice(1),commandSource:n,type:"command"})}else try{return console.log("expression worker compiling",this.moduleName),this.sender.emit("ok",{type:e?"execute":"normal",commandSource:n,result:this.compiler.compileExpression(n,this.moduleName)})}catch(r){t=r,console.log(t.stack),this.sender.emit("error",{text:t.message,type:"error",commandSource:n})}},t}(exports.Worker),i={},o=function(e,t,n){var r,o,s;return(null!=(s=r=i[n])?s.source:void 0)===t&&r?(console.log(""+n+" was cached."),r.result):(o=e(t,n),o.request||(i[n]={source:t,result:o}),o)},r=function(){function t(t){this.id=t,c.implement(this,e)}return t.prototype.callback=function(e,t){return postMessage({type:"call",identifier:this.id,id:t,data:e})},t.prototype.emit=function(e,t){return postMessage({type:"event",identifier:this.id,name:e,data:t})},t}(),u={},l=window.onmessage,window.onmessage=function(e){var n,i,o,s,a;if(o=e.data,i=window.main,s=window.sender,n=o.identifier,!s||!n)return l(e);if((a=u[n])||(a=u[n]=new t(new r(n))),o.command){if(a[o.command])return a[o.command].apply(a,o.args);throw new Error("Unknown command:"+o.command)}return o.event?a.sender._signal(o.event,o.data):void 0}});