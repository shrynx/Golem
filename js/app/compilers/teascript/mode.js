define(function(require,exports,module){var e,t,n,i,r,o,s,a,l,c,u,h,d,p,f,m,g,v,y,w,b,C,E,A,x,S,F,_,k,T,D,M,R,L,B,$,O,N,I,P,j,W,H,U,z,K,q,V,G,Y,X,J,Q,Z,et,tt,nt,it,rt,ot,st,at,lt,ct,ut,ht,dt,pt,ft,mt,gt,vt,yt,wt,bt,Ct,Et,At,xt,St,Ft,_t,kt,Tt,Dt,Mt,Rt,Lt,Bt,$t,Ot,Nt,It,Pt,jt,Wt,Ht,Ut,zt,Kt,qt,Vt,Gt,Yt,Xt,Jt,Qt,Zt,en,tn,nn,rn,on,sn,an,ln,cn,un,hn,dn,pn,fn,mn,gn,vn,yn,wn,bn,Cn,En,An,xn,Sn,Fn,_n,kn,Tn,Dn,Mn,Rn,Ln,Bn,$n,On,Nn,In,Pn,jn,Wn,Hn,Un,zn,Kn,qn,Vn,Gn,Yn,Xn,Jn,Qn,Zn,ei,ti,ni,ii,ri,oi,si,ai,li,ci,ui,hi,di,pi,fi,mi,gi,vi,yi,wi,bi,Ci,Ei,Ai=module.uri||"",xi=(Ai.substring(0,Ai.lastIndexOf("/")+1),function(e,t){return function(){return e.apply(t,arguments)}}),Si={}.hasOwnProperty,Fi=function(e,t){function n(){this.constructor=e}for(var i in t)Si.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},_i=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},ki=[].slice;v=require("ace/ace"),f=require("ace/range").Range,g=require("ace/mode/text").Mode,t=require("ace/mode/behaviour").Behaviour,m=require("ace/selection").Selection,pn=require("ace/lib/oop"),a=require("ace/lib/event_emitter").EventEmitter,u=require("ace/keyboard/hash_handler").HashHandler,i=require("./CustomAutocomplete"),r=require("./CustomSearchBox"),n=require("./CombinedTooltip"),s=require("app/DistributingWorkerClient"),tn=function(e){return console.log(e),e},vi=I=require("./compiler"),Lt=vi.isForm,_t=vi.isCall,Ut=vi.isNotCapital,P=vi.concat,nn=vi.map,j=vi.concatMap,li=vi.zipWith,si=vi.unzip,nt=vi.filter,Qt=vi.join,y=vi.all,ci=vi.__,Hn=vi.sortedArgs,mn=vi.originOf,pi=vi._is,mi=vi._notEmpty,hi=vi._empty,gi=vi._operator,ui=vi._arguments,bi=vi._terms,Ei=vi._validTerms,yi=vi._snd,di=vi._fst,fi=vi._labelName,wi=vi._symbol,D=vi.call_,ri=vi.token_,function(){var e,t;return e=this.fromOrientedRange,this.fromOrientedRange=function(t){return e.call(this,t),this.$nodes=t.$nodes,this.$editing=t.$editing,this.$editMarker=t.$editMarker},t=this.toOrientedRange,this.toOrientedRange=function(e){return e=t.call(this,e),e.$nodes=this.$nodes,e.$editing=this.$editing,e.$editMarker=this.$editMarker,e}}.call(m.prototype),exports.Mode=function(t){function m(e,t){this.isSingleLineInput=e,this.editorInstance=t,this.handleRangeDeselect=xi(this.handleRangeDeselect,this),this.handleCommandExecution=xi(this.handleCommandExecution,this),this.replay=xi(this.replay,this),this.removeMultiSelectKeyboardHandler=xi(this.removeMultiSelectKeyboardHandler,this),this.addMultiSelectKeyboardHandler=xi(this.addMultiSelectKeyboardHandler,this),this.createMultiSelectKeyboardHandler=xi(this.createMultiSelectKeyboardHandler,this),this.handlePaste=xi(this.handlePaste,this),this.handleCopy=xi(this.handleCopy,this),this.handleClick=xi(this.handleClick,this),this.handleMouseUp=xi(this.handleMouseUp,this),this.handleMouseDown=xi(this.handleMouseDown,this),this.detach=xi(this.detach,this),this.closeTooltip=xi(this.closeTooltip,this),this.docsTooltip=xi(this.docsTooltip,this),this.createCompleter=xi(this.createCompleter,this),this.tokensOnLine=xi(this.tokensOnLine,this),this.$tokenizer={getLineTokens:function(e){return function(t,n,i,r){var o;return null==r&&(r=e.editor.session.getDocument()),(o=e.tokensOnLine(i,r))?{tokens:H(o)}:{tokens:[{value:t,type:"text"}]}}}(this)},pn.implement(this.$tokenizer,a),this.$behaviour=void 0,this.completers=[this.completer=this.createCompleter()]}var g,v,y;return Fi(m,t),m.prototype.tokensOnLine=function(e,t){var n,i;return i=t.positionToIndex({row:e,column:0}),n=t.positionToIndex({row:e+1,column:0}),this.ast?ct(oi(this.ast),i,n):void 0},m.prototype.getTokenAt=function(e){var t,n,i;return i=this.tokensSurroundingPos(e),n=i[0],t=i[1],t&&Rt(t)?t:n||t},m.prototype.getNextLineIndent=function(e,t,n){var i,r,o;return i=this.$getIndent(t),o=(t.match(/[\(\[\{]/g)||[]).length,r=(t.match(/[\)\]\}]/g)||[]).length,new Array(o-r+i.length/n.length+1).join(n)},g=/^(\s*)# ?/,v=/^\s*###(?!#)/,y=/^\s*/,m.prototype.toggleCommentLines=function(e,t,n,i){var r,o,s,a;for(s=new f(0,0,0,0),r=a=n;i>=n?i>=a:a>=i;r=i>=n?++a:--a)o=t.getLine(r),v.test(o)||(o=g.test(o)?o.replace(g,"$1"):o.replace(y,"$&# "),s.end.row=s.start.row=r,s.end.column=o.length+2,t.replace(s,o))},m.prototype.detachFromSession=function(){return this.editor.removeListener("mousedown",this.handleMouseDown),this.editor.removeListener("mouseup",this.handleMouseUp),this.editor.tokenTooltip.destroy(),this.editor.onPaste=this.__editorOnPaste,this.editor.getCopyText=this.__editorCopyText,this.editor.setOption("dragEnabled",!0),this.editor.setOption("enableBlockSelect",!0)},m.prototype.attachToEditor=function(e){var t;return t=e.session,this.editor=e,this.editor.completers=this.completers,this.editor.session.setUndoManager(this.createUndoManager()),e.setOption("dragEnabled",!1),e.setOption("enableBlockSelect",!1),this.editor.on("mousedown",this.handleMouseDown),this.editor.on("mouseup",this.handleMouseUp),this.editor.tokenTooltip=new n(this.editor),this.editor.tokenTooltip.setTooltipContentForToken=this.docsTooltip,this.__editorOnPaste=this.editor.onPaste,this.editor.onPaste=this.handlePaste,this.__editorCopyText=this.editor.getCopyText,this.editor.getCopyText=this.handleCopy,this.editor.selection.on("removeRange",this.handleRangeDeselect),this.editor.commands.on("afterExec",this.handleCommandExecution),this.createMultiSelectKeyboardHandler(),t.multiSelect.on("multiSelect",this.addMultiSelectKeyboardHandler),t.multiSelect.on("singleSelect",this.removeMultiSelectKeyboardHandler),this.editor.on("blur",this.detach),this.isSingleLineInput||this.addVerticalCommands(t),this.addCommands(t),this.initAst("")},m.prototype.setContent=function(e,t,n){var i,r,o;try{return null!=n&&this.reportModuleName(n),i=x(e,this.ast),o=At(this.ast),this.mutate(et({changeInTree:{added:i,at:o}},t?{selectionRange:t}:{tangibleSelection:{"in":i,out:o.out}})),this.handleCommandExecution()}catch(s){return r=s,console.error(r,r.stack),console.error(e),this.editor.insert(e)}},m.prototype.selectInitially=function(e){return this.initialSelection=e},m.prototype.tangibleSelectionFromRange=function(e){var t,n,i,r;return i=this.tangibleAtPos(e.start),t=this.tangibleAtPos(e.end),mi(i["in"])?(n=R(i["in"][0]),r=R(t.out[0]),{"in":bn(i).slice(n,r),out:t.out}):t},m.prototype.initAst=function(e){return this.ast=this.isSingleLineInput?I.astizeExpressionWithWrapper(e):I.astizeList(e),""===e?this.mutate({tangibleSelection:At(this.ast)}):void 0},m.prototype.updateAst=function(e,t){var n;return null==t&&(t=[]),q(e,this.ast),this.$tokenizer._signal("update",{data:{rows:{first:1}}}),(hi(t)||!this.isAutocompleting())&&this.updateAutocomplete(),this.addErrorMarkers(t),(n=this.initialSelection)?(this.initialSelection=null,this.mutate({inSelection:at(n.name,this.ast)})):void 0},m.prototype.repositionAst=function(){var e,t,n,i,r,o,s,a;for(e=this.ast.start,s=[[this.ast,!0]],a=[];n=s.pop();)i=n[0],o=n[1],Lt(i)?o?(i.start=e,s.push([i,!1]),a.push(function(){var e,n;for(n=[],e=i.length-1;e>=0;e+=-1)t=i[e],n.push(s.push([t,!0]));return n}())):a.push(i.end=e):(r=e-i.start,i.start=e,i.end+=r,a.push(e=i.end));return a},m.prototype.addErrorMarkers=function(e){var t,n,i,r,o,s,a,l;return this.removeErrorMarkers(),this.errorMarkers=[],n=e[0],n&&(r=n.message,t=n.conflicts,r)?(this.errorMarkers=function(){var e,n,r;for(r=[],i=e=0,n=t.length;n>e;i=++e)l=t[i],l&&(s=mn(l))&&(a=Ci(s),o=lt(this.ast,a.start,a.end)[0],r.push({node:o}));return r}.call(this),this.updateErrorMarkers()):void 0},m.prototype.updateErrorMarkers=function(){var e,t,n,i,r,o,s,a;for(this.removeErrorMarkers(),s=this.errorMarkers||[],a=[],r=0,o=s.length;o>r;r++)t=s[r],t.node&&(n=t.node,i=this.nodeRange(n),e=this.errorMarkerRange(i),a.push(t.id=this.editor.session.addMarker(e,"clazz",this.showError(i,e,n.tea),!0)));return a},m.prototype.removeErrorMarkers=function(){var e,t,n,i,r;for(i=this.errorMarkers||[],r=[],t=0,n=i.length;n>t;t++)e=i[t].id,e&&r.push(this.editor.session.removeMarker(e));return r},m.prototype.showError=function(e,t,n){var i;return i=function(){return function(n,i,r,o,s,a){var l;return l=e.isMultiLine()?" golem_error-origin-open":"",a.drawSingleLineMarker(n,t,"golem_error-origin"+l,s)}}(this),i.type=n,i},m.prototype.errorMarkerRange=function(e){var t;return e.isMultiLine()?(t=e.start.row,new f(t,e.start.column,t,this.editor.session.getScreenLastRowColumn(t))):e},m.prototype.doAutocomplete=function(e){var t,n,i,r;return n=this.editor,i=["Up","Down","Ctrl-Up|Ctrl-Home","Ctrl-Down|Ctrl-End","PageUp","PageDown"],(null!=e?e.command.autocomplete:void 0)&&((t=this.editedAtom())&&!Ot(t)&&!zt(t)&&this.offsetToCursor(t)===t.symbol.length||this.isInserting())?this.openAutocomplete():n.completer&&(r=null!=e?e.command.name:void 0,_i.call(i,r)<0||t&&zt(t))?n.completer.detach():void 0},m.prototype.openAutocomplete=function(){var e;return e=this.editor,!this.isAutocompleting()||this.isInserting()?(e.completer||(e.completer=new i(!this.isSingleLineInput)),this.closeTooltip(),e.completer.showPopup(e)):void 0},m.prototype.updateAutocomplete=function(){var e;return this.isAutocompleting()?this.editor.completer.updateCompletions():this.editor.isFocused()&&(this.isInserting()||(e=this.onlySelectedExpression())&&!e.tea)?this.openAutocomplete():void 0},m.prototype.isAutocompleting=function(){return this.editor.completer&&this.editor.completer.activated},m.prototype.createCompleter=function(){var e;return e={getCompletions:function(t){return function(n,i,r,o,s){var a,l,c,u,h,d;if(!(o&&(null!=(h=n.completer.completions)?h.filtered.length:void 0)>0))return c=i.getMode(),c.isEditing()?(u=c.editedAtom(),a=u.symbol):u=ni(c.selectedTangible()),!u.tea||u.tea.ForAll||(null!=(d=u.assignable)?d.top:0)?u.inferredType?t.worker.call("availableTypes",[u.inferredType],function(t){var n,i,r;return s(null,function(){var o,s;s=[];for(i in t)o=t[i],r=o.type,n=o.docs,s.push({name:r,value:r,completer:e,docs:n});return s}())}):void s("error",[]):(l={type:u.tea,scope:u.scope,pattern:u.assignable,emptyCall:Mt(u.parent)},t.worker.call("matchingDefinitions",[l],function(t){var n,i,r,o,a,l;return s(null,function(){var s,c;c=[];for(a in t)s=t[a],l=s.type,o=s.score,r=s.rawType,n=s.arity,i=s.docs,c.push({name:a,value:a,completer:e,score:o,meta:l,rawType:r,arity:n,docs:i});return c}())}))}}(this),getDocTooltip:function(e){return function(t){t.rawType&&!t.docHTML&&(t.docHTML=e.createDocTooltipHtml(t))}}(this),insertMatch:function(){return function(e,t){var n,i,r;return r=t.value,n=e.session.getMode(),n.startGroupMutation(),n.removeSelected(),n.insertStringForward(r),Lt(i=n.onlySelectedExpression())&&n.mutate({tangibleSelection:ft(c,i)}),n.finishGroupMutation()}}(this)}},m.prototype.docsTooltip=function(e,t){var n,i,r,o,s;return n=function(e){return function(n){return t.setHtml(n),t.open(),e.activeTooltip=t}}(this),t.hideAndRemoveMarker(),(i=e.malformed)||Tt(e)&&(i=e.parent.malformed)?n(i):null!=e.scope?(r={name:e.symbol,scope:e.scope},this.worker.call("docsFor",[r],function(t){return function(i){return null!=i?n("name"===e.label&&i.rawType?t.prettyPrintTypeForDoc(i):t.createDocTooltipHtml(i)):void 0}}(this))):(o=(null!=(s=e.type)?s.type:void 0)||e.tea)?n(this.prettyPrintTypeForDoc({rawType:o})):void 0},m.prototype.lookupSource=function(e,t){var n;return n={name:e.symbol,scope:e.scope},this.worker.call("docsFor",[n],function(){return function(e){var n,i,r,o,s;return o=e.source,Bt(o)&&(s=bi(o),n=s[0],i=s[1],r=3<=s.length?ki.call(s,2):[],o=D(n,Qt([i],nt($t,r)))),t(Q(o))}}(this))},m.prototype.closeTooltip=function(){return this.detach()},m.prototype.detach=function(){var e;return null!=(e=this.activeTooltip)?e.hideAndRemoveMarker():void 0},m.prototype.createDocTooltipHtml=function(e){var t;return"<span style='color: #9EE062'>"+e.name+"</span>"+(e.arity?(t=e.arity||[]," <span style='color: #9C49B6'>"+t.join(" ")+"</span>"):"")+"\n"+(e.rawType?""+this.prettyPrintTypeForDoc(e)+"\n":"")+(e.docs?I.labelDocs(e.docs,t):"")},m.prototype.prettyPrintTypeForDoc=function(e){var t;return t=e.rawType,I.prettyPrint(t)},m.prototype.handleMouseDown=function(){return this.mouseDownTime=+new Date},m.prototype.handleMouseUp=function(e){return e.duration=new Date-this.mouseDownTime,e.preventDefault(),this.handleClick(e)},m.prototype.handleClick=function(e){var t;return t=200,e.duration>t?this.editor.execCommand("edit by click"):e.domEvent.shiftKey?this.editor.execCommand("expand selection by click"):this.ast?this.editor.execCommand("select by click"):void 0},m.prototype.handleCopy=function(){var e,t;return t=this.editor.getSelectedText(),e=K(ni(this.selectedTangible())),e>0?t.replace(new RegExp("\\n"+Array(2*e+1).join(" "),"g"),"\n"):t},m.prototype.handlePaste=function(e){var t,n;return t=e.split(/(?:\r\n|\r|\n)(?!\s)/),n=this.editor.selection.rangeList.ranges,t.length>n.length||t.length<2||!t[1]?this.editor.commands.exec("insertstring",this.editor,e):(this.startGroupMutation(),this.editor.forEachSelection({exec:function(e){return function(){return e.insertStringForward(t[e.editor.selection.index])}}(this)}),this.finishGroupMutation(),this.handleCommandExecution({command:{name:"paste"}}))},m.prototype.undoManager=function(){var e;return e=this.editor.session.getUndoManager()},m.prototype.createUndoManager=function(){return new o(this)},m.prototype.addVerticalCommands=function(){return this.editor.commands.addCommands({"move up to atom or position":{bindKey:{win:"Up",mac:"Up"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectLineAdjecentAtomOrPosition(p)}}(this)},"move down to atom or position":{bindKey:{win:"Down",mac:"Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectLineAdjecentAtomOrPosition(d)}}(this)},"add a new sibling expression on the next line":{bindKey:{win:"Enter",mac:"Enter"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.replaceSpace(c,"\n")}}(this)},"add a new sibling expression on the previous line":{bindKey:{win:"Shift-Enter",mac:"Shift-Enter"},multiSelectAction:"forEach",exec:function(t){return function(){return t.replaceSpace(e,"\n")}}(this)},"select the next reference of selection":{bindKey:{win:"Tab",mac:"Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(e){return function(){return e.selectReferenceInDirection(c)}}(this)},"select the previous reference of selection":{bindKey:{win:"Shift-Tab",mac:"Shift-Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(t){return function(){return t.selectReferenceInDirection(e)}}(this)}})},m.prototype.createMultiSelectKeyboardHandler=function(){return this.multiSelectKeyboardHandler=new u([{name:"escape multi select",bindKey:"esc",scrollIntoView:"cursor",readonly:!0,exec:function(e){return function(){var t,n,i;return n=e.editor.selection,i=n.ranges,t=i[i.length-1],n.toSingleRange(t)}}(this),isAvailable:function(e){return function(){return e.isMultiSelecting()}}(this)}])},m.prototype.addMultiSelectKeyboardHandler=function(){return this.editor.keyBinding.addKeyboardHandler(this.multiSelectKeyboardHandler)},m.prototype.removeMultiSelectKeyboardHandler=function(){return this.editor.keyBinding.removeKeyboardHandler(this.multiSelectKeyboardHandler)},m.prototype.addCommands=function(){return this.editor.commands.addCommands({insertstring:{multiSelectAction:"forEach",scrollIntoView:"cursor",autocomplete:!0,exec:function(e){return function(t,n){return e.insertStringForward(n)}}(this)}}),this.editor.commands.addCommands(this.commands={ignoretheseshortcuts:{bindKey:{win:"Ctrl-Shift-E",mac:"Ctrl-Shift-E|Command-G|Command-Shift-G|Ctrl-G|Ctrl-Shift-G|Command-Shift-Up|Shift-Up|Shift-Down|Ctrl-N|Option-Shift-Left|Option-Shift-Right|Command-Shift-Left|Command-Shift-Right|Ctrl-B|Ctrl-V|Command-Option-E|Command-Shift-E|Command-D|Command-Shift-D duplicateSelection|Command-Alt-S|Command-/|Command-Shift-/|Command-Option-Up|Command-Option-Down|Command-Delete|Ctrl-H|Alt-Delete|Alt-Backspace|Ctrl-Alt-Backspace|Ctrl-[|Ctrl-]|Ctrl-Shift-U|Command-Shift-L|Ctrl-Alt-Up|Ctrl-Alt-Down|Ctrl-Alt-Shift-Up|Ctrl-Alt-Shift-Down|Ctrl-Alt-Left|Ctrl-Alt-Right|Ctrl-Alt-Shift-Left|Ctrl-Alt-Shift-Right|Ctrl-Alt-L|Ctrl-Alt-A|Ctrl-Alt-G"},exec:function(){return function(){}}(this)},"select by click":{autocomplete:!0,exec:function(e){return function(){return e.mutate({tangibleSelection:e.tangibleAtPos(e.cursorPosition())})}}(this)},"edit by click":{multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t,n;return n=e.tangibleAtPos(e.cursorPosition()),t=dn(n),e.mutate(t&&xt(t)?{withinAtom:t,withinAtomPos:e.offsetToCursor(t)}:{tangibleSelection:n})}}(this)},"expand selection by click":{multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i;return i=In([e.selectedTangible(),e.tangibleAtPos(e.cursorPosition())]),t=i[0],n=i[1],e.mutate({tangibleSelection:Kn(t,n)})}}(this)},cut:{scrollIntoView:"cursor",multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t;return t=e.editor.getSelectionRange(),e.editor._emit("cut",t),e.remove(c)}}(this)},find:{bindKey:{win:"Ctrl-Shift-F",mac:"Command-F"},readOnly:!0,exec:function(e){return function(){return e.isSingleLineInput?void 0:r.Search(e.editor)}}(this)},selectall:{bindKey:{win:"Ctrl-A",mac:"Command-A"},readOnly:!0,exec:function(e){return function(){return e.mutate({tangibleSelection:At(e.ast)})}}(this)},"select enclosing expression":{bindKey:{win:"Ctrl-Up",mac:"Command-Up"},multiSelectAction:"forEach",exec:function(e){return function(){return e.mutate({inSelection:e.isEditing()?e.editedAtom():e.realParentOfSelected()})}}(this)},"select the first expression inside selection":{bindKey:{win:"Ctrl-Down",mac:"Command-Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveDown(l,h)}}(this)},"select the last expression inside selection":{bindKey:{win:"Ctrl-Shift-Down",mac:"Command-Shift-Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveDown(h,l)}}(this)},"move to next atom or position":{bindKey:{win:"Right",mac:"Right"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectFollowingAtomOrPosition(d)}}(this)},"move to previous atom or position":{bindKey:{win:"Left",mac:"Left"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectFollowingAtomOrPosition(p)}}(this)},"select next sibling expression":{bindKey:{win:"Ctrl-Right",mac:"Command-Right"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectSibling(d)}}(this)},"select previous sibling expression":{bindKey:{win:"Ctrl-Left",mac:"Command-Left"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectSibling(p)}}(this)},"include next expression in selection":{bindKey:{win:"Shift-Right",mac:"Shift-Right"},multiSelectAction:"forEach",exec:function(e){return function(){return e.expandSelection(d)}}(this)},"include previous expression in selection":{bindKey:{win:"Shift-Left",mac:"Shift-Left"},multiSelectAction:"forEach",exec:function(e){return function(){return e.expandSelection(p)}}(this)},"add new sibling expression":{bindKey:{win:"Space",mac:"Space"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertSpace(c," ")}}(this)},"add new sibling expression before current":{bindKey:{win:"Shift-Space",mac:"Shift-Space"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.insertSpace(e," ")}}(this)},removeback:{bindKey:{win:"Backspace",mac:"Backspace"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.remove(e)}}(this)},removeforward:{bindKey:{win:"Delete",mac:"Delete|Shift-Delete|Ctrl-Backspace|Shift-Backspace"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.remove(c)}}(this)},"flatten onto a single line":{bindKey:{win:"Ctrl-Space",mac:"Ctrl-Space"},multiSelectAction:"forEach",exec:function(e){return function(){return e.removeNewLines()}}(this)},"jump to next occurence of the selection":{bindKey:{win:"Ctrl-Tab",mac:"Alt-Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(e){return function(){return e.selectOccurenceInDirection(c)}}(this)},"jump to previous occurence of the selection":{bindKey:{win:"Ctrl-Shift-Tab",mac:"Alt-Shift-Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(t){return function(){return t.selectOccurenceInDirection(e)}}(this)},"multiselect next reference":{bindKey:{win:"Ctrl-S",mac:"Ctrl-S"},scrollIntoView:"center",exec:function(e){return function(){return e.multiSelectReferenceInDirection(c)}}(this)},"multiselect previous reference":{bindKey:{win:"Ctrl-Shift-S",mac:"Ctrl-Shift-S"},scrollIntoView:"center",exec:function(t){return function(){return t.multiSelectReferenceInDirection(e)}}(this)},"shift expression backward":{bindKey:{win:"Alt-Left",mac:"Alt-Left"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.moveSelection(e)}}(this)},"shift expression forward":{bindKey:{win:"Alt-Right",mac:"Alt-Right"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveSelection(c)}}(this)},"shift all expressions on a line up":{bindKey:{win:"Alt-Up",mac:"Alt-Up"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.moveSelectionByLine(e)}}(this)},"shift all expressions on a line down":{bindKey:{win:"Alt-Down",mac:"Alt-Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveSelectionByLine(c)}}(this)},"insert a character":{bindKey:{win:"\\",mac:"\\"},multiSelectAction:"forEach",exec:function(e){return function(){return e.insertStringForward(e.isEditingHalfDelimited()?"\\":"\\_")}}(this)},"wrap in a call":{bindKey:{win:"Ctrl-Shift-9",mac:"Command-Shift-9"},logicalKey:{win:"Ctrl-(",mac:"Command-("},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.wrap("(",{insert:!0}," ",{selected:!0},")")}}(this)},"wrap in parentheses":{bindKey:{win:"(",mac:"("},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertOpeningDelim("(",")")}}(this)},"wrap in brackets":{bindKey:{win:"[",mac:"["},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertOpeningDelim("[","]")}}(this)},"wrap in braces":{bindKey:{win:"{",mac:"{"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertOpeningDelim("{","}")}}(this)},"insert or surround by quotes":{bindKey:{win:'"',mac:'"'},multiSelectAction:"forEach",exec:function(e){return function(){var t,n;return e.isEditingHalfDelimited()?"string"===(t=e.editedAtom()).label&&e.isAtLimit(c,t)?e.mutate({inSelection:t}):e.insertStringForward('"'):(n=Z('"',e.selectedText()),t=x('"'+n+'"',e.parentOfSelected())[0],e.mutate(et({changeInTree:{added:[t],at:e.selectedTangible()}},e.isSelecting()?{inSelection:t}:{withinAtom:t,withinAtomPos:n.length+1})))}}(this)},"select enclosing form or insert )":{bindKey:{win:")",mac:")"},multiSelectAction:"forEach",exec:function(e){return function(){return e.closeParentOrInsert(")")}}(this)},"select enclosing form or insert }":{bindKey:{win:"}",mac:"}"},multiSelectAction:"forEach",exec:function(e){return function(){return e.closeParentOrInsert("}")}}(this)},"select enclosing form or insert ]":{bindKey:{win:"]",mac:"]"},multiSelectAction:"forEach",exec:function(e){return function(){return e.closeParentOrInsert("]")}}(this)},"increment a number":{bindKey:{win:"Ctrl-Shift-Up",mac:"Alt-Shift-Up"},multiSelectAction:"forEach",exec:function(e){return function(){return e.changeNumerical(1)}}(this)},"decrement a number":{bindKey:{win:"Ctrl-Shift-Down",mac:"Alt-Shift-Down"},multiSelectAction:"forEach",exec:function(e){return function(){return e.changeNumerical(-1)}}(this)},"select enclosing definition":{bindKey:{win:"Ctrl-Shift-0",mac:"Command-Shift-0"},logicalKey:{win:"Ctrl-)",mac:"Command-)"},multiSelectAction:"forEach",exec:function(e){return function(){return e.mutate({inSelection:z(ln(l,e.selectedTangible()))})}}(this)},addlabel:{bindKey:{win:":",mac:":"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t,n,i,r;return e.isSingleLineInput&&""===e.editor.getValue()?!1:e.isEditingHalfDelimited()?e.insertStringForward(":"):(t=e.onlySelectedExpression(),e.mutate(e.isEditing()||t&&xt(t)?(n=t.symbol.length,{changeWithinAtom:{string:":",atom:t,range:[n,n]}}):(r=x(":",e.parentOfSelected()),i=r[0],r,{changeInTree:{added:[i],at:e.selectedTangible()},withinAtom:i,withinAtomPos:0})))}}(this)},"insert a comment":{bindKey:{win:"#",mac:"#"},multiSelectAction:"forEach",exec:function(e){return function(){return e.isEditingHalfDelimited()?e.insertStringForward("#"):e.wrap("(","#"," ",{selected:!0,select:!0},")")}}(this)},"go to definition":{bindKey:{win:"Ctrl-E",mac:"Ctrl-E"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i,r,o,s,a,l;if(n=function(t){return e.editorInstance.executeCommand("load",t)},o=e.onlySelectedExpression(),o&&xt(t=o)){if(null!=t.id){for(r=ot(t)(e.ast),l=[],s=0,a=r.length;a>s;s++)if(i=r[s],jt(i)){i.imported?(e.selectInitially({name:i.imported.name}),n(i.imported.module)):e.mutate({inSelection:i});break}return l}if("module"===t.label)return e.editorInstance.executeCommand("load",t.symbol)}}}(this)},"insert call-site type":{bindKey:{win:"Ctrl-T",mac:"Ctrl-T"},indirect:!0,autocomplete:!0,exec:function(e){return function(t,n){var i,r,o,s,a;return r=(null!=n?n:{}).targetEditor,r&&(o=r.session.getMode(),i=o.onlySelectedExpression(),i&&i.tea)?(s=I.plainPrettyPrint(i.tea),a=s.replace(/_\d+/,""),e.startGroupMutation(),e.insertStringForward("(: "+a+")"),e.mutate({tangibleSelection:gt(c,di(ui(e.onlySelectedExpression())))}),e.finishGroupMutation()):void 0}}(this)},"show type of an expression":{bindKey:{win:"Ctrl-Shift-T",mac:"Ctrl-Shift-T"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n;if(n=e.selectedTangible(),t=dn(n)||tt(n)){if(t.malformed)return window.log(t.malformed);if(t.tea)return window.log(I.prettyPrint(t.tea))}}}(this)},"remove all source":{bindKey:{win:"Ctrl-Shift-Backspace",mac:"Ctrl-Shift-Backspace"},document:!1,exec:function(e){return function(){return e.editor.setValue(""),e.initAst("")}}(this)},"replace enclosing Parent expression with current selection":{bindKey:{win:"Ctrl-P",mac:"Ctrl-P"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i,r;return r=e.realParentOfSelected(),r?(t=e.selectedTangible(),i=Mn(t,r.parent),n=Ct([r]),e.mutate({changeInTree:{added:i,at:n},inSelections:mi(i)?i:void 0,tangibleSelection:hi(i)?gn(n.out):void 0})):void 0}}(this)},"wrap current selection in a Function":{bindKey:{win:"Ctrl-F",mac:"Ctrl-F"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t;return t=!Xt(e.selectedTangible())||e.isSingleLineInput?[" "]:["\n","  "],e.isInserting()?e.wrap.apply(e,["(","fn"," ",["[",{insert:!0},"]"]].concat(ki.call(t),[{selected:!0}],[")"])):e.wrap("(","fn"," ","[]"," ",{selected:!0,select:!0},")")}}(this)},"Match on current selection":{bindKey:{win:"Ctrl-M",mac:"Ctrl-M"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.isInserting()?e.wrap("(","match"," ",{selected:!0,insert:!0},"\n","  "," ",")"):e.wrap("(","match"," ",{selected:!0},"\n","  ",{insert:!0}," ",")")}}(this)},"wrap in a Match to return current selection":{bindKey:{win:"Ctrl-Shift-M",mac:"Ctrl-Shift-M"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.wrap("(","match"," ",{insert:!0},"\n","  "," ",{selected:!0},")")}}(this)},"replace selection with an Added function parameter":{bindKey:{win:"Ctrl-Shift-A",mac:"Ctrl-A"},exec:function(e){return function(){var t,n,i,r;return r=In(e.selectedTangiblesList())[0],r&&(n=dt(ni(r))),n&&(i=ht(n)),i?(t=gn(i.slice(-1)),e.mutate(et(mi(bi(i))?{changeInTree:{added:x(" ",i),at:t}}:{},{newSelections:[t]}))):void 0}}(this)},"select all occurences of selection to Rename":{bindKey:{win:"Ctrl-R",mac:"Ctrl-R"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i,r;return i=e.onlySelectedExpression(),i&&xt(t=i)?(n=ut(t)(e.ast),r=nn(ii,n),e.mutate({inSelection:t,newSelections:r})):void 0}}(this)},"Define selected token":{bindKey:{win:"Ctrl-D",mac:"Ctrl-D"},indirect:!0,exec:function(e){return function(t,n){var i,r,o,s,a,l,u,d,p,f,m,g,v,y,w,b,E;return w=(null!=n?n:{}).targetEditor,null==w&&(w=e.editor),b=w.session.getMode(),m=b.onlySelectedExpression(),m&&xt(r=m)&&r.malformed?(e.startGroupMutation(),w!==e.editor?e.insertStringForward(qt(r)?(i=A(r.parent),""+r.symbol+" (fn ["+i.join(" ")+"]\n  )"):""+r.symbol+" "):(E=C(m),l=ln(h,ii(E)),y=wn(E)?"\n":"\n\n",e.insertSpaceAt(c,y,l),e.insertStringForward(qt(r)?(i=A(r.parent),""+r.symbol+" (fn ["+i.join(" ")+"]\n  )"):""+r.symbol+" ")),s=o=e.selectableEdge(h),qt(r)&&(s=Gn(h,ni(o))),e.mutate({tangibleSelection:s}),e.finishGroupMutation()):m?w!==e.editor?(a=Mn(ii(m),e.parentOfSelected()),e.startGroupMutation(),d=T(e.selectedTangible()),e.insertSpace(c," "),e.mutate({changeInTree:{added:a,at:e.selectedTangible()},tangibleSelection:d()}),e.finishGroupMutation()):(E=C(m),l=ln(h,ii(E)),a=Mn(e.selectedTangible(),E.parent),y=wn(E)?"\n":"\n\n",e.startGroupMutation(),v=e.selectedTangiblesList(),p=function(){var e,t,n;for(n=[],e=0,t=v.length;t>e;e++)g=v[e],this.mutate(this.removeSelectable(g)),n.push(T(this.selectedTangible()));return n}.call(e),e.insertSpaceAt(c,y,l),u=T(e.selectedTangible()),e.insertSpaceAt(c," ",l),f=Cn(p),e.mutate({changeInTree:{added:a,at:{"in":[],out:[l]}},tangibleSelection:f[0],newSelections:Qt(f.slice(1),[u()])}),e.finishGroupMutation()):void 0}}(this)},"Inline selected expression or replace a name by its definition":{bindKey:{win:"Ctrl-I",mac:"Ctrl-I"},multiSelectAction:"forEach",exec:function(t){return function(){var n,i,r,o,s,a,l,u,h,d,p,f,m,g,v,y,w,b,C,E,A,x,S,F,_,k,T,D;if(E=t.onlySelectedExpression(),E&&xt(r=E)){if(!jt(r))return Pt(r)?t.worker.call("expand",[r.parent],function(e){var n;return e?(n=Tn([Q(e)],r.parent.parent),t.mutate({changeInTree:{added:n,at:ii(r.parent)},inSelections:n})):void 0}):t.lookupSource(r,function(e){var n;return n=Tn([e],r.parent),t.mutate({changeInTree:{added:n,at:t.selectedTangible()},inSelections:n})});if(m=ut(r)(t.ast),t.startGroupMutation(),(v=wn(r))&&(l=wn(v))&&qt(l)&&Bt(l)&&ht(l)===v?(i=Hn(nn(wi,Ei(v)),l.parent),g=bi(v).indexOf(r),g<i.length&&i[g]&&(d=ii(i[g]),t.mutate({changeInTree:{at:ei(d)}}),t.mutate({changeInTree:{at:ei(ii(r))}}))):(s=Pn(c,r))&&Rt(s)&&(d=ii(s),t.mutate(t.removeSelectable(Kn(ii(r),d))),t.mutate(t.remove(e)),t.isInserting()&&t.mutate(t.remove(e))),d){for(u=S=0,k=m.length;k>S;u=++S)f=m[u],h=Mn(d,f.parent),t.mutate({changeInTree:{added:h,at:ii(f)}}),t.mutate(0===u?{inSelections:h}:{newSelections:[Ct(h)]});return t.finishGroupMutation()}}else if(E&&Ft(w=E)||wn(E)&&Ft(w=wn(E))){for(a=gi(w),y=Ei(ht(a)),i=ui(w),t.startGroupMutation(),u=F=0,T=i.length;T>F;u=++F)if(n=i[u],u<y.length)for(x=ut(y[u])(w),_=0,D=x.length;D>_;_++)A=x[_],h=Mn(ii(n),A.parent),t.mutate({changeInTree:{added:h,at:ii(A)}});return i.length===y.length?(o=bi(a)[2],b=Mn(ii(o),w.parent),t.mutate({changeInTree:{added:b,at:ii(w)},inSelections:b})):(p=Math.min(i.length,y.length),t.mutate({changeInTree:{at:Zn(Kn(ii(y[0]),ii(y[p-1])))}}),t.mutate({changeInTree:{at:Zn(Kn(ii(i[0]),ii(i[p-1])))}}),i.length<y.length&&(C=Mn(ii(a),w.parent),t.mutate({changeInTree:{added:C,at:ii(w)},inSelections:C}))),t.finishGroupMutation()}}}(this)},"abstract an operator with a Lambda":{bindKey:{win:"Ctrl-L",mac:"Ctrl-L"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i,r,o;if(t=function(t,n){var i,r,o,s,a,l;return i=n.join(" "),a=x("(fn ["+i+"] ( "+i+"))",t[0].parent),e.startGroupMutation(),e.mutate({changeInTree:{added:a,at:Ct(t)},inSelections:a}),l=bi(a[0]),o=l[0],s=l[1],r=l[2],e.mutate({changeInTree:{added:Tn(t,r),at:gn([r[1]])}}),e.finishGroupMutation()
},_t(r=e.parentOfSelected())){if(qt(ni(o=e.selectedTangible())))return i=o["in"],n=A(r).slice(Ei(i).length-1),t(i,n);if((i=e.onlySelectedExpression())&&xt(i))return e.worker.call("docsFor",[k(i)],function(e){return e.arity?(n=e.arity,t([i],n)):void 0})}}}(this)},"push a lambda inside of a call to the Outer expression":{bindKey:{win:"Ctrl-O",mac:"Ctrl-O"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i,r,o,s,a;return(n=e.onlySelectedExpression())&&Bt(n)&&qt(n)&&(t=wn(n.parent))?(e.startGroupMutation(),a=Tn([st(n)],t),e.mutate({changeInTree:{added:a,at:ii(n.parent)}}),s=Tn([n.parent],t.parent),i=s[0],r=gi(i),e.mutate({changeInTree:{added:s,at:ii(t)}}),o=Tn([t],i),e.mutate({changeInTree:{added:o,at:ii(st(r))},inSelection:r}),e.finishGroupMutation()):void 0}}(this)},"push definition Up":{bindKey:{win:"Ctrl-U",mac:"Ctrl-U"},multiSelectAction:"forEach",exec:function(t){return function(){var n,i;return i=t.selectedTangible(),(n=function(r){var o,s,a,l,u,d,p,f,m,g,v,y,w;return v=C(r),s=jt(v)?Rt(o=Pn(c,v))?Kn(ii(v),ii(o)):void 0:jt(u=Pn(e,v))?Kn(ii(u),ii(v)):void 0,s&&wn(v)?(p=C(v.parent),l=ln(h,ii(p)),y=rn(i),m=y[0],f=y[1],w=Rn(s,p.parent,m),a=w[0],d=w[1],g=wn(p)?"\n":"\n\n",t.startGroupMutation(),t.mutate(t.removeSelectable(s)),t.isInserting()&&t.mutate(t.remove(e)),t.insertSpaceAt(c,g,l),t.mutate({changeInTree:{added:a,at:{"in":[],out:[l]}},memorableSelection:[f,d]}),t.finishGroupMutation()):n(wn(r))})(ni(t.selectedTangible()))}}(this)}})},m.prototype.multiSelectReferenceInDirection=function(e){var t,n,i;return i=this.onlySelectedExpression(),i&&xt(t=i)&&null!=t.id?(n=ot(t)(this.ast),this.mutate({newSelections:[ii(it(e,t,n))]})):this.multiSelectOccurenceInDirection(e)},m.prototype.multiSelectOccurenceInDirection=function(e){var t,n;return this.isInserting()?void 0:(n=this.selectedTangible()["in"],t=rt(n)(this.ast),this.mutate({newSelections:[Ct(it(e,n,t))]}))},m.prototype.selectReferenceInDirection=function(e){var t,n,i;return i=this.onlySelectedExpression(),i&&xt(t=i)&&null!=t.id?(n=ot(t)(this.ast),this.mutate({inSelection:it(e,t,n)})):this.selectOccurenceInDirection(e)},m.prototype.selectOccurenceInDirection=function(e){var t,n;return this.isInserting()?void 0:(n=this.selectedTangible()["in"],t=rt(n)(this.ast),this.mutate({inSelections:it(e,n,t)}))},m.prototype.moveDown=function(e,t){var n;return this.mutate(this.isSelectingMultiple()?{tangibleSelection:this.selectableEdge(e)}:(n=this.onlySelectedExpression())?Lt(n)?{tangibleSelection:Gn(e,n)}:{withinAtom:n,withinAtomPos:X(t,n)}:{})},m.prototype.changeNumerical=function(e){var t,n,i,r,o;return(t=this.onlySelectedExpression())&&zt(t)?(o=this.offsetToCursor(t),i=M(t.symbol,o,e),n=x(i,t.parent)[0],r=this.isEditing(),this.mutate({changeInTree:{added:[n],at:this.selectedTangible()},inSelection:r?void 0:n,withinAtom:r?n:void 0,withinAtomPos:r?n.symbol.length-(t.symbol.length-o):void 0})):void 0},m.prototype.closeParentOrInsert=function(e){return this.isEditingHalfDelimited()?this.insertStringForward(e):this.mutate({inSelection:this.realParentOfSelected()})},m.prototype.insertOpeningDelim=function(e,t){return this.isEditingHalfDelimited()?this.insertStringForward(e):this.wrap(e,{selected:!0,select:!0},t)},m.prototype.wrap=function(){var e,t,n,i,r;return r=1<=arguments.length?ki.call(arguments,0):[],n=function(e){return"string"==typeof e},e=function(t){var i,r,o,s,a,l,c,u,h,d,p,f,m;for(h={},l=0,o=d=0,f=t.length;f>d;o=++d)if(u=t[o],!n(u))if(Array.isArray(u)){a=e(u);for(s in a)for(r=a[s],p=0,m=r.length;m>p;p++)i=r[p],c={},(null!=h[s]?h[s]:h[s]=[]).push({parent:o-l,child:i})}else{for(s in u)(null!=h[s]?h[s]:h[s]=[]).push(o-l);l++}return h},i=e(r),t=function(e){var i,r;return Array.isArray(e)?function(){var n,o,s;for(s=[],n=0,o=e.length;o>n;n++)r=e[n],(i=t(r))&&s.push(i);return s}().join(""):n(e)?e:void 0},this.wrapIn(t(r),this.selectedTangible(),i)},m.prototype.wrapIn=function(e,t,n){var i,r,o,s,a,l,c,u;if(a=n.selected,s=n.select,o=n.insert,null==a)throw new Error("missing selected in wrapIn");return u=x(e,bn(t))[0],r=0===t["in"].length,i=function(e,t){return e.parent?i(e.child,t[e.parent]):t[e]},this.startGroupMutation(),this.mutate({changeInTree:{added:[u],at:t}}),c=Mn(t,u),l=Qt(s||[],o||[]),this.mutate({changeInTree:{added:c,at:{"in":[],out:[i(a[0],u)]}},inSelections:s&&!r?c:void 0,tangibleSelection:!s||r?{"in":[],out:[i(l[0],u)]}:void 0,newSelections:nn(function(e){return{"in":[],out:[i(e,u)]}},l.slice(1))}),this.finishGroupMutation()},m.prototype.removeNewLines=function(){var e,t,n,i;return i=this.selectedTangible(),t=i["in"],e=function(t){var n,i,r,o;for(o=[],i=0,r=t.length;r>i;i++)n=t[i],Nt(n)||o.push(Wt(n)?x(" ",n.parent)[0]:Lt(n)?en(e(n)):B(n));return o},n=e(t),this.mutate({changeInTree:{added:n,at:i},inSelections:n})},m.prototype.moveSelectionByLine=function(e){var t,n,i,r;return i=this.selectedTangible(),r=Ct(this.allOnLine(ni(i))),(t=$n(e,G(e,vn(e,r))))?(n=Ct(this.allOnLine(t)),this.swap(e,r,n)):void 0},m.prototype.allOnLine=function(e){var t,n,i,r;return n=function(e){return function(t){var n;return n=e.rangeOfNodes([t]),n.start.row===n.end.row}}(this),t=function(e){return Rt(e)||Yt(e)},r=function(n){var i,r,o;for(i=e,o=[];(r=$n(n,i))&&t(r);)o.push(i=r);return o},(i=wn(e))&&n(i)?this.allOnLine(i):P([r(l).reverse(),t(e)?[e]:[],r(h)])},m.prototype.moveSelection=function(e){var t,n,i;if(this.isEditing()){if(t=this.editedAtom(),!this.isAtLimit(e,t))return this.mutate({withinAtom:t,withinAtomPos:this.offsetToCursor(t)+e})}else if(i=this.selectedTangible(),n=this.selectedSibling(e))return this.swap(e,i,n)},m.prototype.swap=function(e,t,n){var i,r,o;return r=O(t["in"]),i=O(n["in"]),this.startGroupMutation(),this.mutate({changeInTree:{added:[],at:t}}),this.mutate({changeInTree:{added:i,at:{"in":[],out:t.out}}}),this.mutate({changeInTree:{added:[],at:n}}),o={"in":[],out:n.out},this.mutate({changeInTree:{added:r,at:o},inSelections:mi(r)?r:void 0,tangibleSelection:hi(r)?o:void 0}),this.finishGroupMutation()},m.prototype.insertStringForward=function(e){return this.insertString(c,e)},m.prototype.insertString=function(e,t){var n,i,r,o,s;if(null==t)throw"Missing string in insertString";return this.mutate(this.isEditing()?(i=this.editedAtom(),s=Dt(i)?(r=F(i),Z(r,t)):t,o=this.offsetToCursor(i),{changeWithinAtom:{string:s,range:"char"===i.label&&"\\_"===i.symbol?[1,2]:[o,o]}}):(n=x(t,this.parentOfSelected()),et({changeInTree:{added:n,at:this.selectedTangible()}},1===n.length&&xt(i=n[0])?{withinAtom:i,withinAtomPos:i.symbol.length}:{inSelections:n})))},m.prototype.insertSpace=function(e,t){return this.isEditing()&&Dt(this.editedAtom())?this.insertString(e,t):this.insertSpaceAt(e,t,this.selectedNodeEdge(e))},m.prototype.replaceSpace=function(e,t){var n,i,r;return r=this.toSelectionSibling(e),n=r.margin,i=r.siblingTangible,n&&Yt(G(fn(e),n["in"]))?this.mutate({changeInTree:{added:x(t,bn(n)),at:n},tangibleSelection:i}):this.insertSpace(e,t)},m.prototype.insertSpaceAt=function(e,t,n){var i,r;return r=n.parent,i=x(t,r),this.mutate({changeInTree:{added:i,at:{"in":[],out:[n]}},tangibleSelection:{"in":[],out:e===c?[n]:i}})},m.prototype.selectLineAdjecentAtomOrPosition=function(e){var t,n,i,r,o,s,a,c,u,h,d;return a=this.startPos(u=ni(this.selectedTangible())),n=null!=(d=this.editor.selection.$desiredColumn)?d:a.column,c=a.row+e,t=this.tangibleAtPos({row:c,column:n+1}),h=Lt(i=ni(t))?(o=this.startPos(i),r=this.edgeOfNode(e,i),s=r.row===c&&o.column>n?l:Ht(u,i)?e:fn(e),ti(Zt(s,ni(t)))):t,this.mutate({tangibleSelection:h,desiredColumn:n})},m.prototype.selectFollowingAtomOrPosition=function(e){return this.isSelectingMultiple()?this.selectSibling(e):this.mutate({tangibleSelection:yt(e,this.selectedTangible())})},m.prototype.selectSibling=function(e){var t;return this.mutate(this.isSelectingMultiple()?{tangibleSelection:this.selectableEdge(e)}:(t=this.selectedSibling(e),!t&&Gt(this.parentOfSelected())?{inSelection:this.parentOfSelected()}:{tangibleSelection:t}))},m.prototype.expandSelection=function(e){var t,n,i,r;return r=this.toSelectionSibling(e),t=r.margin,n=r.siblingTangible,this.mutate(n?(i=E(e,t,n),{tangibleSelection:E(e,this.selectedTangible(),i)}):{inSelection:this.realParentOfSelected()})},m.prototype.tangibleAtPos=function(e){var t,n,i,r;return r=this.tokensSurroundingPos(e),n=r[0],t=r[1],i=Jn(c,n,t||n)},m.prototype.tokenFollowingPos=function(e){var t,n,i;return i=this.tokensSurroundingPos(e),n=i[0],t=i[1],t||n},m.prototype.tokensSurroundingPos=function(e){var t;return t=this.trimmedPosToIdx(e),ct(this.ast,t-1,t+1)},m.prototype.tangibleRange=function(e){var t,n,i;return i=cn(e),n=i[0],t=i[1],En(this.startPos(n),this.startPos(t))},m.prototype.remove=function(e){var t,n,i,r,o,s,a,u,d,f;return this.mutate((n=this.editedAtom())?t=J(n)===(Dt(n)?0:1)?this.removeSelectable(this.selectedTangible()):(o=this.offsetToCursor(n),u=this.isAtLimit(e,n)?fn(e):e,{changeWithinAtom:{string:"",range:[o,o+u]}}):this.isSelecting()?this.removeSelectable(this.selectedTangible()):(f=this.selectedTangible(),i=this.selectionMargin(e),u=i?e:fn(e),d=this.selectionMargin(u),d?(a=$n(p,ln(l,d)),r=ln(h,d),{changeInTree:{at:d},tangibleSelection:Jn(c,a,r)}):Gt(s=this.parentOfSelected())?this.removeSelectable(Ct([s])):{}))},m.prototype.removeSelected=function(){return this.isInserting()?void 0:this.mutate(this.removeSelectable(this.selectedTangible()))},m.prototype.removeSelectable=function(e){return{changeInTree:{at:e},tangibleSelection:{"in":[],out:e.out}}},m.prototype.isAtLimit=function(e,t){var n;return n=this.distance(this.cursorPosition(),this.editableEdge(e,t)),0===n},m.prototype.offsetToCursor=function(e){return this.distance(this.cursorPosition(),this.startPos(e))},m.prototype.selectedText=function(){return this.isEditing()?this.editedAtom().symbol:this.editor.getSelectedText()},m.prototype.selectableEdge=function(e){return qn(e,this.selectedTangible())},m.prototype.editableEdge=function(e,t){return Dt(t)?this.idxToPos(V(e,t)+fn(e)):this.edgeOfNode(e,t)},m.prototype.realParentOfSelected=function(){var e;return Gt(e=this.parentOfSelected())?e:void 0},m.prototype.parentOfSelected=function(){return bn(this.selectedTangible())},m.prototype.selectedSibling=function(e){return this.toSelectionSibling(e).siblingTangible},m.prototype.toSelectionSibling=function(e){var t,n;return t=this.selectionMargin(e),t?(n=vn(e,t),{margin:t,siblingTangible:Jn(e,G(e,t["in"]),G(fn(e),n))}):{}},m.prototype.selectionMargin=function(e){return Yn(e,this.selectedTangible())},m.prototype.selectedNodeEdge=function(e){return ln(e,this.selectedTangible())},m.prototype.editedAtom=function(){return this.isEditing()?this.onlySelectedExpression():void 0},m.prototype.onlySelectedExpression=function(){return dn(this.selectedTangible())},m.prototype.startGroupMutation=function(){return this.groupMutating=!0},m.prototype.finishGroupMutation=function(){return this.groupMutating=!1,this.undoManager().packGroupMutation()},m.prototype.registerMutation=function(e,t){var n,i,r;return i=this.isEditing()?(n=this.editedAtom(),{withinAtom:n,withinAtomPos:this.distance(this.startPos(n),this.editor.selection.getRange().end)}):{tangibleSelection:this.selectedTangible()},"function"==typeof(r=this.undoManager()).registerMutation?r.registerMutation(e,i,t):void 0},m.prototype.replay=function(e,t){var n,i,r,o;if(i=e.pop()){for(this.startGroupMutation(),r=0,o=i.length;o>r;r++)n=i[r],this.mutate(n,t);return this.finishGroupMutation()}},m.prototype.mutate=function(e,t){var n,i,r,o,s,a,l,c,u,h,d,p,f,m,g,v,y;if(null==t&&(t={undo:!0}),this.registerMutation(e,t),this.groupMutating||"function"==typeof(f=this.undoManager()).packGroupMutation&&f.packGroupMutation(),e.changeInTree&&(c=e.changeInTree.at,n=e.changeInTree.added||[],l=this.rangeOfTangible(c),i=hn(n),w(c,n)),e.changeWithinAtom){if(l)throw"atom edit during tree edit not supported";c=e.changeWithinAtom.range,n=e.changeWithinAtom.string,r=e.changeWithinAtom.atom||this.editedAtom(),l=this.rangeWithingAtom(r,c),i=n,b(r,c,n)}if(null!=i&&(this.repositionAst(),this.docReplace(l,i)),(e.inSelection||e.inSelections||e.tangibleSelection||e.selectionRange||e.memorableSelection)&&(d=e.tangibleSelection||e.selectionRange&&this.tangibleSelectionFromRange(e.selectionRange)||e.memorableSelection&&(v=e.memorableSelection,a=v[0],u=v[1],v)&&a(u)||Ct(e.inSelections||[e.inSelection]),h=this.rangeOfTangible(d),o=!1),e.withinAtom){if(d)throw"shouldn't set both withinAtom and selection";d=Ct([e.withinAtom]),h=this.rangeWithingAtom(e.withinAtom,[e.withinAtomPos,e.withinAtomPos]),o=!0}if(d&&(this.select(d,o),this.setSelectionRange(h,e.desiredColumn)),e.newSelections)for(y=e.newSelections,m=0,g=y.length;g>m;m++)p=y[m],s=this.tangibleRange(p),this.selectFor(p,!1,s),this.editor.selection.addRange(s);return!0},m.prototype.handleCommandExecution=function(e){return this.updateEditingMarkers(),this.updateErrorMarkers(),this.closeTooltip(),this.doAutocomplete(e)},m.prototype.select=function(e,t){return this.editor.selection.$nodes=e,this.editor.selection.$editing=t},m.prototype.selectFor=function(e,t,n){return n.$nodes=e,n.$editing=t},m.prototype.setSelectionRange=function(e,t){return this.editor.selection.setSelectionRange(e),this.editor.selection.$desiredColumn=t},m.prototype.updateEditingMarkers=function(){var e,t,n,i,r;for(e=this.isMultiSelecting()?this.editor.multiSelect.ranges:[this.editor.selection],t=i=0,r=e.length;r>i;t=++i)n=e[t],this.updateEditingMarkerFor(this.isEditingFor(n),n)},m.prototype.updateEditingMarkerFor=function(e,t){var n,i,r;return(i=t.$editMarker)&&(this.editor.session.removeMarker(i),t.$editMarker=void 0),e?(n=dn(t.$nodes),r=this.editableRange(n),i=this.editor.session.addMarker(r,"ace_active-token"),t.$editMarker=i):void 0},m.prototype.isMultiSelecting=function(){return this.editor.multiSelect.inMultiSelectMode},m.prototype.selectedTangiblesList=function(){var e,t,n,i;if(this.isMultiSelecting()){for(n=this.editor.multiSelect.ranges,i=[],t=n.length-1;t>=0;t+=-1)e=n[t],i.push(e.$nodes);return i}return[this.selectedTangible()]},m.prototype.selectedTangible=function(){return this.editor.selection.$nodes},m.prototype.isEditing=function(){return this.editor.selection.$editing},m.prototype.isEditingFor=function(e){return e.$editing},m.prototype.isEditingDelimited=function(){return this.isEditing()&&Dt(this.editedAtom())},m.prototype.isEditingHalfDelimited=function(){return this.isEditing()&&Ot(this.editedAtom())},m.prototype.isSelecting=function(){return!this.isEditing()&&this.selectedTangible()["in"].length>0},m.prototype.isSelectingMultiple=function(){return this.isSelecting()&&this.selectedTangible()["in"].length>1},m.prototype.isInserting=function(){return 0===this.selectedTangible()["in"].length},m.prototype.toText=function(e){return this.editor.session.doc.getTextRange(this.range(e))},m.prototype.editableRange=function(e){return Dt(e)?this.delimitedAtomRange(e):this.range(e)},m.prototype.cursorPosition=function(){return this.editor.getCursorPosition()},m.prototype.handleRangeDeselect=function(e){var t,n,i,r,o;for(n=e.ranges,o=[],i=0,r=n.length;r>i;i++)t=n[i],o.push(this.updateEditingMarkerFor(!1,t));return o},m.prototype.delimitedAtomRange=function(e){var t,n,i;return i=this.range(e),n=i.start,t=i.end,f.fromPoints(this.shiftPosBy(n,1),this.shiftPosBy(t,-1))},m.prototype.rangeWithingAtom=function(e,t){var n,i,r;return r=Wn(t),i=r[0],n=r[1],f.fromPoints(this.idxToPos(e.start+i),this.idxToPos(e.start+n))},m.prototype.rangeOfNodes=function(e){var t,n;return t=e[0],n=e[e.length-1],En(this.startPos(t),this.endPos(n))},m.prototype.rangeOfTangible=function(e){var t,n,i;return i=cn(e),t=i[0],n=i[1],En(this.startPos(t),this.startPos(n))},m.prototype.range=function(e){var t,n;return n=this.startPos(e),t=this.endPos(e),f.fromPoints(n,t)},m.prototype.endOfLine=function(e){return this.idxToPos(this.posToIdx({row:e.row+1,column:0})-1)},m.prototype.edgeOfNode=function(e,t){return this.idxToPos(V(e,t))},m.prototype.nodeRange=function(e){return En(this.startPos(e),this.endPos(e))},m.prototype.startPos=function(e){return this.idxToPos(e.start)},m.prototype.endPos=function(e){return this.idxToPos(e.end)},m.prototype.distance=function(e,t){return Math.abs(this.posToIdx(t)-this.posToIdx(e))},m.prototype.idxToPos=function(e){return this.editor.session.doc.indexToPosition(e)},m.prototype.posToIdx=function(e){return this.editor.session.doc.positionToIndex(e)},m.prototype.trimmedPosToIdx=function(e){return this.posToIdx(this.editor.session.$clipPositionToDocument(e.row,e.column))},m.prototype.shiftPosBy=function(e,t){return this.idxToPos(this.posToIdx(e)+t)},m.prototype.docReplace=function(e,t){var n;return n=this.editor.session.doc,n.remove(e),n.insert(e.start,t)},m.prototype.prepareWorker=function(){var e;return e=new s(["ace","compilers"],"compilers/teascript/worker","Worker",null),this.worker=e},m.prototype.createWorker=function(e){if(!this.worker)throw new Error("Missing worker in mode");return this.worker.attachToDocument(e.getDocument()),this.worker.on("error",function(t){return e.setAnnotations([t.data])}),this.worker.on("ok",function(){return function(){return e.clearAnnotations()}}(this)),this.worker},m.prototype.reportModuleName=function(e){return e!==this.moduleName?(this.moduleName=e,this.worker.call("setModuleName",[e])):void 0},m}(g),o=function(){function e(e){this.mode=e,this.reset=xi(this.reset,this),this.redo=xi(this.redo,this),this.undo=xi(this.undo,this),this.packGroupMutation=xi(this.packGroupMutation,this),this.registerMutation=xi(this.registerMutation,this),this.execute=xi(this.execute,this),this.reset()}return e.prototype.execute=function(){},e.prototype.registerMutation=function(e,t,n){var i,r,o,s,a,l,c,u;return l=n.undo?this.undoStack:this.redoStack,a=[],e.changeInTree&&(s=e.changeInTree.at,i=e.changeInTree.added||[],a.push({changeInTree:{at:{"in":i,out:s.out},added:s["in"]}})),e.changeWithinAtom&&(u=Wn(e.changeWithinAtom.range),o=u[0],c=u[1],i=e.changeWithinAtom.string,r=e.changeWithinAtom.atom||this.mode.editedAtom(),a.push({changeWithinAtom:{range:[o,o+i.length],string:r.symbol.slice(o,c),atom:r}})),a.push(t),this.groupMutationRegister.stack=l,this.groupMutationRegister.states.push(on(a))},e.prototype.packGroupMutation=function(){var e,t,n,i;return i=this.groupMutationRegister,t=i.stack,n=i.states,n.reverse(),t.push(this.sameKindMutation(n,t[t.length-1]||[])?e=n.concat(t.pop()):n),this.groupMutationRegister={states:[]}},e.prototype.undo=function(){return this.mode.replay(this.undoStack,{redo:!0})},e.prototype.redo=function(){return this.mode.replay(this.redoStack,{undo:!0})},e.prototype.reset=function(){return this.undoStack=[],this.redoStack=[],this.groupMutationRegister={states:[]}},e.prototype.sameKindMutation=function(e,t){var n,i,r,o,s,a,l,c,u,h,d;return e.length>0&&t.length>0?(r=e[0],i=t[0],(n=null!=(o=r.changeInTree)?o.added[0]:void 0)&&n===(null!=(s=i.changeWithinAtom)?s.atom:void 0)||(n=null!=(a=r.changeWithinAtom)?a.atom:void 0)&&r.changeWithinAtom.string.length>0&&n===(null!=(l=i.changeWithinAtom)?l.atom:void 0)&&i.changeWithinAtom.string.length>0||(n=null!=(c=r.changeWithinAtom)?c.atom:void 0)&&0===r.changeWithinAtom.string.length&&n===(null!=(u=i.changeInTree)?u.at["in"][0]:void 0)||(n=null!=(h=r.changeWithinAtom)?h.atom:void 0)&&0===r.changeWithinAtom.string.length&&n===(null!=(d=i.changeWithinAtom)?d.atom:void 0)&&0===i.changeWithinAtom.string.length):!1},e}(),A=function(e){var t,n,i,r,o,s,a,l,c,u;for(r="xyzwtuvmnopqrs",s=!1,o=0,n={},i=[],t=function(e){var t;return i.push((t=n[e])?(n[e]++,e+t):(n[e]=2,e))},u=ui(e),l=0,c=u.length;c>l;l++)a=u[l],s?s=!1:t(It(a)?(s=!0,fi(a)):!xt(a)||Ot(a)||zt(a)?r[o++]:a.symbol);return i},Xt=function(e){var t;return Gt(t=bn(e))?Vt(t):!0},C=function(e){var t;return(t=wn(e))?Vt(t)&&Rt(e)?e:C(t):e},pt=function(e,t){return dt(t)||e},dt=function(e){return Bt(e)?e:Gt(e.parent)?dt(e.parent):void 0},ht=function(e){var t;return t=ui(e)[0]},st=function(e){var t,n;return n=ui(e),t=n[n.length-1]},Ft=function(e){return _t(e)&&Bt(gi(e))},Vt=function(e){var t;return Bt(e)||Lt(e)&&"syntax"===(null!=(t=gi(e))?t.symbol:void 0)},Bt=function(e){var t;return Lt(e)&&"fn"===(null!=(t=gi(e))?t.symbol:void 0)},$t=function(e){var t,n;return!(Lt(e)&&("#"===(t=null!=(n=gi(e))?n.symbol:void 0)||":"===t))},Q=function(e){var t,n,i,r,o,s,a,l,c;if(Lt(t=e)){for(o=t.slice(0,2),c=t.slice(2,-1),n=a=0,l=c.length;l>a;n=++a)s=c[n],Jt(s)||(i=t[n-1+2],r=Nt(i)?t.slice(n-2+2,n+2):Jt(i)?[i]:[ri(" ")],o.push.apply(o,ki.call(r).concat([Q(s)])));return o.push(t[t.length-1]),en(o)}return e},z=function(e){var t;return(t=wn(e))?jt(Pn(p,t))?t:z(t):void 0},jt=function(e){return"name"===(null!=e?e.label:void 0)},Pt=function(e){return"keyword"===(null!=e?e.label:void 0)},rt=function(e){return function(t){var n,i,r,o,s;return o=e.length,i=function(){var n,i,a;if(1===o){if(un(e[0],t))return[[t]]}else if(Lt(t)&&t.length>=o){for(a=[],r=n=0,i=t.length-o;i>=0?i>=n:n>=i;r=i>=0?++n:--n)un(s=t.slice(r,r+o),e)&&a.push(s);return a}}(),n=Lt(t)?j(rt(e),t):void 0,Qt(i||[],n||[])}},un=function(e,t){return Lt(e)?Lt(t)&&e.length===t.length&&y(li(un,e,t)):e.symbol===t.symbol},at=function(e,t){var n,i,r;for(i=0,r=t.length;r>i;i++)if(n=t[i],jt(n)&&n.symbol===e)return n},k=function(e){return{name:e.symbol,scope:e.scope}},ot=function(e){return function(t){return Lt(t)?j(ot(e),t):t.id===e.id?[t]:[]}},ut=function(e){return function(t){return Lt(t)?j(ut(e),t):t.id===e.id&&t!==e?[t]:[]}},Pn=function(e,t){var n,i,r,o,s;for(r=bi(t.parent),n=o=0,s=r.length;s>o;n=++o)if(i=r[n],i===t)return e===c?r[n+1]:r[n-1]},it=function(e,t,n){var i,r,o,s;for(e>0?(o=0,s=n.length):o=n.length-1;e>0?s>o:o>=0;o+=e){if(i=n[o],r)return i;(i===t||i[0]&&i[0]===t[0])&&(r=!0)}return G(fn(e),n)},dn=function(e){var t;return t=e["in"][0],1===e["in"].length&&Rt(t)?t:void 0},tt=function(e){var t;return t=e.out[0],t.fake?t:void 0},In=function(e){var t,n,i,r;return t=nn(ci(K,bn),e),n=Math.min.apply(Math,t),i=function(){var t,i,o;for(o=[],t=0,i=e.length;i>t;t++)r=e[t],o.push(zn(r,K(bn(r))-n));return o}(),On(i)},On=function(e){var t,n,i,r;for(t=bn(e[0]),i=0,r=e.length;r>i;i++)if(n=e[i],bn(n)!==t)return On(nn(Xn,e));return e},zn=function(e,t){return 0===t?e:zn(Xn(e),t-1)},Kn=function(e,t){var n,i,r,o,s;return s=jn(e,t),n=s[0],o=s[1],r=bn(n),i=ln(l,n),{"in":r.slice(R(i),L(o)),out:o.out}},ei=function(e){var t;return W(nt(pi,[t=Yn(p,e),e,t?void 0:Yn(d,e)]))},Zn=function(e){return W(nt(pi,[Yn(p,e),e,Yn(d,e)]))},Yn=function(e,t){var n,i;return i=vn(e,t),n=G(e,i),Jt(n)?Ct(i):null},jn=function(e,t){return L(e)>L(t)?[t,e]:[e,t]},qn=function(e,t){var n;return n=G(e,t["in"]),e===c||0===t["in"].length?{"in":!n||Jt(n)?[]:[n],out:t.out}:Jt(n)?{"in":[],out:[n]}:Ct([n])},bn=function(e){return e.out[0].parent},L=function(e){return R(e.out[0])},ln=function(e,t){return G(e,cn(t))},cn=function(e){var t,n;return t=Qt(e["in"],e.out)[0],n=e.out[0],[t,n]},Ct=function(e){var t,n;return t=e[e.length-1],n=$n(d,t),{"in":e,out:ai(n)}},gn=function(e){return{"in":[],out:ai(e[0])}},W=function(e){var t,n,i;return t=2<=e.length?ki.call(e,0,i=e.length-1):(i=0,[]),n=e[i++],{"in":Qt(j(Qn,t),n["in"]),out:n.out}},Qn=function(e){return e["in"]},gt=function(e,t){var n;return n=function(e){return xt(e)&&!Ut(e)},mt(n,e,t)},ft=function(e,t){return mt(Rt,e,t)},mt=function(e,t,n){var i,r,o;for(r=Gn(fn(t),n);(o=e(i=ni(r)))&&Ht(i,n);)r=yt(t,r);return o?n:r},Ht=function(e,t){return e&&(e===t||Ht(e.parent,t))},yt=function(e,t){return _(e,Nn(e,ln(e,t)))},_=function(e,t){var n;return t?(n=St(t))?n:_(e,Nn(e,t)):void 0},St=function(e){var t;return t=An(e),(Jt(e)&&!Nt(e)||kt(e))&&!kt(t)?{"in":Rt(t)?[t]:[],out:ai(e)}:void 0},Xn=function(e){var t;return t=bn(e),Gt(t)?Ct([t]):void 0},Jn=function(e,t,n){var i,r,o;return o=wt(e,t,n),r=o[0],i=o[1],r===i&&Rt(r)?Ct([r]):kt(r)?Ct([r.parent]):Kt(i)?Ct([i.parent]):Rt(r)?{"in":[r],out:ai(i)}:Rt(i)?Ct([i]):Kt(r)||!Nt(i)?{"in":[],out:ai(i)}:Vn(e,n)},Vn=function(e,t){var n;return(n=$n(e,t))&&Jn(e,t,n)},Gn=function(e,t){return qn(e,At(t))},wt=function(e,t,n){return e===c?[t,n]:[n,t]},At=function(e){return{"in":e.slice(1,-1),out:e.slice(-1)}},yn=function(e,t){return G(e,vn(e,t))},vn=function(e,t){return e===c?t.out:xn($n(p,ni(t)))},Cn=function(e){return nn(function(e){return e()},e)},T=function(e){var t;return t=An(ni(e)),function(){return{"in":[],out:ai(vt(t))}}},rn=function(e){return 0===e["in"].length?[[e.out[0]],gn]:[e["in"],Ct]},ti=function(e){return Rt(e)?ii(e):{"in":[],out:ai(e)}},ii=function(e){return Ct([e])},ni=function(e){return ln(l,e)},xn=function(e){return Nt(e)?[$n(p,e),e]:[e]},ai=function(e){var t;return t=$n(d,e),Jt(e)&&t&&Nt(t)?[e,t]:[e]},Zt=function(e,t){return Lt(t)?Zt(e,G(e,bi(t))):t},K=function(e){return Gt(e)?1+K(e.parent):-1},Et=function(e,t,n){return e.parent=t,t.splice(n,0,e)},w=function(e,t){var n,i,r,o,s;for(r=e.out[0].parent,o=0,s=t.length;s>o;o++)i=t[o],i.parent=r;return n=R(ln(l,e)),r.splice.apply(r,[n,e["in"].length].concat(ki.call(t)))},b=function(e,t,n){var i,r,o,s;return s=Wn(t),o=s[0],i=s[1],r=i-o,e.symbol=Un(e.symbol,o,r,n),e.end+=n.length-r},E=function(e,t,n){var i,r,o;return o=wt(e,t,n),r=o[0],i=o[1],{"in":Qt(r["in"],i["in"]),out:i.out}},Wn=function(e){var t,n;return t=e[0],n=e[1],[Math.min(t,n),Math.max(t,n)]},hn=function(e){var t,n,i,r;for(n="",i=0,r=e.length;r>i;i++)t=e[i],n+=Lt(t)?hn(t):t.symbol;return n},J=function(e){return e.symbol.length-(Dt(e)?2:Ot(e)?1:0)},M=function(e,t,n){var i,r,o,s,a;return s=e.length,o=(i=e.indexOf("."))>=0?i+1:s,r=s-o,a=parseFloat(e),a*=Math.pow(10,r),n*=Math.pow(10,s-t-(o!==s&&o>t?1:0)),a+=n,a/=Math.pow(10,r),a.toFixed(r)},Rt=function(e){return!Jt(e)&&!Tt(e)},xt=function(e){return Rt(e)&&!Lt(e)},zt=function(e){return e.symbol&&/^-?\d/.test(e.symbol)},Dt=function(e){var t;return"string"===(t=e.label)||"regex"===t},Ot=function(e){return"char"===e.label||Dt(e)},F=function(e){return e.symbol[0]},Tt=function(e){return/^[\(\)\[\]\{\}]$/.test(e.symbol)},kt=function(e){return/^[\)\]\}]$/.test(e.symbol)},Kt=function(e){return/^[\(\[\{]$/.test(e.symbol)},qt=function(e){var t;return t=wn(e),t&&_t(t)&&di(bi(t))===e},Mt=function(e){return 2===e.length&&"("===e[0].symbol},It=function(e){return"label"===e.label},Jt=function(e){var t;return"whitespace"===(t=e.label)||"indent"===t},Nt=function(e){return"indent"===e.label},Yt=function(e){return" "===e.symbol},Wt=function(e){return"\n"===e.symbol},Gt=function(e){return e.start>=0},Z=function(e,t){return t.replace(RegExp(""+e,"g"),"\\"+e)},Ln=function(e,t){return new Array(e+1).join(t)},on=function(e){var t,n,i,r,o,s;for(n={},o=0,s=e.length;s>o;o++){t=e[o];for(i in t)r=t[i],n[i]=r}return n},et=function(e,t){return on([e,t])},Ci=function(e){return e.transformed?Ci(e.transformed):e},lt=function(e,t,n){var i;return t<e.end&&e.start<n?t===e.start&&n===e.end?[e]:P(function(){var r,o,s;for(s=[],r=0,o=e.length;o>r;r++)i=e[r],s.push(lt(i,t,n));return s}()):[]},ct=function(e,t,n){var i;return t<e.end&&e.start<n?Lt(e)?P(function(){var r,o,s;for(s=[],r=0,o=e.length;o>r;r++)i=e[r],s.push(ct(i,t,n));return s}()):[e]:[]},H=function(e){var t,n;return t=nn(U,e),(n=t[t.length-1])&&"\n"===n.value&&t.pop(),t},U=function(e){var t;return t=Tt(e),{value:"string"===e.label?"“"+e.symbol.slice(1,-1)+"”":e.symbol,type:function(){if(t&&e.parent.malformed||!t&&e.malformed)return"token_malformed";switch(e.label){case"whitespace":return"text";default:return e.label?"token_"+e.label:"text"}}()+(e.fake?".token_fake":"")}},oi=function(e){var t;return t=e.slice(1,-1),t.start=e.start+1,t.end=e.end-1,t},V=function(e,t){return e===c?t.end:t.start},X=function(e,t){return Y(e,t)+(Dt(t)?fn(e):0)},Y=function(e,t){return e===c?t.symbol.length:0},G=function(e,t){var n,i;return n=t[0],i=t[t.length-1],e===c?i:n},En=function(e,t){return f.fromPoints(e,t)},Un=function(e,t,n,i){return e.slice(0,t)+i+e.slice(t+n)},Fn=function(e){var t,n,i,r;for(n=!1,r=e.parent,i=r.length-1;i>=0;i+=-1){if(t=r[i],n&&Rt(t))return t;t===e&&(n=!0)}return e},an=function(e){var t,n,i,r,o;for(n=!1,o=e.parent,i=0,r=o.length;r>i;i++){if(t=o[i],n&&Rt(t))return t;t===e&&(n=!0)}return e},An=function(t){return Nn(e,t)},vt=function(e){return Nn(c,e)},Nn=function(e,t){var n;return n=$n(e,t)||Gt(t.parent)&&Nn(e,t.parent),n?Lt(n)?G(fn(e),n):n:void 0},wn=function(e){return Gt(e.parent)?e.parent:void 0},$n=function(e,t){return t.parent[R(t)+e]},Sn=function(e){return e.parent[R(e)-1]},sn=function(e){return e.parent[R(e)+1]},R=function(e){return bt(e,e.parent)},bt=function(e,t){var n,i,r,o;for(i=r=0,o=t.length;o>r;i=++r)if(n=t[i],n===e)return i;throw new Error("what is not inside of array in indexWithin")},q=function(e,t){var n,i,r,o,s;if(t.malformed=e.malformed,t.tea=e.tea,t.id=e.id,t.fake=e.fake,t.assignable=e.assignable,t.scope=e.scope,t.inferredType=e.inferredType,t.imported=e.imported,Lt(e)){for(s=[],n=r=0,o=e.length;o>r;n=++r)i=e[n],s.push(q(i,t[n]));return s}return t.label=e.label},Rn=function(e,t,n){return Dn(e["in"],t,n)},Mn=function(e,t){return Tn(e["in"],t)},Tn=function(e,t){var n;return n=Dn(e,t,[])[0]},Dn=function(e,t,n){var i,r,o,s,a,l;for(l=N(e,n),i=l[0],o=l[1],s=0,a=i.length;a>s;s++)r=i[s],r.parent=t;return[kn(i,t),o]},x=function(e,t){var n,i,r,o,s;return o=I.astizeList(e),_n(K(t),o),r=o[0],i=3<=o.length?ki.call(o,1,s=o.length-1):(s=1,[]),n=o[s++],i},O=function(e){var t;return t=N(e,[])[0]},N=function(e,t){var n,i,r;return r=si(nn($(t),e)),n=r[0],i=r[1],[n,P(i)]},B=function(e){var t;return t=$([])(e)[0]},$=function(e){return function(t){var n,i,r;return Lt(t)?(r=N(t,e),n=r[0],i=r[1],en(n)):(i=[],n={symbol:t.symbol,label:t.label}),n.start=t.start,n.end=t.end,n.malformed=t.malformed,n.tea=t.tea,n.id=t.id,_i.call(e,t)>=0&&(i=[n]),[n,i]}},kn=function(e,t){return _n(K(t),e),e},_n=function(e,t,n,i){var r,o,s,a,l,c;if(Lt(t))for(r=0;r<t.length;)_n(e+1,t[r],t[r+1],r+1),++r;else n&&Wt(t)&&(o=Ln(e,"  "),l=e>0,Nt(n)?l?Bn(n,o):n.parent.splice(i,1):l&&(c=S("\n  "),a=c[0],s=c[1],Bn(s,o),Et(s,n.parent,R(n))))},en=function(e){var t,n,i;for(n=0,i=e.length;i>n;n++)t=e[n],t.parent=e;return e},Bn=function(e,t){return e.symbol=t,e.end=e.start+t.length},S=function(e){var t,n,i,r,o;return o=I.astizeExpression("("+e+")"),i=o[0],n=3<=o.length?ki.call(o,1,r=o.length-1):(r=1,[]),t=o[r++],n},h=c=d=1,l=e=p=-1,fn=function(e){return-1*e}});