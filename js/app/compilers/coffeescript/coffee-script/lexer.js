define(function(require,exports,module){var e,t,n,r,i,o,s,a,l,c,u,h,d,p,f,m,g,v,y,b,w,C,x,A,E,_,S,T,F,k,D,M,R,L,N,O,B,I,$,P,j,W,z,H,q,U,V,K,G,J,Y,X,Q,Z=module.uri||"",et=(Z.substring(0,Z.lastIndexOf("/")+1),[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1});X=require("./rewriter"),O=X.Rewriter,v=X.INVERSES,Q=require("./helpers"),H=Q.count,J=Q.starts,z=Q.compact,V=Q.last,G=Q.repeat,q=Q.invertLiterate,K=Q.locationDataToString,Y=Q.throwSyntaxError,exports.Lexer=E=function(){function t(){}return t.prototype.tokenize=function(e,t){var n,r,i,o;for(null==t&&(t={}),this.literate=t.literate,this.indent=0,this.indebt=0,this.outdebt=0,this.indents=[],this.ends=[],this.tokens=[],this.chunkLine=t.line||0,this.chunkColumn=t.column||0,e=this.clean(e),r=0;this.chunk=e.slice(r);)n=this.identifierToken()||this.commentToken()||this.whitespaceToken()||this.lineToken()||this.heredocToken()||this.stringToken()||this.numberToken()||this.regexToken()||this.jsToken()||this.literalToken(),o=this.getLineAndColumnFromChunk(n),this.chunkLine=o[0],this.chunkColumn=o[1],r+=n;return this.closeIndentation(),(i=this.ends.pop())&&this.error("missing "+i),t.rewrite===!1?this.tokens:(new O).rewrite(this.tokens)},t.prototype.clean=function(t){return t.charCodeAt(0)===e&&(t=t.slice(1)),t=t.replace(/\r/g,"").replace(P,""),W.test(t)&&(t="\n"+t,this.chunkLine--),this.literate&&(t=q(t)),t},t.prototype.identifierToken=function(){var e,t,n,r,a,l,c,u,h,d,p,f,g,v;return(c=m.exec(this.chunk))?(l=c[0],r=c[1],e=c[2],a=r.length,u=void 0,"own"===r&&"FOR"===this.tag()?(this.token("OWN",r),r.length):(n=e||(h=V(this.tokens))&&("."===(f=h[0])||"?."===f||"::"===f||"?::"===f||!h.spaced&&"@"===h[0]),d="IDENTIFIER",!n&&(et.call(w,r)>=0||et.call(s,r)>=0)&&(d=r.toUpperCase(),"WHEN"===d&&(g=this.tag(),et.call(C,g)>=0)?d="LEADING_WHEN":"FOR"===d?this.seenFor=!0:"UNLESS"===d?d="IF":et.call(j,d)>=0?d="UNARY":et.call(L,d)>=0&&("INSTANCEOF"!==d&&this.seenFor?(d="FOR"+d,this.seenFor=!1):(d="RELATION","!"===this.value()&&(u=this.tokens.pop(),r="!"+r)))),et.call(b,r)>=0&&(n?(d="IDENTIFIER",r=new String(r),r.reserved=!0):et.call(N,r)>=0&&this.error('reserved word "'+r+'"')),n||(et.call(i,r)>=0&&(r=o[r]),d=function(){switch(r){case"!":return"UNARY";case"==":case"!=":return"COMPARE";case"&&":case"||":return"LOGIC";case"true":case"false":return"BOOL";case"break":case"continue":return"STATEMENT";default:return d}}()),p=this.token(d,r,0,a),u&&(v=[u[2].first_line,u[2].first_column],p[2].first_line=v[0],p[2].first_column=v[1]),e&&(t=l.lastIndexOf(":"),this.token(":",":",t,e.length)),l.length)):0},t.prototype.numberToken=function(){var e,t,n,r,i;return(n=D.exec(this.chunk))?(r=n[0],/^0[BOX]/.test(r)?this.error("radix prefix '"+r+"' must be lowercase"):/E/.test(r)&&!/^0x/.test(r)?this.error("exponential notation '"+r+"' must be indicated with a lowercase 'e'"):/^0\d*[89]/.test(r)?this.error("decimal literal '"+r+"' must not be prefixed with '0'"):/^0\d+/.test(r)&&this.error("octal literal '"+r+"' must be prefixed with '0o'"),t=r.length,(i=/^0o([0-7]+)/.exec(r))&&(r="0x"+parseInt(i[1],8).toString(16)),(e=/^0b([01]+)/.exec(r))&&(r="0x"+parseInt(e[1],2).toString(16)),this.token("NUMBER",r,0,t),t):0},t.prototype.stringToken=function(){var e,t,n;switch(this.chunk.charAt(0)){case"'":if(!(e=I.exec(this.chunk)))return 0;n=e[0],this.token("STRING",n.replace(S,"\\\n"),0,n.length);break;case'"':if(!(n=this.balancedString(this.chunk,'"')))return 0;0<n.indexOf("#{",1)?this.interpolateString(n.slice(1,-1),{strOffset:1,lexedLength:n.length}):this.token("STRING",this.escapeLines(n,0,n.length));break;default:return 0}return(t=/^(?:\\.|[^\\])*\\(?:0[0-7]|[1-7])/.test(n))&&this.error("octal escape sequences "+n+" are not allowed"),n.length},t.prototype.heredocToken=function(){var e,t,n,r;return(n=u.exec(this.chunk))?(t=n[0],r=t.charAt(0),e=this.sanitizeHeredoc(n[2],{quote:r,indent:null}),'"'===r&&0<=e.indexOf("#{")?this.interpolateString(e,{heredoc:!0,strOffset:3,lexedLength:t.length}):this.token("STRING",this.makeString(e,r,!0),0,t.length),t.length):0},t.prototype.commentToken=function(){var e,t,n;return(n=this.chunk.match(a))?(e=n[0],t=n[1],t&&this.token("HERECOMMENT",this.sanitizeHeredoc(t,{herecomment:!0,indent:G(" ",this.indent)}),0,e.length),e.length):0},t.prototype.jsToken=function(){var e,t;return"`"===this.chunk.charAt(0)&&(e=y.exec(this.chunk))?(this.token("JS",(t=e[0]).slice(1,-1),0,t.length),t.length):0},t.prototype.regexToken=function(){var e,t,n,r,i,o,s;return"/"!==this.chunk.charAt(0)?0:(n=p.exec(this.chunk))?t=this.heregexToken(n):(r=V(this.tokens),r&&(o=r[0],et.call(r.spaced?F:k,o)>=0)?0:(n=R.exec(this.chunk))?(s=n,n=s[0],i=s[1],e=s[2],"/*"===i.slice(0,2)&&this.error("regular expressions cannot begin with `*`"),"//"===i&&(i="/(?:)/"),this.token("REGEX",""+i+e,0,n.length),n.length):0)},t.prototype.heregexToken=function(e){var t,n,r,i,o,s,a,l,c,u,h,d,p,m,g,v;if(i=e[0],t=e[1],n=e[2],0>t.indexOf("#{"))return a=t.replace(f,"").replace(/\//g,"\\/"),a.match(/^\*/)&&this.error("regular expressions cannot begin with `*`"),this.token("REGEX","/"+(a||"(?:)")+"/"+n,0,i.length),i.length;for(this.token("IDENTIFIER","RegExp",0,0),this.token("CALL_START","(",0,0),u=[],m=this.interpolateString(t,{regex:!0}),d=0,p=m.length;p>d;d++){if(c=m[d],l=c[0],h=c[1],"TOKENS"===l)u.push.apply(u,h);else if("NEOSTRING"===l){if(!(h=h.replace(f,"")))continue;h=h.replace(/\\/g,"\\\\"),c[0]="STRING",c[1]=this.makeString(h,'"',!0),u.push(c)}else this.error("Unexpected "+l);s=V(this.tokens),o=["+","+"],o[2]=s[2],u.push(o)}return u.pop(),"STRING"!==(null!=(g=u[0])?g[0]:void 0)&&(this.token("STRING",'""',0,0),this.token("+","+",0,0)),(v=this.tokens).push.apply(v,u),n&&(r=i.lastIndexOf(n),this.token(",",",",r,0),this.token("STRING",'"'+n+'"',r,n.length)),this.token(")",")",i.length-1,0),i.length},t.prototype.lineToken=function(){var e,t,n,r,i;if(!(n=T.exec(this.chunk)))return 0;if(t=n[0],this.seenFor=!1,i=t.length-1-t.lastIndexOf("\n"),r=this.unfinished(),i-this.indebt===this.indent)return r?this.suppressNewlines():this.newlineToken(0),t.length;if(i>this.indent){if(r)return this.indebt=i-this.indent,this.suppressNewlines(),t.length;e=i-this.indent+this.outdebt,this.token("INDENT",e,t.length-i,i),this.indents.push(e),this.ends.push("OUTDENT"),this.outdebt=this.indebt=0}else this.indebt=0,this.outdentToken(this.indent-i,r,t.length);return this.indent=i,t.length},t.prototype.outdentToken=function(e,t,n){for(var r,i;e>0;)i=this.indents.length-1,void 0===this.indents[i]?e=0:this.indents[i]===this.outdebt?(e-=this.outdebt,this.outdebt=0):this.indents[i]<this.outdebt?(this.outdebt-=this.indents[i],e-=this.indents[i]):(r=this.indents.pop()+this.outdebt,e-=r,this.outdebt=0,this.pair("OUTDENT"),this.token("OUTDENT",r,0,n));for(r&&(this.outdebt-=e);";"===this.value();)this.tokens.pop();return"TERMINATOR"===this.tag()||t||this.token("TERMINATOR","\n",n,0),this},t.prototype.whitespaceToken=function(){var e,t,n;return(e=W.exec(this.chunk))||(t="\n"===this.chunk.charAt(0))?(n=V(this.tokens),n&&(n[e?"spaced":"newLine"]=!0),e?e[0].length:0):0},t.prototype.newlineToken=function(e){for(;";"===this.value();)this.tokens.pop();return"TERMINATOR"!==this.tag()&&this.token("TERMINATOR","\n",e,0),this},t.prototype.suppressNewlines=function(){return"\\"===this.value()&&this.tokens.pop(),this},t.prototype.literalToken=function(){var e,t,i,o,s,a,u,h;if((e=M.exec(this.chunk))?(o=e[0],r.test(o)&&this.tagParameters()):o=this.chunk.charAt(0),i=o,t=V(this.tokens),"="===o&&t&&(!t[1].reserved&&(s=t[1],et.call(b,s)>=0)&&this.error('reserved word "'+this.value()+"\" can't be assigned"),"||"===(a=t[1])||"&&"===a))return t[0]="COMPOUND_ASSIGN",t[1]+="=",o.length;if(";"===o)this.seenFor=!1,i="TERMINATOR";else if(et.call(_,o)>=0)i="MATH";else if(et.call(l,o)>=0)i="COMPARE";else if(et.call(c,o)>=0)i="COMPOUND_ASSIGN";else if(et.call(j,o)>=0)i="UNARY";else if(et.call(B,o)>=0)i="SHIFT";else if(et.call(A,o)>=0||"?"===o&&(null!=t?t.spaced:void 0))i="LOGIC";else if(t&&!t.spaced)if("("===o&&(u=t[0],et.call(n,u)>=0))"?"===t[0]&&(t[0]="FUNC_EXIST"),i="CALL_START";else if("["===o&&(h=t[0],et.call(g,h)>=0))switch(i="INDEX_START",t[0]){case"?":t[0]="INDEX_SOAK"}switch(o){case"(":case"{":case"[":this.ends.push(v[o]);break;case")":case"}":case"]":this.pair(o)}return this.token(i,o),o.length},t.prototype.sanitizeHeredoc=function(e,t){var n,r,i,o,s;if(i=t.indent,r=t.herecomment){if(h.test(e)&&this.error('block comment cannot contain "*/", starting'),e.indexOf("\n")<0)return e}else for(;o=d.exec(e);)n=o[1],(null===i||0<(s=n.length)&&s<i.length)&&(i=n);return i&&(e=e.replace(RegExp("\\n"+i,"g"),"\n")),r||(e=e.replace(/^\n/,"")),e},t.prototype.tagParameters=function(){var e,t,n,r;if(")"!==this.tag())return this;for(t=[],r=this.tokens,e=r.length,r[--e][0]="PARAM_END";n=r[--e];)switch(n[0]){case")":t.push(n);break;case"(":case"CALL_START":if(!t.length)return"("===n[0]?(n[0]="PARAM_START",this):this;t.pop()}return this},t.prototype.closeIndentation=function(){return this.outdentToken(this.indent)},t.prototype.balancedString=function(e,t){var n,r,i,o,s,a,l,c;for(n=0,a=[t],r=l=1,c=e.length;c>=1?c>l:l>c;r=c>=1?++l:--l)if(n)--n;else{switch(i=e.charAt(r)){case"\\":++n;continue;case t:if(a.pop(),!a.length)return e.slice(0,+r+1||9e9);t=a[a.length-1];continue}"}"!==t||'"'!==i&&"'"!==i?"}"===t&&"/"===i&&(o=p.exec(e.slice(r))||R.exec(e.slice(r)))?n+=o[0].length-1:"}"===t&&"{"===i?a.push(t="}"):'"'===t&&"#"===s&&"{"===i&&a.push(t="}"):a.push(t=i),s=i}return this.error("missing "+a.pop()+", starting")},t.prototype.interpolateString=function(e,n){var r,i,o,s,a,l,c,u,h,d,p,f,m,g,v,y,b,w,C,x,A,E,_,S,T,F,k,D;for(null==n&&(n={}),o=n.heredoc,b=n.regex,m=n.offsetInChunk,C=n.strOffset,h=n.lexedLength,m=m||0,C=C||0,h=h||e.length,o&&e.length>0&&"\n"===e[0]&&(e=e.slice(1),C++),E=[],g=0,s=-1;u=e.charAt(s+=1);)"\\"!==u?"#"===u&&"{"===e.charAt(s+1)&&(i=this.balancedString(e.slice(s+1),"}"))&&(s>g&&E.push(this.makeToken("NEOSTRING",e.slice(g,s),C+g)),a=i.slice(1,-1),a.length&&(F=this.getLineAndColumnFromChunk(C+s+1),d=F[0],r=F[1],f=(new t).tokenize(a,{line:d,column:r,rewrite:!1}),y=f.pop(),"TERMINATOR"===(null!=(k=f[0])?k[0]:void 0)&&(y=f.shift()),(c=f.length)&&(c>1&&(f.unshift(this.makeToken("(","(",C+s+1,0)),f.push(this.makeToken(")",")",C+s+1+a.length,0))),E.push(["TOKENS",f]))),s+=i.length,g=s+1):s+=1;if(s>g&&g<e.length&&E.push(this.makeToken("NEOSTRING",e.slice(g),C+g)),b)return E;if(!E.length)return this.token("STRING",'""',m,h);for("NEOSTRING"!==E[0][0]&&E.unshift(this.makeToken("NEOSTRING","",m)),(l=E.length>1)&&this.token("(","(",m,0),s=S=0,T=E.length;T>S;s=++S)A=E[s],x=A[0],_=A[1],s&&(s&&(v=this.token("+","+")),p="TOKENS"===x?_[0]:A,v[2]={first_line:p[2].first_line,first_column:p[2].first_column,last_line:p[2].first_line,last_column:p[2].first_column}),"TOKENS"===x?(D=this.tokens).push.apply(D,_):"NEOSTRING"===x?(A[0]="STRING",A[1]=this.makeString(_,'"',o),this.tokens.push(A)):this.error("Unexpected "+x);return l&&(w=this.makeToken(")",")",m+h,0),w.stringEnd=!0,this.tokens.push(w)),E},t.prototype.pair=function(e){var t,n;return e!==(n=V(this.ends))?("OUTDENT"!==n&&this.error("unmatched "+e),this.indent-=t=V(this.indents),this.outdentToken(t,!0),this.pair(e)):this.ends.pop()},t.prototype.getLineAndColumnFromChunk=function(e){var t,n,r,i;return 0===e?[this.chunkLine,this.chunkColumn]:(i=e>=this.chunk.length?this.chunk:this.chunk.slice(0,+(e-1)+1||9e9),n=H(i,"\n"),t=this.chunkColumn,n>0?(r=i.split("\n"),t=V(r).length):t+=i.length,[this.chunkLine+n,t])},t.prototype.makeToken=function(e,t,n,r){var i,o,s,a,l;return null==n&&(n=0),null==r&&(r=t.length),o={},a=this.getLineAndColumnFromChunk(n),o.first_line=a[0],o.first_column=a[1],i=Math.max(0,r-1),l=this.getLineAndColumnFromChunk(n+i),o.last_line=l[0],o.last_column=l[1],s=[e,t,o]},t.prototype.token=function(e,t,n,r){var i;return i=this.makeToken(e,t,n,r),this.tokens.push(i),i},t.prototype.tag=function(e,t){var n;return(n=V(this.tokens,e))&&(t?n[0]=t:n[0])},t.prototype.value=function(e,t){var n;return(n=V(this.tokens,e))&&(t?n[1]=t:n[1])},t.prototype.unfinished=function(){var e;return x.test(this.chunk)||"\\"===(e=this.tag())||"."===e||"?."===e||"?::"===e||"UNARY"===e||"MATH"===e||"+"===e||"-"===e||"SHIFT"===e||"RELATION"===e||"COMPARE"===e||"LOGIC"===e||"THROW"===e||"EXTENDS"===e},t.prototype.escapeLines=function(e,t){return e.replace(S,t?"\\n":"")},t.prototype.makeString=function(e,t,n){return e?(e=e.replace(/\\([\s\S])/g,function(e,n){return"\n"===n||n===t?n:e}),e=e.replace(RegExp(""+t,"g"),"\\$&"),t+this.escapeLines(e,n)+t):t+t},t.prototype.error=function(e){return Y(e,{first_line:this.chunkLine,first_column:this.chunkColumn})},t}(),w=["true","false","null","this","new","delete","typeof","in","instanceof","return","throw","break","continue","debugger","if","else","switch","for","while","do","try","catch","finally","class","extends","super"],s=["undefined","then","unless","until","loop","of","by","when"],o={and:"&&",or:"||",is:"==",isnt:"!=",not:"!",yes:"true",no:"false",on:"true",off:"false"},i=function(){var e;e=[];for(U in o)e.push(U);return e}(),s=s.concat(i),N=["case","default","function","var","void","with","const","let","enum","export","import","native","__hasProp","__extends","__slice","__bind","__indexOf","implements","interface","package","private","protected","public","static","yield"],$=["arguments","eval"],b=w.concat(N).concat($),exports.RESERVED=N.concat(w).concat(s).concat($),exports.STRICT_PROSCRIBED=$,e=65279,m=/^([$A-Za-z_\x7f-\uffff][$\w\x7f-\uffff]*)([^\n\S]*:(?!:))?/,D=/^0b[01]+|^0o[0-7]+|^0x[\da-f]+|^\d*\.?\d+(?:e[+-]?\d+)?/i,u=/^("""|''')([\s\S]*?)(?:\n[^\n\S]*)?\1/,M=/^(?:[-=]>|[-+*\/%<>&|^!?=]=|>>>=?|([-+:])\1|([&|<>])\2=?|\?(\.|::)|\.{2,3})/,W=/^[^\n\S]+/,a=/^###([^#][\s\S]*?)(?:###[^\n\S]*|(?:###)$)|^(?:\s*#(?!##[^#]).*)+/,r=/^[-=]>/,T=/^(?:\n[^\n\S]*)+/,I=/^'[^\\']*(?:\\.[^\\']*)*'/,y=/^`[^\\`]*(?:\\.[^\\`]*)*`/,R=/^(\/(?![\s=])[^[\/\n\\]*(?:(?:\\[\s\S]|\[[^\]\n\\]*(?:\\[\s\S][^\]\n\\]*)*])[^[\/\n\\]*)*\/)([imgy]{0,4})(?!\w)/,p=/^\/{3}([\s\S]+?)\/{3}([imgy]{0,4})(?!\w)/,f=/\s+(?:#.*)?/g,S=/\n/g,d=/\n+([^\n\S]*)/g,h=/\*\//,x=/^\s*(?:,|\??\.(?![.\d])|::)/,P=/\s+$/,c=["-=","+=","/=","*=","%=","||=","&&=","?=","<<=",">>=",">>>=","&=","^=","|="],j=["!","~","NEW","TYPEOF","DELETE","DO"],A=["&&","||","&","|","^"],B=["<<",">>",">>>"],l=["==","!=","<",">","<=",">="],_=["*","/","%"],L=["IN","OF","INSTANCEOF"],t=["TRUE","FALSE"],F=["NUMBER","REGEX","BOOL","NULL","UNDEFINED","++","--"],k=F.concat(")","}","THIS","IDENTIFIER","STRING","]"),n=["IDENTIFIER","STRING","REGEX",")","]","}","?","::","@","THIS","SUPER"],g=n.concat("NUMBER","BOOL","NULL","UNDEFINED"),C=["INDENT","OUTDENT","TERMINATOR"]});