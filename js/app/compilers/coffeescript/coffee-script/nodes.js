define(function(require,exports,module){var e,t,n,i,r,o,s,a,l,c,u,h,p,d,f,m,g,v,y,b,w,C,x,A,_,E,S,T,F,k,D,M,R,L,N,B,O,I,$,P,j,W,z,H,q,U,V,K,G,J,Y,X,Q,Z,et,tt,nt,it,rt,ot,st,at,lt,ct,ut,ht,pt,dt,ft,mt=module.uri||"",gt=(mt.substring(0,mt.lastIndexOf("/")+1),{}.hasOwnProperty),vt=function(e,t){function n(){this.constructor=e}for(var i in t)gt.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},yt=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},bt=[].slice;Error.stackTraceLimit=1/0,P=require("./scope").Scope,dt=require("./lexer"),N=dt.RESERVED,$=dt.STRICT_PROSCRIBED,ft=require("./helpers"),Q=ft.compact,nt=ft.flatten,tt=ft.extend,st=ft.merge,Z=ft.del,ct=ft.starts,et=ft.ends,rt=ft.last,lt=ft.some,X=ft.addLocationDataFn,ot=ft.locationDataToString,ut=ft.throwSyntaxError,exports.extend=tt,exports.addLocationDataFn=X,Y=function(){return!0},k=function(){return!1},q=function(){return this},F=function(){return this.negated=!this.negated,this},exports.CodeFragment=c=function(){function e(e,t){var n;this.code=""+t,this.locationData=null!=e?e.locationData:void 0,this.type=(null!=e&&null!=(n=e.constructor)?n.name:void 0)||"unknown"}return e.prototype.toString=function(){return""+this.code+(this.locationData?": "+ot(this.locationData):"")},e}(),it=function(e){var t;return function(){var n,i,r;for(r=[],n=0,i=e.length;i>n;n++)t=e[n],r.push(t.code);return r}().join("")},exports.Base=i=function(){function e(){}return e.prototype.compile=function(e,t){return it(this.compileToFragments(e,t))},e.prototype.compileToFragments=function(e,t){var n;return e=tt({},e),t&&(e.level=t),n=this.unfoldSoak(e)||this,n.tab=e.indent,e.level!==E&&n.isStatement(e)?n.compileClosure(e):n.compileNode(e)},e.prototype.compileClosure=function(e){var t;return(t=this.jumps())&&t.error("cannot use a pure statement in an expression"),e.sharedScope=!0,a.wrap(this).compileNode(e)},e.prototype.cache=function(e,t,i){var r,o;return this.isComplex()?(r=new S(i||e.scope.freeVariable("ref")),o=new n(r,this),t?[o.compileToFragments(e,t),[this.makeCode(r.value)]]:[o,r]):(r=t?this.compileToFragments(e,t):this,[r,r])},e.prototype.cacheToCodeFragments=function(e){return[it(e[0]),it(e[1])]},e.prototype.makeReturn=function(e){var t;return t=this.unwrapAll(),e?new o(new S(""+e+".push"),[t]):new O(t)},e.prototype.contains=function(e){var t;return t=void 0,this.traverseChildren(!1,function(n){return e(n)?(t=n,!1):void 0}),t},e.prototype.lastNonComment=function(e){var t;for(t=e.length;t--;)if(!(e[t]instanceof u))return e[t];return null},e.prototype.toString=function(e,t){var n;return null==e&&(e=""),null==t&&(t=this.constructor.name),n="\n"+e+t,this.soak&&(n+="?"),this.eachChild(function(t){return n+=t.toString(e+H)}),n},e.prototype.eachChild=function(e){var t,n,i,r,o,s,a,l;if(!this.children)return this;for(a=this.children,i=0,o=a.length;o>i;i++)if(t=a[i],this[t])for(l=nt([this[t]]),r=0,s=l.length;s>r;r++)if(n=l[r],e(n)===!1)return this;return this},e.prototype.traverseChildren=function(e,t){return this.eachChild(function(n){var i;return i=t(n),i!==!1?n.traverseChildren(e,t):void 0})},e.prototype.invert=function(){return new M("!",this)},e.prototype.unwrapAll=function(){var e;for(e=this;e!==(e=e.unwrap()););return e},e.prototype.children=[],e.prototype.isStatement=k,e.prototype.jumps=k,e.prototype.isComplex=Y,e.prototype.isChainable=k,e.prototype.isAssignable=k,e.prototype.unwrap=q,e.prototype.unfoldSoak=k,e.prototype.assigns=k,e.prototype.updateLocationDataIfMissing=function(e){return this.locationData||(this.locationData=e),this.eachChild(function(t){return t.updateLocationDataIfMissing(e)})},e.prototype.error=function(e){return ut(e,this.locationData)},e.prototype.makeCode=function(e){return new c(this,e)},e.prototype.wrapInBraces=function(e){return[].concat(this.makeCode("("),e,this.makeCode(")"))},e.prototype.joinFragmentArrays=function(e,t){var n,i,r,o,s;for(n=[],r=o=0,s=e.length;s>o;r=++o)i=e[r],r&&n.push(this.makeCode(t)),n=n.concat(i);return n},e}(),exports.Block=r=function(e){function t(e){this.expressions=Q(nt(e||[]))}return vt(t,e),t.prototype.children=["expressions"],t.prototype.push=function(e){return this.expressions.push(e),this},t.prototype.pop=function(){return this.expressions.pop()},t.prototype.unshift=function(e){return this.expressions.unshift(e),this},t.prototype.unwrap=function(){return 1===this.expressions.length?this.expressions[0]:this},t.prototype.isEmpty=function(){return!this.expressions.length},t.prototype.isStatement=function(e){var t,n,i,r;for(r=this.expressions,n=0,i=r.length;i>n;n++)if(t=r[n],t.isStatement(e))return!0;return!1},t.prototype.jumps=function(e){var t,n,i,r;for(r=this.expressions,n=0,i=r.length;i>n;n++)if(t=r[n],t.jumps(e))return t},t.prototype.makeReturn=function(e){var t,n;for(n=this.expressions.length;n--;)if(t=this.expressions[n],!(t instanceof u)){this.expressions[n]=t.makeReturn(e),t instanceof O&&!t.expression&&this.expressions.splice(n,1);break}return this},t.prototype.compileToFragments=function(e,n){return null==e&&(e={}),e.scope?t.__super__.compileToFragments.call(this,e,n):this.compileRoot(e)},t.prototype.compileNode=function(e){var n,i,r,o,s,a,l,c,u;for(this.tab=e.indent,a=e.level===E,i=[],u=this.expressions,o=l=0,c=u.length;c>l;o=++l)s=u[o],s=s.unwrapAll(),s=s.unfoldSoak(e)||s,s instanceof t?i.push(s.compileNode(e)):a?(s.front=!0,r=s.compileToFragments(e),s.isStatement(e)||(r.unshift(this.makeCode(""+this.tab)),r.push(this.makeCode(";"))),i.push(r)):i.push(s.compileToFragments(e,x));return a?this.spaced?[].concat(this.joinFragmentArrays(i,"\n\n"),this.makeCode("\n")):this.joinFragmentArrays(i,"\n"):(n=i.length?this.joinFragmentArrays(i,", "):[this.makeCode("void 0")],i.length>1&&e.level>=x?this.wrapInBraces(n):n)},t.prototype.compileRoot=function(e){var t,n,i,r,o,s,a,l,c,h;for(e.indent=e.bare?"":H,e.level=E,this.spaced=!0,e.scope=new P(null,this,null),h=e.locals||[],l=0,c=h.length;c>l;l++)r=h[l],e.scope.parameter(r);return o=[],e.bare||(s=function(){var e,n,r,o;for(r=this.expressions,o=[],i=e=0,n=r.length;n>e&&(t=r[i],t.unwrap()instanceof u);i=++e)o.push(t);return o}.call(this),a=this.expressions.slice(s.length),this.expressions=s,s.length&&(o=this.compileNode(st(e,{indent:""})),o.push(this.makeCode("\n"))),this.expressions=a),n=this.compileWithDeclarations(e),e.bare?n:[].concat(o,this.makeCode("(function() {\n"),n,this.makeCode("\n}).call(this);\n"))},t.prototype.compileWithDeclarations=function(e){var t,n,i,r,o,s,a,l,c,h,p,d,f,m;for(r=[],s=[],d=this.expressions,o=h=0,p=d.length;p>h&&(i=d[o],i=i.unwrap(),i instanceof u||i instanceof S);o=++h);return e=st(e,{level:E}),o&&(a=this.expressions.splice(o,9e9),f=[this.spaced,!1],c=f[0],this.spaced=f[1],m=[this.compileNode(e),c],r=m[0],this.spaced=m[1],this.expressions=a),s=this.compileNode(e),l=e.scope,l.expressions===this&&(n=e.scope.hasDeclarations(),t=l.hasAssignments,n||t?(o&&r.push(this.makeCode("\n")),r.push(this.makeCode(""+this.tab+"var ")),n&&r.push(this.makeCode(l.declaredVariables().join(", "))),t&&(n&&r.push(this.makeCode(",\n"+(this.tab+H))),r.push(this.makeCode(l.assignedVariables().join(",\n"+(this.tab+H))))),r.push(this.makeCode(";\n"+(this.spaced?"\n":"")))):r.length&&s.length&&r.push(this.makeCode("\n"))),r.concat(s)},t.wrap=function(e){return 1===e.length&&e[0]instanceof t?e[0]:new t(e)},t}(i),exports.Literal=S=function(e){function t(e){this.value=e}return vt(t,e),t.prototype.makeReturn=function(){return this.isStatement()?this:t.__super__.makeReturn.apply(this,arguments)},t.prototype.isAssignable=function(){return f.test(this.value)},t.prototype.isStatement=function(){var e;return"break"===(e=this.value)||"continue"===e||"debugger"===e},t.prototype.isComplex=k,t.prototype.assigns=function(e){return e===this.value},t.prototype.jumps=function(e){return("break"!==this.value||(null!=e?e.loop:void 0)||(null!=e?e.block:void 0))&&("continue"!==this.value||(null!=e?e.loop:void 0))?void 0:this},t.prototype.compileNode=function(e){var t,n,i;return n="this"===this.value?(null!=(i=e.scope.method)?i.bound:void 0)?e.scope.method.context:this.value:this.value.reserved?'"'+this.value+'"':this.value,t=this.isStatement()?""+this.tab+n+";":n,[this.makeCode(t)]},t.prototype.toString=function(){return' "'+this.value+'"'},t}(i),exports.Undefined=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return vt(t,e),t.prototype.isAssignable=k,t.prototype.isComplex=k,t.prototype.compileNode=function(e){return[this.makeCode(e.level>=w?"(void 0)":"void 0")]},t}(i),exports.Null=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return vt(t,e),t.prototype.isAssignable=k,t.prototype.isComplex=k,t.prototype.compileNode=function(){return[this.makeCode("null")]},t}(i),exports.Bool=function(e){function t(e){this.val=e}return vt(t,e),t.prototype.isAssignable=k,t.prototype.isComplex=k,t.prototype.compileNode=function(){return[this.makeCode(this.val)]},t}(i),exports.Return=O=function(e){function t(e){e&&!e.unwrap().isUndefined&&(this.expression=e)}return vt(t,e),t.prototype.children=["expression"],t.prototype.isStatement=Y,t.prototype.makeReturn=q,t.prototype.jumps=q,t.prototype.compileToFragments=function(e,n){var i,r;return i=null!=(r=this.expression)?r.makeReturn():void 0,!i||i instanceof t?t.__super__.compileToFragments.call(this,e,n):i.compileToFragments(e,n)},t.prototype.compileNode=function(e){var t;return t=[],t.push(this.makeCode(this.tab+("return"+(this.expression?" ":"")))),this.expression&&(t=t.concat(this.expression.compileToFragments(e,_))),t.push(this.makeCode(";")),t},t}(i),exports.Value=G=function(e){function i(e,t,n){return!t&&e instanceof i?e:(this.base=e,this.properties=t||[],n&&(this[n]=!0),this)}return vt(i,e),i.prototype.children=["base","properties"],i.prototype.add=function(e){return this.properties=this.properties.concat(e),this},i.prototype.hasProperties=function(){return!!this.properties.length},i.prototype.isArray=function(){return!this.properties.length&&this.base instanceof t},i.prototype.isComplex=function(){return this.hasProperties()||this.base.isComplex()},i.prototype.isAssignable=function(){return this.hasProperties()||this.base.isAssignable()},i.prototype.isSimpleNumber=function(){return this.base instanceof S&&I.test(this.base.value)},i.prototype.isString=function(){return this.base instanceof S&&g.test(this.base.value)},i.prototype.isAtomic=function(){var e,t,n,i;for(i=this.properties.concat(this.base),t=0,n=i.length;n>t;t++)if(e=i[t],e.soak||e instanceof o)return!1;return!0},i.prototype.isStatement=function(e){return!this.properties.length&&this.base.isStatement(e)},i.prototype.assigns=function(e){return!this.properties.length&&this.base.assigns(e)},i.prototype.jumps=function(e){return!this.properties.length&&this.base.jumps(e)},i.prototype.isObject=function(e){return this.properties.length?!1:this.base instanceof D&&(!e||this.base.generated)},i.prototype.isSplice=function(){return rt(this.properties)instanceof j},i.prototype.unwrap=function(){return this.properties.length?this:this.base},i.prototype.cacheReference=function(e){var t,r,o,s;return o=rt(this.properties),this.properties.length<2&&!this.base.isComplex()&&!(null!=o?o.isComplex():void 0)?[this,this]:(t=new i(this.base,this.properties.slice(0,-1)),t.isComplex()&&(r=new S(e.scope.freeVariable("base")),t=new i(new L(new n(r,t)))),o?(o.isComplex()&&(s=new S(e.scope.freeVariable("name")),o=new b(new n(s,o.index)),s=new b(s)),[t.add(o),new i(r||t.base,[s||o])]):[t,r])},i.prototype.compileNode=function(e){var t,n,i,r,o;for(this.base.front=this.front,i=this.properties,t=this.base.compileToFragments(e,i.length?w:null),(this.base instanceof L||i.length)&&I.test(it(t))&&t.push(this.makeCode(".")),r=0,o=i.length;o>r;r++)n=i[r],t.push.apply(t,n.compileToFragments(e));return t},i.prototype.unfoldSoak=function(e){return null!=this.unfoldedSoak?this.unfoldedSoak:this.unfoldedSoak=function(t){return function(){var r,o,s,a,l,c,u,p,d,f;if(s=t.base.unfoldSoak(e))return(d=s.body.properties).push.apply(d,t.properties),s;for(f=t.properties,o=u=0,p=f.length;p>u;o=++u)if(a=f[o],a.soak)return a.soak=!1,r=new i(t.base,t.properties.slice(0,o)),c=new i(t.base,t.properties.slice(o)),r.isComplex()&&(l=new S(e.scope.freeVariable("ref")),r=new L(new n(l,r)),c.base=l),new v(new h(r),c,{soak:!0});return!1}}(this)()},i}(i),exports.Comment=u=function(e){function t(e){this.comment=e}return vt(t,e),t.prototype.isStatement=Y,t.prototype.makeReturn=q,t.prototype.compileNode=function(e,t){var n;return n="/*"+at(this.comment,this.tab)+(yt.call(this.comment,"\n")>=0?"\n"+this.tab:"")+"*/\n",(t||e.level)===E&&(n=e.indent+n),[this.makeCode(n)]},t}(i),exports.Call=o=function(t){function n(e,t,n){this.args=null!=t?t:[],this.soak=n,this.isNew=!1,this.isSuper="super"===e,this.variable=this.isSuper?null:e}return vt(n,t),n.prototype.children=["variable","args"],n.prototype.newInstance=function(){var e,t;return e=(null!=(t=this.variable)?t.base:void 0)||this.variable,e instanceof n&&!e.isNew?e.newInstance():this.isNew=!0,this},n.prototype.superReference=function(t){var n,i;return i=t.scope.namedMethod(),(null!=i?i.klass:void 0)?(n=[new e(new S("__super__"))],i["static"]&&n.push(new e(new S("constructor"))),n.push(new e(new S(i.name))),new G(new S(i.klass),n).compile(t)):(null!=i?i.ctor:void 0)?""+i.name+".__super__.constructor":this.error("cannot call super outside of an instance method.")},n.prototype.superThis=function(e){var t;return t=e.scope.method,t&&!t.klass&&t.context||"this"},n.prototype.unfoldSoak=function(e){var t,i,r,o,s,a,l,c,u;if(this.soak){if(this.variable){if(i=ht(e,this,"variable"))return i;c=new G(this.variable).cacheReference(e),r=c[0],s=c[1]}else r=new S(this.superReference(e)),s=new G(r);return s=new n(s,this.args),s.isNew=this.isNew,r=new S("typeof "+r.compile(e)+' === "function"'),new v(r,new G(s),{soak:!0})}for(t=this,o=[];;)if(t.variable instanceof n)o.push(t),t=t.variable;else{if(!(t.variable instanceof G))break;if(o.push(t),!((t=t.variable.base)instanceof n))break}for(u=o.reverse(),a=0,l=u.length;l>a;a++)t=u[a],i&&(t.variable instanceof n?t.variable=i:t.variable.base=i),i=ht(e,t,"variable");return i},n.prototype.compileNode=function(e){var t,n,i,r,o,s,a,l,c,u;if(null!=(c=this.variable)&&(c.front=this.front),r=W.compileSplattedArray(e,this.args,!0),r.length)return this.compileSplat(e,r);for(i=[],u=this.args,n=a=0,l=u.length;l>a;n=++a)t=u[n],n&&i.push(this.makeCode(", ")),i.push.apply(i,t.compileToFragments(e,x));return o=[],this.isSuper?(s=this.superReference(e)+(".call("+this.superThis(e)),i.length&&(s+=", "),o.push(this.makeCode(s))):(this.isNew&&o.push(this.makeCode("new ")),o.push.apply(o,this.variable.compileToFragments(e,w)),o.push(this.makeCode("("))),o.push.apply(o,i),o.push(this.makeCode(")")),o},n.prototype.compileSplat=function(e,t){var n,i,r,o,s,a;return this.isSuper?[].concat(this.makeCode(""+this.superReference(e)+".apply("+this.superThis(e)+", "),t,this.makeCode(")")):this.isNew?(o=this.tab+H,[].concat(this.makeCode("(function(func, args, ctor) {\n"+o+"ctor.prototype = func.prototype;\n"+o+"var child = new ctor, result = func.apply(child, args);\n"+o+"return Object(result) === result ? result : child;\n"+this.tab+"})("),this.variable.compileToFragments(e,x),this.makeCode(", "),t,this.makeCode(", function(){})"))):(n=[],i=new G(this.variable),(s=i.properties.pop())&&i.isComplex()?(a=e.scope.freeVariable("ref"),n=n.concat(this.makeCode("("+a+" = "),i.compileToFragments(e,x),this.makeCode(")"),s.compileToFragments(e))):(r=i.compileToFragments(e,w),I.test(it(r))&&(r=this.wrapInBraces(r)),s?(a=it(r),r.push.apply(r,s.compileToFragments(e))):a="null",n=n.concat(r)),n=n.concat(this.makeCode(".apply("+a+", "),t,this.makeCode(")")))},n}(i),exports.Extends=p=function(e){function t(e,t){this.child=e,this.parent=t}return vt(t,e),t.prototype.children=["child","parent"],t.prototype.compileToFragments=function(e){return new o(new G(new S(pt("extends"))),[this.child,this.parent]).compileToFragments(e)},t}(i),exports.Access=e=function(e){function t(e,t){this.name=e,this.name.asKey=!0,this.soak="soak"===t}return vt(t,e),t.prototype.children=["name"],t.prototype.compileToFragments=function(e){var t;return t=this.name.compileToFragments(e),f.test(it(t))?t.unshift(this.makeCode(".")):(t.unshift(this.makeCode("[")),t.push(this.makeCode("]"))),t},t.prototype.isComplex=k,t}(i),exports.Index=b=function(e){function t(e){this.index=e}return vt(t,e),t.prototype.children=["index"],t.prototype.compileToFragments=function(e){return[].concat(this.makeCode("["),this.index.compileToFragments(e,_),this.makeCode("]"))},t.prototype.isComplex=function(){return this.index.isComplex()},t}(i),exports.Range=B=function(e){function t(e,t,n){this.from=e,this.to=t,this.exclusive="exclusive"===n,this.equals=this.exclusive?"":"="}return vt(t,e),t.prototype.children=["from","to"],t.prototype.compileVariables=function(e){var t,n,i,r,o;return e=st(e,{top:!0}),n=this.cacheToCodeFragments(this.from.cache(e,x)),this.fromC=n[0],this.fromVar=n[1],i=this.cacheToCodeFragments(this.to.cache(e,x)),this.toC=i[0],this.toVar=i[1],(t=Z(e,"step"))&&(r=this.cacheToCodeFragments(t.cache(e,x)),this.step=r[0],this.stepVar=r[1]),o=[this.fromVar.match(I),this.toVar.match(I)],this.fromNum=o[0],this.toNum=o[1],this.stepVar?this.stepNum=this.stepVar.match(I):void 0},t.prototype.compileNode=function(e){var t,n,i,r,o,s,a,l,c,u,h,p,d,f;return this.fromVar||this.compileVariables(e),e.index?(a=this.fromNum&&this.toNum,o=Z(e,"index"),s=Z(e,"name"),c=s&&s!==o,p=""+o+" = "+this.fromC,this.toC!==this.toVar&&(p+=", "+this.toC),this.step!==this.stepVar&&(p+=", "+this.step),d=[""+o+" <"+this.equals,""+o+" >"+this.equals],l=d[0],r=d[1],n=this.stepNum?+this.stepNum>0?""+l+" "+this.toVar:""+r+" "+this.toVar:a?(f=[+this.fromNum,+this.toNum],i=f[0],h=f[1],f,h>=i?""+l+" "+h:""+r+" "+h):(t=this.stepVar?""+this.stepVar+" > 0":""+this.fromVar+" <= "+this.toVar,""+t+" ? "+l+" "+this.toVar+" : "+r+" "+this.toVar),u=this.stepVar?""+o+" += "+this.stepVar:a?c?h>=i?"++"+o:"--"+o:h>=i?""+o+"++":""+o+"--":c?""+t+" ? ++"+o+" : --"+o:""+t+" ? "+o+"++ : "+o+"--",c&&(p=""+s+" = "+p),c&&(u=""+s+" = "+u),[this.makeCode(""+p+"; "+n+"; "+u)]):this.compileArray(e)},t.prototype.compileArray=function(e){var t,n,i,r,o,s,a,l,c,u,h,p,d;return this.fromNum&&this.toNum&&Math.abs(this.fromNum-this.toNum)<=20?(c=function(){d=[];for(var e=p=+this.fromNum,t=+this.toNum;t>=p?t>=e:e>=t;t>=p?e++:e--)d.push(e);return d}.apply(this),this.exclusive&&c.pop(),[this.makeCode("["+c.join(", ")+"]")]):(s=this.tab+H,o=e.scope.freeVariable("i"),u=e.scope.freeVariable("results"),l="\n"+s+u+" = [];",this.fromNum&&this.toNum?(e.index=o,n=it(this.compileNode(e))):(h=""+o+" = "+this.fromC+(this.toC!==this.toVar?", "+this.toC:""),i=""+this.fromVar+" <= "+this.toVar,n="var "+h+"; "+i+" ? "+o+" <"+this.equals+" "+this.toVar+" : "+o+" >"+this.equals+" "+this.toVar+"; "+i+" ? "+o+"++ : "+o+"--"),a="{ "+u+".push("+o+"); }\n"+s+"return "+u+";\n"+e.indent,r=function(e){return null!=e?e.contains(function(e){return e instanceof S&&"arguments"===e.value&&!e.asKey}):void 0},(r(this.from)||r(this.to))&&(t=", arguments"),[this.makeCode("(function() {"+l+"\n"+s+"for ("+n+")"+a+"}).apply(this"+(null!=t?t:"")+")")])},t}(i),exports.Slice=j=function(e){function t(e){this.range=e,t.__super__.constructor.call(this)}return vt(t,e),t.prototype.children=["range"],t.prototype.compileNode=function(e){var t,n,i,r,o,s,a;return a=this.range,o=a.to,i=a.from,r=i&&i.compileToFragments(e,_)||[this.makeCode("0")],o&&(t=o.compileToFragments(e,_),n=it(t),(this.range.exclusive||-1!==+n)&&(s=", "+(this.range.exclusive?n:I.test(n)?""+(+n+1):(t=o.compileToFragments(e,w),"+"+it(t)+" + 1 || 9e9")))),[this.makeCode(".slice("+it(r)+(s||"")+")")]},t}(i),exports.Obj=D=function(e){function t(e,t){this.generated=null!=t?t:!1,this.objects=this.properties=e||[]}return vt(t,e),t.prototype.children=["properties"],t.prototype.compileNode=function(e){var t,i,r,o,s,a,l,c,h,p,d,f,m;if(h=this.properties,!h.length)return[this.makeCode(this.front?"({})":"{}")];if(this.generated)for(p=0,f=h.length;f>p;p++)l=h[p],l instanceof G&&l.error("cannot have an implicit value in an implicit object");for(r=e.indent+=H,a=this.lastNonComment(this.properties),t=[],i=d=0,m=h.length;m>d;i=++d)c=h[i],s=i===h.length-1?"":c===a||c instanceof u?"\n":",\n",o=c instanceof u?"":r,c instanceof n&&c.variable instanceof G&&c.variable.hasProperties()&&c.variable.error("Invalid object key"),c instanceof G&&c["this"]&&(c=new n(c.properties[0].name,c,"object")),c instanceof u||(c instanceof n||(c=new n(c,c,"object")),(c.variable.base||c.variable).asKey=!0),o&&t.push(this.makeCode(o)),t.push.apply(t,c.compileToFragments(e,E)),s&&t.push(this.makeCode(s));return t.unshift(this.makeCode("{"+(h.length&&"\n"))),t.push(this.makeCode(""+(h.length&&"\n"+this.tab)+"}")),this.front?this.wrapInBraces(t):t},t.prototype.assigns=function(e){var t,n,i,r;for(r=this.properties,n=0,i=r.length;i>n;n++)if(t=r[n],t.assigns(e))return!0;return!1},t}(i),exports.Arr=t=function(e){function t(e){this.objects=e||[]}return vt(t,e),t.prototype.children=["objects"],t.prototype.compileNode=function(e){var t,n,i,r,o,s,a;if(!this.objects.length)return[this.makeCode("[]")];if(e.indent+=H,t=W.compileSplattedArray(e,this.objects),t.length)return t;for(t=[],n=function(){var t,n,i,r;for(i=this.objects,r=[],t=0,n=i.length;n>t;t++)o=i[t],r.push(o.compileToFragments(e,x));return r}.call(this),r=s=0,a=n.length;a>s;r=++s)i=n[r],r&&t.push(this.makeCode(", ")),t.push.apply(t,i);return it(t).indexOf("\n")>=0?(t.unshift(this.makeCode("[\n"+e.indent)),t.push(this.makeCode("\n"+this.tab+"]"))):(t.unshift(this.makeCode("[")),t.push(this.makeCode("]"))),t},t.prototype.assigns=function(e){var t,n,i,r;for(r=this.objects,n=0,i=r.length;i>n;n++)if(t=r[n],t.assigns(e))return!0;return!1},t}(i),exports.Class=s=function(t){function i(e,t,n){this.variable=e,this.parent=t,this.body=null!=n?n:new r,this.boundFuncs=[],this.body.classBody=!0}return vt(i,t),i.prototype.children=["variable","parent","body"],i.prototype.determineName=function(){var t,n;return this.variable?(t=(n=rt(this.variable.properties))?n instanceof e&&n.name.value:this.variable.base.value,yt.call($,t)>=0&&this.variable.error("class variable name may not be "+t),t&&(t=f.test(t)&&t)):null},i.prototype.setContext=function(e){return this.body.traverseChildren(!1,function(t){return t.classBody?!1:t instanceof S&&"this"===t.value?t.value=e:t instanceof l&&(t.klass=e,t.bound)?t.context=e:void 0})},i.prototype.addBoundFunctions=function(t){var n,i,r,o,s;for(s=this.boundFuncs,r=0,o=s.length;o>r;r++)n=s[r],i=new G(new S("this"),[new e(n)]).compile(t),this.ctor.body.unshift(new S(""+i+" = "+pt("bind")+"("+i+", this)"))},i.prototype.addProperties=function(t,i,r){var o,s,a,c,u;return u=t.base.properties.slice(0),a=function(){var t;for(t=[];o=u.shift();)o instanceof n&&(s=o.variable.base,delete o.context,c=o.value,"constructor"===s.value?(this.ctor&&o.error("cannot define more than one constructor in a class"),c.bound&&o.error("cannot define a constructor as a bound function"),c instanceof l?o=this.ctor=c:(this.externalCtor=r.scope.freeVariable("class"),o=new n(new S(this.externalCtor),c))):o.variable["this"]?(c["static"]=!0,c.bound&&(c.context=i)):(o.variable=new G(new S(i),[new e(new S("prototype")),new e(s)]),c instanceof l&&c.bound&&(this.boundFuncs.push(s),c.bound=!1))),t.push(o);return t}.call(this),Q(a)},i.prototype.walkBody=function(e,t){return this.traverseChildren(!1,function(n){return function(o){var s,a,l,c,u,h,p;if(s=!0,o instanceof i)return!1;if(o instanceof r){for(p=a=o.expressions,l=u=0,h=p.length;h>u;l=++u)c=p[l],c instanceof G&&c.isObject(!0)&&(s=!1,a[l]=n.addProperties(c,e,t));o.expressions=a=nt(a)}return s&&!(o instanceof i)}}(this))},i.prototype.hoistDirectivePrologue=function(){var e,t,n;for(t=0,e=this.body.expressions;(n=e[t])&&n instanceof u||n instanceof G&&n.isString();)++t;return this.directives=e.splice(0,t)},i.prototype.ensureConstructor=function(e,t){var i,r,o;return i=!this.ctor,this.ctor||(this.ctor=new l),this.ctor.ctor=this.ctor.name=e,this.ctor.klass=null,this.ctor.noReturn=!0,i?(this.parent&&(o=new S(""+e+".__super__.constructor.apply(this, arguments)")),this.externalCtor&&(o=new S(""+this.externalCtor+".apply(this, arguments)")),o&&(r=new S(t.scope.freeVariable("ref")),this.ctor.body.unshift(new n(r,o))),this.addBoundFunctions(t),o&&(this.ctor.body.push(r),this.ctor.body.makeReturn()),this.body.expressions.unshift(this.ctor)):this.addBoundFunctions(t)},i.prototype.compileNode=function(e){var t,i,r,o,s,c,u;return i=this.determineName(),s=i||"_Class",s.reserved&&(s="_"+s),o=new S(s),this.hoistDirectivePrologue(),this.setContext(s),this.walkBody(s,e),this.ensureConstructor(s,e),this.body.spaced=!0,this.ctor instanceof l||this.body.expressions.unshift(this.ctor),this.body.expressions.push(o),(u=this.body.expressions).unshift.apply(u,this.directives),t=a.wrap(this.body),this.parent&&(this.superClass=new S(e.scope.freeVariable("super",!1)),this.body.expressions.unshift(new p(o,this.superClass)),t.args.push(this.parent),c=t.variable.params||t.variable.base.params,c.push(new R(this.superClass))),r=new L(t,!0),this.variable&&(r=new n(this.variable,r)),r.compileToFragments(e)},i}(i),exports.Assign=n=function(t){function n(e,t,n,i){var r,o,s;this.variable=e,this.value=t,this.context=n,this.param=i&&i.param,this.subpattern=i&&i.subpattern,s=o=this.variable.unwrapAll().value,r=yt.call($,s)>=0,r&&"object"!==this.context&&this.variable.error('variable name may not be "'+o+'"')}return vt(n,t),n.prototype.children=["variable","value"],n.prototype.isStatement=function(e){return(null!=e?e.level:void 0)===E&&null!=this.context&&yt.call(this.context,"?")>=0},n.prototype.assigns=function(e){return this["object"===this.context?"value":"variable"].assigns(e)},n.prototype.unfoldSoak=function(e){return ht(e,this,"variable")},n.prototype.compileNode=function(e){var t,n,i,r,o,s,a,c,u,h,p;if(i=this.variable instanceof G){if(this.variable.isArray()||this.variable.isObject())return this.compilePatternMatch(e);if(this.variable.isSplice())return this.compileSplice(e);if("||="===(c=this.context)||"&&="===c||"?="===c)return this.compileConditional(e)}return n=this.variable.compileToFragments(e,x),o=it(n),this.context||(a=this.variable.unwrapAll(),a.isAssignable()||this.variable.error('"'+this.variable.compile(e)+'" cannot be assigned'),("function"==typeof a.hasProperties?a.hasProperties():void 0)||(this.param?e.scope.add(o,"var"):e.scope.find(o))),this.value instanceof l&&(r=T.exec(o))&&(r[1]&&(this.value.klass=r[1]),this.value.name=null!=(u=null!=(h=null!=(p=r[2])?p:r[3])?h:r[4])?u:r[5]),s=this.value.compileToFragments(e,x),"object"===this.context?n.concat(this.makeCode(": "),s):(t=n.concat(this.makeCode(" "+(this.context||"=")+" "),s),e.level<=x?t:this.wrapInBraces(t))},n.prototype.compilePatternMatch=function(t){var i,r,o,s,a,l,c,u,h,p,d,m,g,v,y,w,C,_,T,F,k,D,M,R,B,O,I,$;if(w=t.level===E,_=this.value,d=this.variable.base.objects,!(m=d.length))return o=_.compileToFragments(t),t.level>=A?this.wrapInBraces(o):o;if(c=this.variable.isObject(),w&&1===m&&!((p=d[0])instanceof W))return p instanceof n?(M=p,R=M.variable,l=R.base,p=M.value):l=c?p["this"]?p.properties[0].name:p:new S(0),i=f.test(l.unwrap().value||0),_=new G(_),_.properties.push(new(i?e:b)(l)),B=p.unwrap().value,yt.call(N,B)>=0&&p.error("assignment to a reserved word: "+p.compile(t)),new n(p,_,null,{param:this.param}).compileToFragments(t,E);for(T=_.compileToFragments(t,x),F=it(T),r=[],y=!1,(!f.test(F)||this.variable.assigns(F))&&(r.push([this.makeCode(""+(g=t.scope.freeVariable("ref"))+" = ")].concat(bt.call(T))),T=[this.makeCode(g)],F=g),a=k=0,D=d.length;D>k;a=++k)p=d[a],l=a,c&&(p instanceof n?(O=p,I=O.variable,l=I.base,p=O.value):p.base instanceof L?($=new G(p.unwrapAll()).cacheReference(t),p=$[0],l=$[1]):l=p["this"]?p.properties[0].name:p),!y&&p instanceof W?(h=p.name.unwrap().value,p=p.unwrap(),C=""+m+" <= "+F+".length ? "+pt("slice")+".call("+F+", "+a,(v=m-a-1)?(u=t.scope.freeVariable("i"),C+=", "+u+" = "+F+".length - "+v+") : ("+u+" = "+a+", [])"):C+=") : []",C=new S(C),y=""+u+"++"):(h=p.unwrap().value,p instanceof W&&p.error("multiple splats are disallowed in an assignment"),"number"==typeof l?(l=new S(y||l),i=!1):i=c&&f.test(l.unwrap().value||0),C=new G(new S(F),[new(i?e:b)(l)])),null!=h&&yt.call(N,h)>=0&&p.error("assignment to a reserved word: "+p.compile(t)),r.push(new n(p,C,null,{param:this.param,subpattern:!0}).compileToFragments(t,x));return w||this.subpattern||r.push(T),s=this.joinFragmentArrays(r,", "),t.level<x?s:this.wrapInBraces(s)},n.prototype.compileConditional=function(e){var t,i,r;return r=this.variable.cacheReference(e),t=r[0],i=r[1],!t.properties.length&&t.base instanceof S&&"this"!==t.base.value&&!e.scope.check(t.base.value)&&this.variable.error('the variable "'+t.base.value+"\" can't be assigned with "+this.context+" because it has not been declared before"),yt.call(this.context,"?")>=0&&(e.isExistentialEquals=!0),new M(this.context.slice(0,-1),t,new n(i,this.value,"=")).compileToFragments(e)},n.prototype.compileSplice=function(e){var t,n,i,r,o,s,a,l,c,u,h,p;return u=this.variable.properties.pop().range,i=u.from,a=u.to,n=u.exclusive,s=this.variable.compile(e),i?(h=this.cacheToCodeFragments(i.cache(e,A)),r=h[0],o=h[1]):r=o="0",a?(null!=i?i.isSimpleNumber():void 0)&&a.isSimpleNumber()?(a=+a.compile(e)-+o,n||(a+=1)):(a=a.compile(e,w)+" - "+o,n||(a+=" + 1")):a="9e9",p=this.value.cache(e,x),l=p[0],c=p[1],t=[].concat(this.makeCode("[].splice.apply("+s+", ["+r+", "+a+"].concat("),l,this.makeCode(")), "),c),e.level>E?this.wrapInBraces(t):t},n}(i),exports.Code=l=function(e){function i(e,t,n){this.params=e||[],this.body=t||new r,this.bound="boundfunc"===n,this.bound&&(this.context="_this")}return vt(i,e),i.prototype.children=["params","body"],i.prototype.isStatement=function(){return!!this.ctor},i.prototype.jumps=k,i.prototype.compileNode=function(e){var i,r,o,s,a,l,c,u,h,p,d,f,m,g,y,b,C,x,A,_,E,T,F,k,D,R,L,N,B;for(e.scope=new P(e.scope,this.body,this),e.scope.shared=Z(e,"sharedScope"),e.indent+=H,delete e.bare,delete e.isExistentialEquals,h=[],o=[],this.eachParamName(function(t){return e.scope.check(t)?void 0:e.scope.parameter(t)}),D=this.params,y=0,A=D.length;A>y;y++)if(u=D[y],u.splat){for(R=this.params,b=0,_=R.length;_>b;b++)c=R[b].name,c["this"]&&(c=c.properties[0].name),c.value&&e.scope.add(c.value,"var",!0);d=new n(new G(new t(function(){var t,n,i,r;for(i=this.params,r=[],t=0,n=i.length;n>t;t++)c=i[t],r.push(c.asReference(e));return r}.call(this))),new G(new S("arguments")));break}for(L=this.params,C=0,E=L.length;E>C;C++)u=L[C],u.isComplex()?(m=p=u.asReference(e),u.value&&(m=new M("?",p,u.value)),o.push(new n(new G(u.name),m,"=",{param:!0}))):(p=u,u.value&&(l=new S(p.name.value+" == null"),m=new n(new G(u.name),u.value,"="),o.push(new v(l,m)))),d||h.push(p);for(g=this.body.isEmpty(),d&&o.unshift(d),o.length&&(N=this.body.expressions).unshift.apply(N,o),s=x=0,T=h.length;T>x;s=++x)c=h[s],h[s]=c.compileToFragments(e),e.scope.parameter(it(h[s]));for(f=[],this.eachParamName(function(e,t){return yt.call(f,e)>=0&&t.error("multiple parameters named '"+e+"'"),f.push(e)}),g||this.noReturn||this.body.makeReturn(),this.bound&&((null!=(B=e.scope.parent.method)?B.bound:void 0)?this.bound=this.context=e.scope.parent.method.context:this["static"]||e.scope.parent.assign("_this","this")),a=e.indent,r="function",this.ctor&&(r+=" "+this.name),r+="(",i=[this.makeCode(r)],s=k=0,F=h.length;F>k;s=++k)c=h[s],s&&i.push(this.makeCode(", ")),i.push.apply(i,c);return i.push(this.makeCode(") {")),this.body.isEmpty()||(i=i.concat(this.makeCode("\n"),this.body.compileWithDeclarations(e),this.makeCode("\n"+this.tab))),i.push(this.makeCode("}")),this.ctor?[this.makeCode(this.tab)].concat(bt.call(i)):this.front||e.level>=w?this.wrapInBraces(i):i},i.prototype.eachParamName=function(e){var t,n,i,r,o;for(r=this.params,o=[],n=0,i=r.length;i>n;n++)t=r[n],o.push(t.eachName(e));
return o},i.prototype.traverseChildren=function(e,t){return e?i.__super__.traverseChildren.call(this,e,t):void 0},i}(i),exports.Param=R=function(e){function t(e,t,n){var i;this.name=e,this.value=t,this.splat=n,i=e=this.name.unwrapAll().value,yt.call($,i)>=0&&this.name.error('parameter name "'+e+'" is not allowed')}return vt(t,e),t.prototype.children=["name","value"],t.prototype.compileToFragments=function(e){return this.name.compileToFragments(e,x)},t.prototype.asReference=function(e){var t;return this.reference?this.reference:(t=this.name,t["this"]?(t=t.properties[0].name,t.value.reserved&&(t=new S(e.scope.freeVariable(t.value)))):t.isComplex()&&(t=new S(e.scope.freeVariable("arg"))),t=new G(t),this.splat&&(t=new W(t)),this.reference=t)},t.prototype.isComplex=function(){return this.name.isComplex()},t.prototype.eachName=function(e,t){var i,r,o,s,a,l;if(null==t&&(t=this.name),i=function(t){var n;return n=t.properties[0].name,n.value.reserved?void 0:e(n.value,n)},t instanceof S)return e(t.value,t);if(t instanceof G)return i(t);for(l=t.objects,s=0,a=l.length;a>s;s++)o=l[s],o instanceof n?this.eachName(e,o.value.unwrap()):o instanceof W?(r=o.name.unwrap(),e(r.value,r)):o instanceof G?o.isArray()||o.isObject()?this.eachName(e,o.base):o["this"]?i(o):e(o.base.value,o.base):o.error("illegal parameter "+o.compile())},t}(i),exports.Splat=W=function(e){function t(e){this.name=e.compile?e:new S(e)}return vt(t,e),t.prototype.children=["name"],t.prototype.isAssignable=Y,t.prototype.assigns=function(e){return this.name.assigns(e)},t.prototype.compileToFragments=function(e){return this.name.compileToFragments(e)},t.prototype.unwrap=function(){return this.name},t.compileSplattedArray=function(e,n,i){var r,o,s,a,l,c,u,h,p,d;for(u=-1;(h=n[++u])&&!(h instanceof t););if(u>=n.length)return[];if(1===n.length)return h=n[0],l=h.compileToFragments(e,x),i?l:[].concat(h.makeCode(""+pt("slice")+".call("),l,h.makeCode(")"));for(r=n.slice(u),c=p=0,d=r.length;d>p;c=++p)h=r[c],s=h.compileToFragments(e,x),r[c]=h instanceof t?[].concat(h.makeCode(""+pt("slice")+".call("),s,h.makeCode(")")):[].concat(h.makeCode("["),s,h.makeCode("]"));return 0===u?(h=n[0],a=h.joinFragmentArrays(r.slice(1),", "),r[0].concat(h.makeCode(".concat("),a,h.makeCode(")"))):(o=function(){var t,i,r,o;for(r=n.slice(0,u),o=[],t=0,i=r.length;i>t;t++)h=r[t],o.push(h.compileToFragments(e,x));return o}(),o=n[0].joinFragmentArrays(o,", "),a=n[u].joinFragmentArrays(r,", "),[].concat(n[0].makeCode("["),o,n[u].makeCode("].concat("),a,rt(n).makeCode(")")))},t}(i),exports.While=J=function(e){function t(e,t){this.condition=(null!=t?t.invert:void 0)?e.invert():e,this.guard=null!=t?t.guard:void 0}return vt(t,e),t.prototype.children=["condition","guard","body"],t.prototype.isStatement=Y,t.prototype.makeReturn=function(e){return e?t.__super__.makeReturn.apply(this,arguments):(this.returns=!this.jumps({loop:!0}),this)},t.prototype.addBody=function(e){return this.body=e,this},t.prototype.jumps=function(){var e,t,n,i;if(e=this.body.expressions,!e.length)return!1;for(n=0,i=e.length;i>n;n++)if(t=e[n],t.jumps({loop:!0}))return t;return!1},t.prototype.compileNode=function(e){var t,n,i,o;return e.indent+=H,o="",n=this.body,n.isEmpty()?n=this.makeCode(""):(this.returns&&(n.makeReturn(i=e.scope.freeVariable("results")),o=""+this.tab+i+" = [];\n"),this.guard&&(n.expressions.length>1?n.expressions.unshift(new v(new L(this.guard).invert(),new S("continue"))):this.guard&&(n=r.wrap([new v(this.guard,n)]))),n=[].concat(this.makeCode("\n"),n.compileToFragments(e,E),this.makeCode("\n"+this.tab))),t=[].concat(this.makeCode(o+this.tab+"while ("),this.condition.compileToFragments(e,_),this.makeCode(") {"),n,this.makeCode("}")),this.returns&&t.push(this.makeCode("\n"+this.tab+"return "+i+";")),t},t}(i),exports.Op=M=function(e){function t(e,t,n,r){if("in"===e)return new y(t,n);if("do"===e)return this.generateDo(t);if("new"===e){if(t instanceof o&&!t["do"]&&!t.isNew)return t.newInstance();(t instanceof l&&t.bound||t["do"])&&(t=new L(t))}return this.operator=i[e]||e,this.first=t,this.second=n,this.flip=!!r,this}var i,r;return vt(t,e),i={"==":"===","!=":"!==",of:"in"},r={"!==":"===","===":"!=="},t.prototype.children=["first","second"],t.prototype.isSimpleNumber=k,t.prototype.isUnary=function(){return!this.second},t.prototype.isComplex=function(){var e;return!(this.isUnary()&&("+"===(e=this.operator)||"-"===e))||this.first.isComplex()},t.prototype.isChainable=function(){var e;return"<"===(e=this.operator)||">"===e||">="===e||"<="===e||"==="===e||"!=="===e},t.prototype.invert=function(){var e,n,i,o,s;if(this.isChainable()&&this.first.isChainable()){for(e=!0,n=this;n&&n.operator;)e&&(e=n.operator in r),n=n.first;if(!e)return new L(this).invert();for(n=this;n&&n.operator;)n.invert=!n.invert,n.operator=r[n.operator],n=n.first;return this}return(o=r[this.operator])?(this.operator=o,this.first.unwrap()instanceof t&&this.first.invert(),this):this.second?new L(this).invert():"!"===this.operator&&(i=this.first.unwrap())instanceof t&&("!"===(s=i.operator)||"in"===s||"instanceof"===s)?i:new t("!",this)},t.prototype.unfoldSoak=function(e){var t;return("++"===(t=this.operator)||"--"===t||"delete"===t)&&ht(e,this,"first")},t.prototype.generateDo=function(e){var t,i,r,s,a,c,u,h;for(s=[],i=e instanceof n&&(a=e.value.unwrap())instanceof l?a:e,h=i.params||[],c=0,u=h.length;u>c;c++)r=h[c],r.value?(s.push(r.value),delete r.value):s.push(r);return t=new o(e,s),t["do"]=!0,t},t.prototype.compileNode=function(e){var t,n,i,r;return n=this.isChainable()&&this.first.isChainable(),n||(this.first.front=this.front),"delete"===this.operator&&e.scope.check(this.first.unwrapAll().value)&&this.error("delete operand may not be argument or var"),("--"===(i=this.operator)||"++"===i)&&(r=this.first.unwrapAll().value,yt.call($,r)>=0)&&this.error('cannot increment/decrement "'+this.first.unwrapAll().value+'"'),this.isUnary()?this.compileUnary(e):n?this.compileChain(e):"?"===this.operator?this.compileExistence(e):(t=[].concat(this.first.compileToFragments(e,A),this.makeCode(" "+this.operator+" "),this.second.compileToFragments(e,A)),e.level<=A?t:this.wrapInBraces(t))},t.prototype.compileChain=function(e){var t,n,i,r;return r=this.first.second.cache(e),this.first.second=r[0],i=r[1],n=this.first.compileToFragments(e,A),t=n.concat(this.makeCode(" "+(this.invert?"&&":"||")+" "),i.compileToFragments(e),this.makeCode(" "+this.operator+" "),this.second.compileToFragments(e,A)),this.wrapInBraces(t)},t.prototype.compileExistence=function(e){var t,i;return!e.isExistentialEquals&&this.first.isComplex()?(i=new S(e.scope.freeVariable("ref")),t=new L(new n(i,this.first))):(t=this.first,i=t),new v(new h(t),i,{type:"if"}).addElse(this.second).compileToFragments(e)},t.prototype.compileUnary=function(e){var n,i,r;return i=[],n=this.operator,i.push([this.makeCode(n)]),"!"===n&&this.first instanceof h?(this.first.negated=!this.first.negated,this.first.compileToFragments(e)):e.level>=w?new L(this).compileToFragments(e):(r="+"===n||"-"===n,("new"===n||"typeof"===n||"delete"===n||r&&this.first instanceof t&&this.first.operator===n)&&i.push([this.makeCode(" ")]),(r&&this.first instanceof t||"new"===n&&this.first.isStatement(e))&&(this.first=new L(this.first)),i.push(this.first.compileToFragments(e,A)),this.flip&&i.reverse(),this.joinFragmentArrays(i,""))},t.prototype.toString=function(e){return t.__super__.toString.call(this,e,this.constructor.name+" "+this.operator)},t}(i),exports.In=y=function(e){function t(e,t){this.object=e,this.array=t}return vt(t,e),t.prototype.children=["object","array"],t.prototype.invert=F,t.prototype.compileNode=function(e){var t,n,i,r,o;if(this.array instanceof G&&this.array.isArray()){for(o=this.array.base.objects,i=0,r=o.length;r>i;i++)if(n=o[i],n instanceof W){t=!0;break}if(!t)return this.compileOrTest(e)}return this.compileLoopTest(e)},t.prototype.compileOrTest=function(e){var t,n,i,r,o,s,a,l,c,u,h,p;if(0===this.array.base.objects.length)return[this.makeCode(""+!!this.negated)];for(u=this.object.cache(e,A),s=u[0],o=u[1],h=this.negated?[" !== "," && "]:[" === "," || "],t=h[0],n=h[1],a=[],p=this.array.base.objects,i=l=0,c=p.length;c>l;i=++l)r=p[i],i&&a.push(this.makeCode(n)),a=a.concat(i?o:s,this.makeCode(t),r.compileToFragments(e,w));return e.level<A?a:this.wrapInBraces(a)},t.prototype.compileLoopTest=function(e){var t,n,i,r;return r=this.object.cache(e,x),i=r[0],n=r[1],t=[].concat(this.makeCode(pt("indexOf")+".call("),this.array.compileToFragments(e,x),this.makeCode(", "),n,this.makeCode(") "+(this.negated?"< 0":">= 0"))),it(i)===it(n)?t:(t=i.concat(this.makeCode(", "),t),e.level<x?t:this.wrapInBraces(t))},t.prototype.toString=function(e){return t.__super__.toString.call(this,e,this.constructor.name+(this.negated?"!":""))},t}(i),exports.Try=V=function(e){function t(e,t,n,i){this.attempt=e,this.errorVariable=t,this.recovery=n,this.ensure=i}return vt(t,e),t.prototype.children=["attempt","recovery","ensure"],t.prototype.isStatement=Y,t.prototype.jumps=function(e){var t;return this.attempt.jumps(e)||(null!=(t=this.recovery)?t.jumps(e):void 0)},t.prototype.makeReturn=function(e){return this.attempt&&(this.attempt=this.attempt.makeReturn(e)),this.recovery&&(this.recovery=this.recovery.makeReturn(e)),this},t.prototype.compileNode=function(e){var t,i,r,o;return e.indent+=H,o=this.attempt.compileToFragments(e,E),t=this.recovery?(r=new S("_error"),this.errorVariable?this.recovery.unshift(new n(this.errorVariable,r)):void 0,[].concat(this.makeCode(" catch ("),r.compileToFragments(e),this.makeCode(") {\n"),this.recovery.compileToFragments(e,E),this.makeCode("\n"+this.tab+"}"))):this.ensure||this.recovery?[]:[this.makeCode(" catch (_error) {}")],i=this.ensure?[].concat(this.makeCode(" finally {\n"),this.ensure.compileToFragments(e,E),this.makeCode("\n"+this.tab+"}")):[],[].concat(this.makeCode(""+this.tab+"try {\n"),o,this.makeCode("\n"+this.tab+"}"),t,i)},t}(i),exports.Throw=U=function(e){function t(e){this.expression=e}return vt(t,e),t.prototype.children=["expression"],t.prototype.isStatement=Y,t.prototype.jumps=k,t.prototype.makeReturn=q,t.prototype.compileNode=function(e){return[].concat(this.makeCode(this.tab+"throw "),this.expression.compileToFragments(e),this.makeCode(";"))},t}(i),exports.Existence=h=function(e){function t(e){this.expression=e}return vt(t,e),t.prototype.children=["expression"],t.prototype.invert=F,t.prototype.compileNode=function(e){var t,n,i,r;return this.expression.front=this.front,i=this.expression.compile(e,A),f.test(i)&&!e.scope.check(i)?(r=this.negated?["===","||"]:["!==","&&"],t=r[0],n=r[1],i="typeof "+i+" "+t+' "undefined" '+n+" "+i+" "+t+" null"):i=""+i+" "+(this.negated?"==":"!=")+" null",[this.makeCode(e.level<=C?i:"("+i+")")]},t}(i),exports.Parens=L=function(e){function t(e){this.body=e}return vt(t,e),t.prototype.children=["body"],t.prototype.unwrap=function(){return this.body},t.prototype.isComplex=function(){return this.body.isComplex()},t.prototype.compileNode=function(e){var t,n,i;return n=this.body.unwrap(),n instanceof G&&n.isAtomic()?(n.front=this.front,n.compileToFragments(e)):(i=n.compileToFragments(e,_),t=e.level<A&&(n instanceof M||n instanceof o||n instanceof d&&n.returns),t?i:this.wrapInBraces(i))},t}(i),exports.For=d=function(e){function t(e,t){var n;this.source=t.source,this.guard=t.guard,this.step=t.step,this.name=t.name,this.index=t.index,this.body=r.wrap([e]),this.own=!!t.own,this.object=!!t.object,this.object&&(n=[this.index,this.name],this.name=n[0],this.index=n[1]),this.index instanceof G&&this.index.error("index cannot be a pattern matching expression"),this.range=this.source instanceof G&&this.source.base instanceof B&&!this.source.properties.length,this.pattern=this.name instanceof G,this.range&&this.index&&this.index.error("indexes do not apply to range loops"),this.range&&this.pattern&&this.name.error("cannot pattern match over range loops"),this.own&&!this.object&&this.index.error("cannot use own with for-in"),this.returns=!1}return vt(t,e),t.prototype.children=["body","source","guard","step"],t.prototype.compileNode=function(e){var t,i,o,s,a,l,c,u,h,p,d,m,g,y,b,w,C,A,_,T,F,k,D,M,R,N,B,$,P,j,W,z,q,U;return t=r.wrap([this.body]),A=null!=(q=rt(t.expressions))?q.jumps():void 0,A&&A instanceof O&&(this.returns=!1),B=this.range?this.source.base:this.source,N=e.scope,T=this.name&&this.name.compile(e,x),y=this.index&&this.index.compile(e,x),T&&!this.pattern&&N.find(T),y&&N.find(y),this.returns&&(R=N.freeVariable("results")),b=this.object&&y||N.freeVariable("i"),w=this.range&&T||y||b,C=w!==b?""+w+" = ":"",this.step&&!this.range&&(U=this.cacheToCodeFragments(this.step.cache(e,x)),$=U[0],j=U[1],P=j.match(I)),this.pattern&&(T=b),z="",d="",c="",m=this.tab+H,this.range?p=B.compileToFragments(st(e,{index:b,name:T,step:this.step})):(W=this.source.compile(e,x),!T&&!this.own||f.test(W)||(c+=""+this.tab+(k=N.freeVariable("ref"))+" = "+W+";\n",W=k),T&&!this.pattern&&(F=""+T+" = "+W+"["+w+"]"),this.object||($!==j&&(c+=""+this.tab+$+";\n"),this.step&&P&&(h=0>+P)||(_=N.freeVariable("len")),a=""+C+b+" = 0, "+_+" = "+W+".length",l=""+C+b+" = "+W+".length - 1",o=""+b+" < "+_,s=""+b+" >= 0",this.step?(P?h&&(o=s,a=l):(o=""+j+" > 0 ? "+o+" : "+s,a="("+j+" > 0 ? ("+a+") : "+l+")"),g=""+b+" += "+j):g=""+(w!==b?"++"+b:""+b+"++"),p=[this.makeCode(""+a+"; "+o+"; "+C+g)])),this.returns&&(D=""+this.tab+R+" = [];\n",M="\n"+this.tab+"return "+R+";",t.makeReturn(R)),this.guard&&(t.expressions.length>1?t.expressions.unshift(new v(new L(this.guard).invert(),new S("continue"))):this.guard&&(t=r.wrap([new v(this.guard,t)]))),this.pattern&&t.expressions.unshift(new n(this.name,new S(""+W+"["+w+"]"))),u=[].concat(this.makeCode(c),this.pluckDirectCall(e,t)),F&&(z="\n"+m+F+";"),this.object&&(p=[this.makeCode(""+w+" in "+W)],this.own&&(d="\n"+m+"if (!"+pt("hasProp")+".call("+W+", "+w+")) continue;")),i=t.compileToFragments(st(e,{indent:m}),E),i&&i.length>0&&(i=[].concat(this.makeCode("\n"),i,this.makeCode("\n"))),[].concat(u,this.makeCode(""+(D||"")+this.tab+"for ("),p,this.makeCode(") {"+d+z),i,this.makeCode(""+this.tab+"}"+(M||"")))},t.prototype.pluckDirectCall=function(e,t){var i,r,s,a,c,u,h,p,d,f,m,g,v,y,b;for(r=[],f=t.expressions,c=p=0,d=f.length;d>p;c=++p)s=f[c],s=s.unwrapAll(),s instanceof o&&(h=s.variable.unwrapAll(),(h instanceof l||h instanceof G&&(null!=(m=h.base)?m.unwrapAll():void 0)instanceof l&&1===h.properties.length&&("call"===(g=null!=(v=h.properties[0].name)?v.value:void 0)||"apply"===g))&&(a=(null!=(y=h.base)?y.unwrapAll():void 0)||h,u=new S(e.scope.freeVariable("fn")),i=new G(u),h.base&&(b=[i,h],h.base=b[0],i=b[1]),t.expressions[c]=new o(i,s.args),r=r.concat(this.makeCode(this.tab),new n(u,a).compileToFragments(e,E),this.makeCode(";\n"))));return r},t}(J),exports.Switch=z=function(e){function t(e,t,n){this.subject=e,this.cases=t,this.otherwise=n}return vt(t,e),t.prototype.children=["subject","cases","otherwise"],t.prototype.isStatement=Y,t.prototype.jumps=function(e){var t,n,i,r,o,s,a;for(null==e&&(e={block:!0}),o=this.cases,i=0,r=o.length;r>i;i++)if(s=o[i],n=s[0],t=s[1],t.jumps(e))return t;return null!=(a=this.otherwise)?a.jumps(e):void 0},t.prototype.makeReturn=function(e){var t,n,i,o,s;for(o=this.cases,n=0,i=o.length;i>n;n++)t=o[n],t[1].makeReturn(e);return e&&(this.otherwise||(this.otherwise=new r([new S("void 0")]))),null!=(s=this.otherwise)&&s.makeReturn(e),this},t.prototype.compileNode=function(e){var t,n,i,r,o,s,a,l,c,u,h,p,d,f,m,g;for(l=e.indent+H,c=e.indent=l+H,s=[].concat(this.makeCode(this.tab+"switch ("),this.subject?this.subject.compileToFragments(e,_):this.makeCode("false"),this.makeCode(") {\n")),f=this.cases,a=u=0,p=f.length;p>u;a=++u){for(m=f[a],r=m[0],t=m[1],g=nt([r]),h=0,d=g.length;d>h;h++)i=g[h],this.subject||(i=i.invert()),s=s.concat(this.makeCode(l+"case "),i.compileToFragments(e,_),this.makeCode(":\n"));if((n=t.compileToFragments(e,E)).length>0&&(s=s.concat(n,this.makeCode("\n"))),a===this.cases.length-1&&!this.otherwise)break;o=this.lastNonComment(t.expressions),o instanceof O||o instanceof S&&o.jumps()&&"debugger"!==o.value||s.push(i.makeCode(c+"break;\n"))}return this.otherwise&&this.otherwise.expressions.length&&s.push.apply(s,[this.makeCode(l+"default:\n")].concat(bt.call(this.otherwise.compileToFragments(e,E)),[this.makeCode("\n")])),s.push(this.makeCode(this.tab+"}")),s},t}(i),exports.If=v=function(e){function t(e,t,n){this.body=t,null==n&&(n={}),this.condition="unless"===n.type?e.invert():e,this.elseBody=null,this.isChain=!1,this.soak=n.soak}return vt(t,e),t.prototype.children=["condition","body","elseBody"],t.prototype.bodyNode=function(){var e;return null!=(e=this.body)?e.unwrap():void 0},t.prototype.elseBodyNode=function(){var e;return null!=(e=this.elseBody)?e.unwrap():void 0},t.prototype.addElse=function(e){return this.isChain?this.elseBodyNode().addElse(e):(this.isChain=e instanceof t,this.elseBody=this.ensureBlock(e)),this},t.prototype.isStatement=function(e){var t;return(null!=e?e.level:void 0)===E||this.bodyNode().isStatement(e)||(null!=(t=this.elseBodyNode())?t.isStatement(e):void 0)},t.prototype.jumps=function(e){var t;return this.body.jumps(e)||(null!=(t=this.elseBody)?t.jumps(e):void 0)},t.prototype.compileNode=function(e){return this.isStatement(e)?this.compileStatement(e):this.compileExpression(e)},t.prototype.makeReturn=function(e){return e&&(this.elseBody||(this.elseBody=new r([new S("void 0")]))),this.body&&(this.body=new r([this.body.makeReturn(e)])),this.elseBody&&(this.elseBody=new r([this.elseBody.makeReturn(e)])),this},t.prototype.ensureBlock=function(e){return e instanceof r?e:new r([e])},t.prototype.compileStatement=function(e){var n,i,r,o,s,a,l;return r=Z(e,"chainChild"),(s=Z(e,"isExistentialEquals"))?new t(this.condition.invert(),this.elseBodyNode(),{type:"if"}).compileToFragments(e):(l=e.indent+H,o=this.condition.compileToFragments(e,_),i=this.ensureBlock(this.body).compileToFragments(st(e,{indent:l})),a=[].concat(this.makeCode("if ("),o,this.makeCode(") {\n"),i,this.makeCode("\n"+this.tab+"}")),r||a.unshift(this.makeCode(this.tab)),this.elseBody?(n=a.concat(this.makeCode(" else ")),this.isChain?(e.chainChild=!0,n=n.concat(this.elseBody.unwrap().compileToFragments(e,E))):n=n.concat(this.makeCode("{\n"),this.elseBody.compileToFragments(st(e,{indent:l}),E),this.makeCode("\n"+this.tab+"}")),n):a)},t.prototype.compileExpression=function(e){var t,n,i,r;return i=this.condition.compileToFragments(e,C),n=this.bodyNode().compileToFragments(e,x),t=this.elseBodyNode()?this.elseBodyNode().compileToFragments(e,x):[this.makeCode("void 0")],r=i.concat(this.makeCode(" ? "),n,this.makeCode(" : "),t),e.level>=C?this.wrapInBraces(r):r},t.prototype.unfoldSoak=function(){return this.soak&&this},t}(i),a={wrap:function(t,n,i){var s,a,c,u,h;return t.jumps()?t:(u=new l([],r.wrap([t])),s=[],a=t.contains(this.isLiteralArguments),a&&t.classBody&&a.error("Class bodies shouldn't reference arguments"),(a||t.contains(this.isLiteralThis))&&(h=new S(a?"apply":"call"),s=[new S("this")],a&&s.push(new S("arguments")),u=new G(u,[new e(h)])),u.noReturn=i,c=new o(u,s),n?r.wrap([c]):c)},isLiteralArguments:function(e){return e instanceof S&&"arguments"===e.value&&!e.asKey},isLiteralThis:function(e){return e instanceof S&&"this"===e.value&&!e.asKey||e instanceof l&&e.bound||e instanceof o&&e.isSuper}},ht=function(e,t,n){var i;if(i=t[n].unfoldSoak(e))return t[n]=i.body,i.body=new G(t),i},K={"extends":function(){return"function(child, parent) { for (var key in parent) { if ("+pt("hasProp")+".call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; }"},bind:function(){return"function(fn, me){ return function(){ return fn.apply(me, arguments); }; }"},indexOf:function(){return"[].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; }"},hasProp:function(){return"{}.hasOwnProperty"},slice:function(){return"[].slice"}},E=1,_=2,x=3,C=4,A=5,w=6,H="  ",m="[$A-Za-z_\\x7f-\\uffff][$\\w\\x7f-\\uffff]*",f=RegExp("^"+m+"$"),I=/^[+-]?\d+$/,T=RegExp("^(?:("+m+")\\.prototype(?:\\.("+m+")|\\[(\"(?:[^\\\\\"\\r\\n]|\\\\.)*\"|'(?:[^\\\\'\\r\\n]|\\\\.)*')\\]|\\[(0x[\\da-fA-F]+|\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\]))|("+m+")$"),g=/^['"]/,pt=function(e){var t;return t="__"+e,P.root.assign(t,K[e]()),t},at=function(e,t){return e=e.replace(/\n/g,"$&"+t),e.replace(/\s+$/,"")}});