define(function(require,exports,module){var e,t,n,i,r,o,s,a,l,c,u,h,p,d,f,m,g,v,y=module.uri||"",b=(y.substring(0,y.lastIndexOf("/")+1),[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1}),w=[].slice;for(p=function(e,t){var n;return n=[e,t],n.generated=!0,n},exports.Rewriter=function(){function e(){}return e.prototype.rewrite=function(e){return this.tokens=e,this.removeLeadingNewlines(),this.removeMidExpressionNewlines(),this.closeOpenCalls(),this.closeOpenIndexes(),this.addImplicitIndentation(),this.tagPostfixConditionals(),this.addImplicitBracesAndParens(),this.addLocationDataToGeneratedTokens(),this.tokens},e.prototype.scanTokens=function(e){var t,n,i;for(i=this.tokens,t=0;n=i[t];)t+=e.call(this,n,t,i);return!0},e.prototype.detectEnd=function(e,t,r){var o,s,a,l,c;for(a=this.tokens,o=0;s=a[e];){if(0===o&&t.call(this,s,e))return r.call(this,s,e);if(!s||0>o)return r.call(this,s,e-1);l=s[0],b.call(i,l)>=0?o+=1:(c=s[0],b.call(n,c)>=0&&(o-=1)),e+=1}return e-1},e.prototype.removeLeadingNewlines=function(){var e,t,n,i,r;for(r=this.tokens,e=n=0,i=r.length;i>n&&(t=r[e][0],"TERMINATOR"===t);e=++n);return e?this.tokens.splice(0,e):void 0},e.prototype.removeMidExpressionNewlines=function(){return this.scanTokens(function(e,n,i){var r;return"TERMINATOR"===e[0]&&(r=this.tag(n+1),b.call(t,r)>=0)?(i.splice(n,1),0):1})},e.prototype.closeOpenCalls=function(){var e,t;return t=function(e,t){var n;return")"===(n=e[0])||"CALL_END"===n||"OUTDENT"===e[0]&&")"===this.tag(t-1)},e=function(e,t){return this.tokens["OUTDENT"===e[0]?t-1:t][0]="CALL_END"},this.scanTokens(function(n,i){return"CALL_START"===n[0]&&this.detectEnd(i+1,t,e),1})},e.prototype.closeOpenIndexes=function(){var e,t;return t=function(e){var t;return"]"===(t=e[0])||"INDEX_END"===t},e=function(e){return e[0]="INDEX_END"},this.scanTokens(function(n,i){return"INDEX_START"===n[0]&&this.detectEnd(i+1,t,e),1})},e.prototype.matchTags=function(){var e,t,n,i,r,o,s;for(t=arguments[0],i=2<=arguments.length?w.call(arguments,1):[],e=0,n=r=0,o=i.length;o>=0?o>r:r>o;n=o>=0?++r:--r){for(;"HERECOMMENT"===this.tag(t+n+e);)e+=2;if(null!=i[n]&&("string"==typeof i[n]&&(i[n]=[i[n]]),s=this.tag(t+n+e),b.call(i[n],s)<0))return!1}return!0},e.prototype.looksObjectish=function(e){return this.matchTags(e,"@",null,":")||this.matchTags(e,null,":")},e.prototype.findTagsBackwards=function(e,t){var r,o,s,a,l,u,h;for(r=[];e>=0&&(r.length||(a=this.tag(e),b.call(t,a)<0&&(l=this.tag(e),b.call(i,l)<0||this.tokens[e].generated)&&(u=this.tag(e),b.call(c,u)<0)));)o=this.tag(e),b.call(n,o)>=0&&r.push(this.tag(e)),s=this.tag(e),b.call(i,s)>=0&&r.length&&r.pop(),e-=1;return h=this.tag(e),b.call(t,h)>=0},e.prototype.addImplicitBracesAndParens=function(){var e;return e=[],this.scanTokens(function(t,l,u){var h,d,f,m,g,v,y,w,C,x,A,E,_,S,T,F,k,D,M,R,L,N,O,B,I,$;if(R=t[0],x=(l>0?u[l-1]:[])[0],w=(l<u.length-1?u[l+1]:[])[0],T=function(){return e[e.length-1]},F=l,f=function(e){return l-F+e},m=function(){var e,t;return null!=(e=T())&&null!=(t=e[2])?t.ours:void 0},g=function(){var e;return m()&&"("===(null!=(e=T())?e[0]:void 0)},y=function(){var e;return m()&&"{"===(null!=(e=T())?e[0]:void 0)},v=function(){var e;return m&&"CONTROL"===(null!=(e=T())?e[0]:void 0)},k=function(t){var n;return n=null!=t?t:l,e.push(["(",n,{ours:!0}]),u.splice(n,0,p("CALL_START","(")),null==t?l+=1:void 0},h=function(){return e.pop(),u.splice(l,0,p("CALL_END",")")),l+=1},D=function(t,n){var i;return null==n&&(n=!0),i=null!=t?t:l,e.push(["{",i,{sameLine:!0,startsLine:n,ours:!0}]),u.splice(i,0,p("{",p(new String("{")))),null==t?l+=1:void 0},d=function(t){return t=null!=t?t:l,e.pop(),u.splice(t,0,p("}","}")),l+=1},g()&&("IF"===R||"TRY"===R||"FINALLY"===R||"CATCH"===R||"CLASS"===R||"SWITCH"===R))return e.push(["CONTROL",l,{ours:!0}]),f(1);if("INDENT"===R&&m()){if("=>"!==x&&"->"!==x&&"["!==x&&"("!==x&&","!==x&&"{"!==x&&"TRY"!==x&&"ELSE"!==x&&"="!==x)for(;g();)h();return v()&&e.pop(),e.push([R,l]),f(1)}if(b.call(i,R)>=0)return e.push([R,l]),f(1);if(b.call(n,R)>=0){for(;m();)g()?h():y()?d():e.pop();e.pop()}if((b.call(s,R)>=0&&t.spaced&&!t.stringEnd||"?"===R&&l>0&&!u[l-1].spaced)&&(b.call(r,w)>=0||b.call(a,w)>=0&&!(null!=(L=u[l+1])?L.spaced:void 0)&&!(null!=(N=u[l+1])?N.newLine:void 0)))return"?"===R&&(R=t[0]="FUNC_EXIST"),k(l+1),f(2);if(b.call(s,R)>=0&&this.matchTags(l+1,"INDENT",null,":")&&!this.findTagsBackwards(l,["CLASS","EXTENDS","IF","CATCH","SWITCH","LEADING_WHEN","FOR","WHILE","UNTIL"]))return k(l+1),e.push(["INDENT",l+2]),f(3);if(":"===R){for(A="@"===this.tag(l-2)?l-2:l-1;"HERECOMMENT"===this.tag(A-2);)A-=2;return M=0===A||(O=this.tag(A-1),b.call(c,O)>=0)||u[A-1].newLine,T()&&(B=T(),S=B[0],_=B[1],("{"===S||"INDENT"===S&&"{"===this.tag(_-1))&&(M||","===this.tag(A-1)||"{"===this.tag(A-1)))?f(1):(D(A,!!M),f(2))}if("OUTDENT"===x&&g()&&("."===R||"?."===R||"::"===R||"?::"===R))return h(),f(1);if(y()&&b.call(c,R)>=0&&(T()[2].sameLine=!1),b.call(o,R)>=0)for(;m();)if(I=T(),S=I[0],_=I[1],$=I[2],E=$.sameLine,M=$.startsLine,g()&&","!==x)h();else if(y()&&E&&!M)d();else{if(!y()||"TERMINATOR"!==R||","===x||M&&this.looksObjectish(l+1))break;d()}if(","===R&&!this.looksObjectish(l+1)&&y()&&("TERMINATOR"!==w||!this.looksObjectish(l+2)))for(C="OUTDENT"===w?1:0;y();)d(l+C);return f(1)})},e.prototype.addLocationDataToGeneratedTokens=function(){return this.scanTokens(function(e,t,n){var i,r,o,s,a,l;return e[2]?1:e.generated||e.explicit?("{"===e[0]&&(o=null!=(a=n[t+1])?a[2]:void 0)?(r=o.first_line,i=o.first_column):(s=null!=(l=n[t-1])?l[2]:void 0)?(r=s.last_line,i=s.last_column):r=i=0,e[2]={first_line:r,first_column:i,last_line:r,last_column:i},1):1})},e.prototype.addImplicitIndentation=function(){var e,t,n,i,r;return r=n=i=null,t=function(e){var t,n;return";"!==e[1]&&(t=e[0],b.call(u,t)>=0)&&!("ELSE"===e[0]&&"THEN"!==r)&&!!("CATCH"!==(n=e[0])&&"FINALLY"!==n||"->"!==r&&"=>"!==r)},e=function(e,t){return this.tokens.splice(","===this.tag(t-1)?t-1:t,0,i)},this.scanTokens(function(o,s,a){var l,c,u,p,d;if(c=o[0],"TERMINATOR"===c&&"THEN"===this.tag(s+1))return a.splice(s,1),0;if("ELSE"===c&&"OUTDENT"!==this.tag(s-1))return a.splice.apply(a,[s,0].concat(w.call(this.indentation()))),2;if("CATCH"===c)for(l=u=1;2>=u;l=++u)if("OUTDENT"===(p=this.tag(s+l))||"TERMINATOR"===p||"FINALLY"===p)return a.splice.apply(a,[s+l,0].concat(w.call(this.indentation()))),2+l;return b.call(h,c)>=0&&"INDENT"!==this.tag(s+1)&&("ELSE"!==c||"IF"!==this.tag(s+1))?(r=c,d=this.indentation(!0),n=d[0],i=d[1],"THEN"===r&&(n.fromThen=!0),a.splice(s+1,0,n),this.detectEnd(s+2,t,e),"THEN"===c&&a.splice(s,1),1):1})},e.prototype.tagPostfixConditionals=function(){var e,t,n;return n=null,t=function(e,t){var n,i;return i=e[0],n=this.tokens[t-1][0],"TERMINATOR"===i||"INDENT"===i&&b.call(h,n)<0},e=function(e){return"INDENT"!==e[0]||e.generated&&!e.fromThen?n[0]="POST_"+n[0]:void 0},this.scanTokens(function(i,r){return"IF"!==i[0]?1:(n=i,this.detectEnd(r+1,t,e),1)})},e.prototype.indentation=function(e){var t,n;return null==e&&(e=!1),t=["INDENT",2],n=["OUTDENT",2],e&&(t.generated=n.generated=!0),e||(t.explicit=n.explicit=!0),[t,n]},e.prototype.generate=p,e.prototype.tag=function(e){var t;return null!=(t=this.tokens[e])?t[0]:void 0},e}(),e=[["(",")"],["[","]"],["{","}"],["INDENT","OUTDENT"],["CALL_START","CALL_END"],["PARAM_START","PARAM_END"],["INDEX_START","INDEX_END"]],exports.INVERSES=l={},i=[],n=[],m=0,g=e.length;g>m;m++)v=e[m],d=v[0],f=v[1],i.push(l[f]=d),n.push(l[d]=f);t=["CATCH","WHEN","ELSE","FINALLY"].concat(n),s=["IDENTIFIER","SUPER",")","CALL_END","]","INDEX_END","@","THIS"],r=["IDENTIFIER","NUMBER","STRING","JS","REGEX","NEW","PARAM_START","CLASS","IF","TRY","SWITCH","THIS","BOOL","NULL","UNDEFINED","UNARY","SUPER","THROW","@","->","=>","[","(","{","--","++"],a=["+","-"],o=["POST_IF","FOR","WHILE","UNTIL","WHEN","BY","LOOP","TERMINATOR"],h=["ELSE","->","=>","TRY","FINALLY","THEN"],u=["TERMINATOR","CATCH","FINALLY","ELSE","OUTDENT","LEADING_WHEN"],c=["TERMINATOR","INDENT","OUTDENT"]});