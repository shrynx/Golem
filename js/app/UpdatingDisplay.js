define(function(require,exports,module){var __filename=module.uri||"",__dirname=__filename.substring(0,__filename.lastIndexOf("/")+1),CommandMode,Mode,React,UpdatingDisplay,ace,compiler,cx,hyper,isStrictSuffix,jsDump,renderMany,_div,_pre,_ref,_span,_table,_tbody,_td,_th,_tr,__slice=[].slice;_ref=hyper=require("hyper"),_div=_ref._div,_pre=_ref._pre,_span=_ref._span,_table=_ref._table,_tbody=_ref._tbody,_tr=_ref._tr,_th=_ref._th,_td=_ref._td,React=require("React"),cx=React.addons.classSet,ace=require("./AceEditor"),jsDump=require("vendor/jsDump"),CommandMode=require("./CommandMode"),Mode=require("compilers/teascript/mode").Mode,compiler=require("compilers/teascript/compiler"),isStrictSuffix=function(e,t){return e.length<t.length&&-1!==t.indexOf(e,t.length-e.length)},renderMany=function(e){var t;return function(){var n,r,i;for(i=[],n=0,r=e.length;r>n;n++)t=e[n],i.push(React.renderComponentToStaticMarkup(t));return i}().join("")},module.exports=hyper(UpdatingDisplay=function(){function UpdatingDisplay(){}return UpdatingDisplay.prototype.getInitialState=function(){return{source:this.props.value.source}},UpdatingDisplay.prototype.parseValue=function(){},UpdatingDisplay.prototype.runSource=function(compiled){var debugLog,doLog,error,result,savedStacks;return compiled!==this.compiled?(this.compiled=compiled,this.cached=function(){try{return doLog=!0,savedStacks={},debugLog=function(e){return function(){var t,n,r,i,o,s,a,u,l,c,d,p;return i=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],r=t.slice(0,t.length/2),p=t.slice(t.length/2),n="debug-log-"+i,u=function(){var e;try{throw new Error("stack")}catch(t){return e=t,e.stack.split("\n").slice(5).join("")}},d=function(){var t;return _tr({dangerouslySetInnerHTML:{__html:renderMany(function(){var e,n,r;for(r=[],e=0,n=p.length;n>e;e++)t=p[e],r.push(_td({style:{"padding-right":"5px"}},this.displayValue(t)));return r}.call(e))}})},s=function(){var t;return _table({id:n,"data-source-id":e.timesExecuted},_tbody({},_tr(function(){var e,n,i;for(i=[],e=0,n=r.length;n>e;e++)t=r[e],i.push(_td({style:{"padding-right":"15px","white-space":"pre-wrap"},dangerouslySetInnerHTML:{__html:t}}));return i}()),d()))},doLog&&(o=u(),(l=window.document.getElementById(n))?(l.getAttribute("data-source-id")!==""+e.timesExecuted||!isStrictSuffix(savedStacks[i],o)&&!isStrictSuffix(o,savedStacks[i])?l.parentNode.innerHTML=React.renderComponentToString(s()):(e.timesLogged++,a=window.document.createElement("div"),React.renderComponent(_table(_tbody(d())),a),l.firstChild.lastChild.innerHTML!==a.firstChild.firstChild.firstChild.innerHTML&&l.firstChild.appendChild(a.firstChild.firstChild.firstChild)),e.timesLogged>1e3&&(doLog=!1)):window.log(s())),savedStacks[i]=o,c=p[p.length-1]}}(this),this.timesExecuted++,this.timesLogged=0,result=eval(compiled)}catch(_error){return error=_error,error.compiled=compiled,error}}.call(this)):this.cached},UpdatingDisplay.prototype.displayExecuted=function(e){return null==e?null:e instanceof Error?this.displayError(e):this.displayValue(e)},UpdatingDisplay.prototype.displayValue=function(e){var t,n;try{return _pre({style:{"float":"left"},dangerouslySetInnerHTML:{__html:function(){if(null==e)return"Nothing";if("function"==typeof e)return e.toString();if(t=jsDump.parse(e),t.html)return t.html;try{return compiler.syntaxedExpHtml(t)}catch(n){return t}}()}})}catch(r){return n=r,this.displayError(n)}},UpdatingDisplay.prototype.displayError=function(e){var t;return t=""+(e instanceof SyntaxError?e.compiled:this.formatStackTrace(e.stack)),_div({className:"messageDisplay",style:{color:"#880000"}},_div({dangerouslySetInnerHTML:{__html:""+e}}),/^\s*$/.test(t)?void 0:_div(t))},UpdatingDisplay.prototype.formatStackTrace=function(e){var t;return null==e&&(e=""),t=compiler.builtInLibraryNumLines,e.replace(/\n?(?:(\w+)[^>\n]+>[^>\n]+:(\d+:\d+)|.*)(?=\n)/g,function(e,n,r){return parseInt(r)>t?""+n+" "+r+"\n":""}).replace(/\n (?=\n)/g,"")},UpdatingDisplay.prototype.handleCommand=function(e){return function(t){return function(){return t.props.onCommand(e,t.editor)}}(this)},UpdatingDisplay.prototype.componentDidMount=function(){var e,t,n,r,i,o,s;r=new CommandMode(this.props.key,this.props.completers),this.editor=n=ace.edit(this.refs.ace.getDOMNode(),r,"ace/theme/tea"),n.setFontSize(13),n.renderer.setScrollMargin(2,2),n.setHighlightActiveLine(!1),n.session.setTabSize(2),n.setShowPrintMargin(!1),n.renderer.setShowGutter(!1),r.registerWithWorker(this.props.worker),r.setContent(this.props.value.source,null,this.props.value.moduleName),r.updateAst(this.props.value.ast),t=r.worker,n.session.on("change",function(e){return function(){return e.setState({source:n.getValue()})}}(this)),this.timesExecuted=0,t.on("ok",function(e){return function(t){var i,o,s,a,u,l,c;return c=t.data,a=c.result,l=c.type,i=c.commandSource,u=n.getValue(),u!==i||(a.ast&&a.ast.splice(1,a.ast.length-3),r.updateAst(a.ast,a.errors),a.malformed)?void 0:(o=a.errors?(s=a.errors[0],new Error(s.message||s)):e.runSource(a.js),e.setState({executed:o}))}}(this)),t.on("error",function(e){return function(t){var n;return n=t.data.text,e.setState({executed:new Error(n)})}}(this)),o=r.commands,s=[];for(i in o)e=o[i],e.indirect&&s.push(e.exec=this.handleCommand(i));return s},UpdatingDisplay.prototype.componentWillReceiveProps=function(e){var t;return t=e.updatedSource,t!==this.props.updatedSource?this.editor.session.getMode().updateWorker(!0):void 0},UpdatingDisplay.prototype.componentDidUpdate=function(){return this.editor.resize()},UpdatingDisplay.prototype.componentWillUnmount=function(){var e;return null!=(e=this.editor.completer)&&e.detach(),this.editor.session.getMode().detach(),this.editor.destroy()},UpdatingDisplay.prototype.render=function(){return _div({},_div({ref:"ace",style:{width:"100%",height:22}}),_div({style:{height:0,margin:"0 4px",overflow:"hidden"}},this.state.source),_div({style:{padding:"0 4px"}},this.displayExecuted(this.state.executed)))},UpdatingDisplay}())});