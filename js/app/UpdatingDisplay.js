define(function(require,exports,module){var __filename=module.uri||"",__dirname=__filename.substring(0,__filename.lastIndexOf("/")+1),CommandMode,Mode,React,UpdatingDisplay,ace,compiler,cx,hyper,isStrictSuffix,jsDump,renderMany,_div,_pre,_ref,_span,_table,_tbody,_td,_th,_tr,__slice=[].slice;_ref=hyper=require("hyper"),_div=_ref._div,_pre=_ref._pre,_span=_ref._span,_table=_ref._table,_tbody=_ref._tbody,_tr=_ref._tr,_th=_ref._th,_td=_ref._td,React=require("React"),cx=React.addons.classSet,ace=require("./AceEditor"),jsDump=require("vendor/jsDump"),CommandMode=require("./CommandMode"),Mode=require("compilers/teascript/mode").Mode,compiler=require("compilers/teascript/compiler"),isStrictSuffix=function(e,t){return e.length<t.length&&-1!==t.indexOf(e,t.length-e.length)},renderMany=function(e){var t;return function(){var r,o,n;for(n=[],r=0,o=e.length;o>r;r++)t=e[r],n.push(React.renderComponentToStaticMarkup(t));return n}().join("")},module.exports=hyper(UpdatingDisplay=function(){function UpdatingDisplay(){}return UpdatingDisplay.prototype.getInitialState=function(){return{source:this.props.value.source}},UpdatingDisplay.prototype.parseValue=function(){},UpdatingDisplay.prototype.runSource=function(compiled){var debugLog,doLog,error,result,savedStacks;return compiled!==this.compiled?(this.compiled=compiled,this.cached=function(){try{return doLog=!0,savedStacks={},debugLog=function(e){return function(){var t,r,o,n,i,s,a,u,d,c,l,p;return n=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],o=t.slice(0,t.length/2),p=t.slice(t.length/2),r="debug-log-"+n,u=function(){var e;try{throw new Error("stack")}catch(t){return e=t,e.stack.split("\n").slice(5).join("")}},l=function(){var t;return _tr({dangerouslySetInnerHTML:{__html:renderMany(function(){var e,r,o;for(o=[],e=0,r=p.length;r>e;e++)t=p[e],o.push(_td({style:{"padding-right":"5px"}},this.displayValue(t)));return o}.call(e))}})},s=function(){var t;return _table({id:r,"data-source-id":e.timesExecuted},_tbody({},_tr(function(){var e,r,n;for(n=[],e=0,r=o.length;r>e;e++)t=o[e],n.push(_td({style:{"padding-right":"15px","white-space":"pre-wrap"},dangerouslySetInnerHTML:{__html:t}}));return n}()),l()))},doLog&&(i=u(),(d=window.document.getElementById(r))?(d.getAttribute("data-source-id")!==""+e.timesExecuted||!isStrictSuffix(savedStacks[n],i)&&!isStrictSuffix(i,savedStacks[n])?d.parentNode.innerHTML=React.renderComponentToString(s()):(e.timesLogged++,a=window.document.createElement("div"),React.renderComponent(_table(_tbody(l())),a),d.firstChild.lastChild.innerHTML!==a.firstChild.firstChild.firstChild.innerHTML&&d.firstChild.appendChild(a.firstChild.firstChild.firstChild)),e.timesLogged>1e3&&(doLog=!1)):window.log(s())),savedStacks[n]=i,c=p[p.length-1]}}(this),this.timesExecuted++,this.timesLogged=0,result=eval(compiled)}catch(_error){return error=_error,error.compiled=compiled,error}}.call(this)):this.cached},UpdatingDisplay.prototype.displayExecuted=function(e){return null==e?null:e instanceof Error?this.displayError(e):this.displayValue(e)},UpdatingDisplay.prototype.displayValue=function(e){var t,r;try{return _pre({style:{"float":"left"},dangerouslySetInnerHTML:{__html:function(){if(null==e)return"Nothing";if("function"==typeof e)return e.toString();if(t=jsDump.parse(e),t.html)return t.html;try{return compiler.syntaxedExpHtml(t)}catch(r){return t}}()}})}catch(o){return r=o,this.displayError(r)}},UpdatingDisplay.prototype.displayError=function(e){var t;return t=""+(e instanceof SyntaxError?e.compiled:this.formatStackTrace(e.stack)),_div({className:"messageDisplay",style:{color:"#880000"}},_div({dangerouslySetInnerHTML:{__html:""+e}}),/^\s*$/.test(t)?void 0:_div(t))},UpdatingDisplay.prototype.formatStackTrace=function(e){var t;return null==e&&(e=""),t=compiler.builtInLibraryNumLines,e.replace(/\n?(?:(\w+)[^>\n]+>[^>\n]+:(\d+:\d+)|.*)(?=\n)/g,function(e,r,o){return parseInt(o)>t?""+r+" "+o+"\n":""}).replace(/\n (?=\n)/g,"")},UpdatingDisplay.prototype.handleCommand=function(e){return function(t){return function(){return t.props.onCommand(e,t.editor)}}(this)},UpdatingDisplay.prototype.componentDidMount=function(){var e,t,r,o,n,i,s;o=new CommandMode(this.props.key,this.props.completers),this.editor=r=ace.edit(this.refs.ace.getDOMNode(),o,"ace/theme/tea"),r.setFontSize(13),r.renderer.setScrollMargin(2,2),r.setHighlightActiveLine(!1),r.session.setTabSize(2),r.setShowPrintMargin(!1),r.renderer.setShowGutter(!1),o.registerWithWorker(this.props.worker),o.setContent(this.props.value.source,null,this.props.value.moduleName),o.updateAst(this.props.value.ast),t=o.worker,r.session.on("change",function(e){return function(){return e.setState({source:r.getValue()})}}(this)),this.timesExecuted=0,t.on("ok",function(e){return function(t){var n,i,s,a,u,d,c;return c=t.data,a=c.result,d=c.type,n=c.commandSource,u=r.getValue(),u!==n||(a.ast&&a.ast.splice(1,a.ast.length-3),o.updateAst(a.ast,a.errors),a.malformed)?void 0:(i=a.errors?(s=a.errors[0],new Error(s.message||s)):e.runSource(a.js),e.setState({executed:i}))}}(this)),t.on("error",function(e){return function(t){var r;return r=t.data.text,e.setState({executed:new Error(r)})}}(this)),i=o.commands,s=[];for(n in i)e=i[n],e.indirect&&s.push(e.exec=this.handleCommand(n));return s},UpdatingDisplay.prototype.componentWillReceiveProps=function(e){var t;return t=e.updatedSource,t!==this.props.updatedSource?this.editor.session.getMode().updateWorker(!0):void 0},UpdatingDisplay.prototype.componentDidUpdate=function(){return this.editor.resize()},UpdatingDisplay.prototype.componentWillUnmount=function(){var e;return null!=(e=this.editor.completer)&&e.detach(),this.editor.session.getMode().detach(),this.editor.destroy()},UpdatingDisplay.prototype.render=function(){return _div({},_div({ref:"ace",style:{width:"100%",height:22}}),_div({style:{height:0,margin:"0 4px",overflow:"hidden"}},this.state.source),_div({style:{padding:"0 4px"}},this.displayExecuted(this.state.executed)))},UpdatingDisplay}())});